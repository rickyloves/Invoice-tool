<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>发票组合计算器 (V9.6 单单恢复+备份版)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* 样式 V9.6 */
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#eef7f2;font-family:Arial,Helvetica,sans-serif;color:#333;padding-bottom:108px}
    .container{max-width:480px;margin:18px auto;padding:0 10px}
    h2{text-align:center;margin-bottom:12px;font-size:1.6rem}
    .card{background:#fff;border-radius:6px;padding:16px;margin-bottom:12px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:bold}
    input,textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
    textarea{resize:vertical}
    .flex{display:flex;gap:8px;margin-top:6px}
    .flex input{flex:1}
    .flex span{line-height:32px}
    .two-cols{display:flex;gap:8px;margin-top:6px}
    .two-cols>div{flex:1}
    #header-history{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .hdr-item{background:#ececec;color:#555;border-radius:4px;display:flex;align-items:center;overflow:hidden}
    .hdr-item button.txt{background:transparent;border:none;padding:6px 10px;font-size:.9rem;color:#333;cursor:pointer}
    .hdr-item button.del{background:transparent;border:none;padding:6px;font-size:1rem;color:#999;cursor:pointer;transition:color .2s}
    .hdr-item button.del:hover{color:#666}
    #result-output,#debug-log{white-space:pre-wrap;max-height:240px;overflow:auto;font-family:monospace;font-size:.9rem}
    .accordion{border-radius:6px;overflow:hidden;margin-top:12px}
    .accordion-header{background:#fff;padding:12px 16px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
    .accordion-header .arrow{width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-top:7px solid #666;transition:transform .28s ease}
    .accordion-header.open .arrow{transform:rotate(180deg)}
    .accordion-content{display:none;background:#fff;padding:12px 16px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    
    /* V9.6 优化删除记录样式 */
    .record-item{border-top:1px solid #eee;padding:10px 0}
    .record-item:first-child{border-top:none}
    .record-title{font-weight:bold;font-size:0.95rem;margin-bottom:6px;color:#444;}
    .single-order-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px dashed #f5f5f5;font-size:0.9rem;}
    .single-order-row:last-child{border-bottom:none;}
    .btn-recover-one{font-size:0.8rem;padding:2px 8px;background:#17a2b8;color:white;border:none;border-radius:3px;cursor:pointer;}
    .btn-recover-one:hover{background:#138496;}
    .btn-recover-batch{display:block;margin:10px auto 0;padding:6px 12px;background:#6c757d;color:#fff;border:none;border-radius:4px;font-size:.9rem;cursor:pointer}
    
    /* V9.3/V9.4 搜索修正区 */
    .edit-row{display:flex;gap:6px;align-items:center;margin-top:8px;padding-bottom:8px;border-bottom:1px dashed #eee}
    .edit-row span{font-size:0.85rem;color:#666;flex:1}
    .edit-row input{width:80px;margin-top:0;text-align:center}
    .edit-row button{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;font-size:0.85rem}
    .btn-update{background:#28a745;color:#fff}
    .search-box{display:flex;gap:8px}
    .search-box button{width:80px;background:#17a2b8;color:white;border:none;border-radius:4px;cursor:pointer}

    .footer{position:fixed;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -2px 5px rgba(0,0,0,.05);padding:8px;display:flex;gap:8px;flex-wrap:wrap}
    .footer button{flex:1 1 calc(50% - 4px);padding:12px 0;font-size:1rem;border:none;border-radius:4px;cursor:pointer}
    .primary{background:#007bff;color:#fff}.secondary{background:#6c757d;color:#fff}.danger{background:#dc3545;color:#fff}
    .hidden{display:none}
    .tip{font-size:.9rem;color:#666;margin-top:6px}
    .highlight-label { color: #d63384; }
    
    /* V9.5 Loading Overlay */
    #loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);z-index:999;display:none;flex-direction:column;align-items:center;justify-content:center;}
    .spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:10px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="font-weight:bold;color:#333">正在尝试不同组合...</div>
    <div id="retry-count" style="color:#666;margin-top:5px">0 / 2000</div>
  </div>

  <div class="container">
    <h2>发票组合计算器 (V9.6)</h2>

    <div class="card">
      <label>目标开票金额</label>
      <input id="target-input" type="number" placeholder="如 20000">

      <label class="highlight-label">订单号范围筛选</label>
      <div class="flex">
        <input id="filter-order-min" type="text" placeholder="起始号 (如 290)">
        <span>—</span>
        <input id="filter-order-max" type="text" placeholder="结束号 (不填则不限)">
      </div>

      <label>单张发票金额范围</label>
      <div class="flex">
        <input id="min-single" type="number" placeholder="下限">
        <span>—</span>
        <input id="max-single" type="number" placeholder="上限">
      </div>

      <div class="two-cols">
        <div>
          <label>相同金额发票张数上限</label>
          <input id="max-same-count" type="number" placeholder="留空表示不限">
        </div>
        <div>
          <label>发票张数</label>
          <input id="invoice-count" type="number" placeholder="留空表示不限">
        </div>
      </div>

      <div class="two-cols" style="margin-top:6px">
        <div>
          <input type="checkbox" id="allow-approx">
          <label for="allow-approx">允许误差最小匹配</label>
        </div>
        <div>
          <input type="checkbox" id="only-higher">
          <label for="only-higher">匹配金额不得小于目标</label>
        </div>
      </div>

      <label>公司抬头</label>
      <textarea id="company-header" rows="2" placeholder="行1：公司名称
行2：统一社会信用代码"></textarea>
      <div id="header-history"></div>

      <div class="tip" style="color:#007bff">★ 数据源：265条 (可下方修正)。</div>
    </div>

    <div class="accordion">
      <div class="accordion-header" id="edit-acc-header">
        <span>库存修正 / 查询</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="edit-acc-content">
        <div class="search-box">
            <input id="search-order-input" type="text" placeholder="输入完整或部分订单号">
            <button id="btn-search-order">查询</button>
        </div>
        <div id="edit-result-area" style="margin-top:10px"></div>
        <div class="tip">提示：修改金额后会自动保存，计算时将使用新金额。</div>
      </div>
    </div>

    <div class="card">
      <h3>导出结果</h3>
      <div id="result-output"></div>
    </div>

    <div class="accordion">
      <div class="accordion-header" id="del-acc-header">
        <span>删除记录（最近20条）</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="record-list" style="display:none;"></div>
    </div>

    <div class="accordion">
      <div class="accordion-header" id="debug-acc-header">
        <span>调试日志（点击展开/收起）</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="debug-acc-content" style="display:none;">
        <div id="debug-log"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button id="combine-btn" class="primary">一键组合</button>
    <button id="copy-btn" class="secondary">复制结果</button>
    <button id="reset-btn" class="secondary">重置库存</button>
    
    <button id="backup-btn" class="secondary" style="background:#17a2b8;color:#fff">备份数据</button>
    <button id="restore-btn" class="secondary" style="background:#ffc107;color:#333">恢复数据</button>
    <input type="file" id="restore-input" style="display:none" accept=".json">
    
    <button id="confirm-delete-btn" class="danger hidden">确认删除</button>
  </div>

<script>
/* ====== 数据源 V9.3 ====== */
const DATA_SOURCE = [
{"order":"29844392230","amount":1240},{"order":"29787668582","amount":670},{"order":"29779855398","amount":670},{"order":"29758217446","amount":208},{"order":"29758125414","amount":670},{"order":"29754938534","amount":189},{"order":"29754882022","amount":740},{"order":"29723444262","amount":1180},{"order":"29722926822","amount":189},{"order":"29722933926","amount":590},{"order":"29722673446","amount":1770},{"order":"29722664486","amount":189},{"order":"29722661094","amount":490},{"order":"29722722854","amount":590},{"order":"29722357286","amount":490},{"order":"29722422118","amount":490},{"order":"29722343654","amount":490},{"order":"29721815398","amount":590},{"order":"29722199910","amount":1470},{"order":"29722121958","amount":590},{"order":"29722146598","amount":189},{"order":"29722006502","amount":590},{"order":"29722009638","amount":189},{"order":"29664786726","amount":1345},{"order":"29657407974","amount":960},{"order":"29657049766","amount":960},{"order":"29657089702","amount":1000},{"order":"29657268006","amount":1000},{"order":"29613864934","amount":990},{"order":"29613779238","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29579148454","amount":990},{"order":"29578714086","amount":159},{"order":"29578467110","amount":990},{"order":"29578353894","amount":990},{"order":"29578045286","amount":1020},{"order":"29578181862","amount":1020},{"order":"29578056486","amount":2040},{"order":"29577984294","amount":2040},{"order":"29521294630","amount":1050},{"order":"29521271270","amount":1050},{"order":"29511656678","amount":1050},{"order":"29511582438","amount":1050},{"order":"29503897638","amount":1020},{"order":"29503915686","amount":1020},{"order":"29503479526","amount":1050},{"order":"29503480294","amount":1050},{"order":"29499944230","amount":1000},{"order":"29499944294","amount":1000},{"order":"29498897254","amount":1050},{"order":"29498897702","amount":1050},{"order":"29490917478","amount":1050},{"order":"29490868710","amount":1050},{"order":"29488269734","amount":1000},{"order":"29488521894","amount":1000},{"order":"29488129766","amount":1000},{"order":"29488684390","amount":1000