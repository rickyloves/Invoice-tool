<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>发票组合计算器 (V9.3 库存修正版)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* 样式 V9.3 */
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#eef7f2;font-family:Arial,Helvetica,sans-serif;color:#333;padding-bottom:108px}
    .container{max-width:480px;margin:18px auto;padding:0 10px}
    h2{text-align:center;margin-bottom:12px;font-size:1.6rem}
    .card{background:#fff;border-radius:6px;padding:16px;margin-bottom:12px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:bold}
    input,textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
    textarea{resize:vertical}
    .flex{display:flex;gap:8px;margin-top:6px}
    .flex input{flex:1}
    .flex span{line-height:32px}
    .two-cols{display:flex;gap:8px;margin-top:6px}
    .two-cols>div{flex:1}
    #header-history{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .hdr-item{background:#ececec;color:#555;border-radius:4px;display:flex;align-items:center;overflow:hidden}
    .hdr-item button.txt{background:transparent;border:none;padding:6px 10px;font-size:.9rem;color:#333;cursor:pointer}
    .hdr-item button.del{background:transparent;border:none;padding:6px;font-size:1rem;color:#999;cursor:pointer;transition:color .2s}
    .hdr-item button.del:hover{color:#666}
    #result-output,#debug-log{white-space:pre-wrap;max-height:240px;overflow:auto;font-family:monospace;font-size:.9rem}
    .accordion{border-radius:6px;overflow:hidden;margin-top:12px}
    .accordion-header{background:#fff;padding:12px 16px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
    .accordion-header .arrow{width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-top:7px solid #666;transition:transform .28s ease}
    .accordion-header.open .arrow{transform:rotate(180deg)}
    .accordion-content{display:none;background:#fff;padding:12px 16px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .record-item{border-top:1px solid #eee;padding:10px 0}
    .record-item:first-child{border-top:none}
    .record-item .orders{margin-top:8px;line-height:1.45}
    .record-item .btn-recover{display:block;margin:10px auto 0;padding:6px 12px;background:#6c757d;color:#fff;border:none;border-radius:4px;font-size:.9rem;cursor:pointer}
    
    /* V9.3 新增样式：搜索修正区 */
    .edit-row{display:flex;gap:6px;align-items:center;margin-top:8px;padding-bottom:8px;border-bottom:1px dashed #eee}
    .edit-row span{font-size:0.85rem;color:#666;flex:1}
    .edit-row input{width:80px;margin-top:0;text-align:center}
    .edit-row button{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;font-size:0.85rem}
    .btn-update{background:#28a745;color:#fff}
    .search-box{display:flex;gap:8px}
    .search-box button{width:80px;background:#17a2b8;color:white;border:none;border-radius:4px;cursor:pointer}

    .footer{position:fixed;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -2px 5px rgba(0,0,0,.05);padding:8px;display:flex;gap:8px;flex-wrap:wrap}
    .footer button{flex:1 1 calc(50% - 4px);padding:12px 0;font-size:1rem;border:none;border-radius:4px;cursor:pointer}
    .primary{background:#007bff;color:#fff}.secondary{background:#6c757d;color:#fff}.danger{background:#dc3545;color:#fff}
    .hidden{display:none}
    .tip{font-size:.9rem;color:#666;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h2>发票组合计算器 (V9.3)</h2>

    <div class="card">
      <label>目标开票金额</label>
      <input id="target-input" type="number" placeholder="如 20000">

      <label>单张发票金额范围</label>
      <div class="flex">
        <input id="min-single" type="number" placeholder="下限">
        <span>—</span>
        <input id="max-single" type="number" placeholder="上限">
      </div>

      <div class="two-cols">
        <div>
          <label>相同金额发票张数上限</label>
          <input id="max-same-count" type="number" placeholder="留空表示不限">
        </div>
        <div>
          <label>发票张数</label>
          <input id="invoice-count" type="number" placeholder="留空表示不限">
        </div>
      </div>

      <div class="two-cols" style="margin-top:6px">
        <div>
          <input type="checkbox" id="allow-approx">
          <label for="allow-approx">允许误差最小匹配</label>
        </div>
        <div>
          <input type="checkbox" id="only-higher">
          <label for="only-higher">匹配金额不得小于目标</label>
        </div>
      </div>

      <label>公司抬头</label>
      <textarea id="company-header" rows="2" placeholder="行1：公司名称
行2：统一社会信用代码"></textarea>
      <div id="header-history"></div>

      <div class="tip" style="color:#007bff">★ 数据源：265条 (可下方修正)。</div>
    </div>

    <div class="accordion">
      <div class="accordion-header" id="edit-acc-header">
        <span>库存修正 / 查询</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="edit-acc-content">
        <div class="search-box">
            <input id="search-order-input" type="text" placeholder="输入完整或部分订单号">
            <button id="btn-search-order">查询</button>
        </div>
        <div id="edit-result-area" style="margin-top:10px"></div>
        <div class="tip">提示：修改金额后会自动保存，计算时将使用新金额。</div>
      </div>
    </div>

    <div class="card">
      <h3>导出结果</h3>
      <div id="result-output"></div>
    </div>

    <div class="accordion">
      <div class="accordion-header" id="del-acc-header">
        <span>删除记录（最近20条）</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="record-list" style="display:none;"></div>
    </div>

    <div class="accordion">
      <div class="accordion-header" id="debug-acc-header">
        <span>调试日志（点击展开/收起）</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="debug-acc-content" style="display:none;">
        <div id="debug-log"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button id="combine-btn" class="primary">一键组合</button>
    <button id="copy-btn" class="secondary">复制结果</button>
    <button id="reset-btn" class="secondary">重置库存</button>
    <button id="confirm-delete-btn" class="danger hidden">确认删除</button>
  </div>

<script>
/* ====== 2024-11-25 完整数据 V9.3 (265条) ====== */
const DATA_SOURCE = [
{"order":"29844392230","amount":1240},{"order":"29787668582","amount":670},{"order":"29779855398","amount":670},{"order":"29758217446","amount":208},{"order":"29758125414","amount":670},{"order":"29754938534","amount":189},{"order":"29754882022","amount":740},{"order":"29723444262","amount":1180},{"order":"29722926822","amount":189},{"order":"29722933926","amount":590},{"order":"29722673446","amount":1770},{"order":"29722664486","amount":189},{"order":"29722661094","amount":490},{"order":"29722722854","amount":590},{"order":"29722357286","amount":490},{"order":"29722422118","amount":490},{"order":"29722343654","amount":490},{"order":"29721815398","amount":590},{"order":"29722199910","amount":1470},{"order":"29722121958","amount":590},{"order":"29722146598","amount":189},{"order":"29722006502","amount":590},{"order":"29722009638","amount":189},{"order":"29664786726","amount":1345},{"order":"29657407974","amount":960},{"order":"29657049766","amount":960},{"order":"29657089702","amount":1000},{"order":"29657268006","amount":1000},{"order":"29613864934","amount":990},{"order":"29613779238","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29579148454","amount":990},{"order":"29578714086","amount":159},{"order":"29578467110","amount":990},{"order":"29578353894","amount":990},{"order":"29578045286","amount":1020},{"order":"29578181862","amount":1020},{"order":"29578056486","amount":2040},{"order":"29577984294","amount":2040},{"order":"29521294630","amount":1050},{"order":"29521271270","amount":1050},{"order":"29511656678","amount":1050},{"order":"29511582438","amount":1050},{"order":"29503897638","amount":1020},{"order":"29503915686","amount":1020},{"order":"29503479526","amount":1050},{"order":"29503480294","amount":1050},{"order":"29499944230","amount":1000},{"order":"29499944294","amount":1000},{"order":"29498897254","amount":1050},{"order":"29498897702","amount":1050},{"order":"29490917478","amount":1050},{"order":"29490868710","amount":1050},{"order":"29488269734","amount":1000},{"order":"29488521894","amount":1000},{"order":"29488129766","amount":1000},{"order":"29488684390","amount":1000},{"order":"29487024294","amount":1050},{"order":"29487043942","amount":1050},{"order":"29487038182","amount":1050},{"order":"29487022822","amount":1050},{"order":"29475651046","amount":1050},{"order":"29475572838","amount":1050},{"order":"29472654886","amount":1050},{"order":"29472546022","amount":1050},{"order":"29376457638","amount":1050},{"order":"29376618790","amount":1050},{"order":"29372705702","amount":1050},{"order":"29372746918","amount":1050},{"order":"29324981734","amount":1050},{"order":"29325052966","amount":1050},{"order":"29324565990","amount":1050},{"order":"29324610982","amount":1050},{"order":"29324176358","amount":1050},{"order":"29324204646","amount":1050},{"order":"29322723302","amount":2100},{"order":"29321161126","amount":2100},{"order":"29321200934","amount":2100},{"order":"29320710246","amount":3150},{"order":"29320689446","amount":5250},{"order":"29320422758","amount":1050},{"order":"29320229798","amount":2100},{"order":"29320212582","amount":2100},{"order":"29320259878","amount":5250},{"order":"29320237030","amount":1050},{"order":"29320311014","amount":5250},{"order":"29313551014","amount":2100},{"order":"29313528934","amount":5250},{"order":"29313330278","amount":5250},{"order":"29309418406","amount":5250},{"order":"29250020006","amount":1050},{"order":"29250000166","amount":4200},{"order":"29250087014","amount":5250},{"order":"29250059750","amount":1050},{"order":"29250018150","amount":3150},{"order":"29249976614","amount":4200},{"order":"29249801830","amount":5250},{"order":"29240651238","amount":5250},{"order":"29203828262","amount":3150},{"order":"29195981798","amount":1050},{"order":"29195932070","amount":1050},{"order":"29195980582","amount":1050},{"order":"29195981286","amount":1050},{"order":"29195705894","amount":2100},{"order":"29195678438","amount":2100},{"order":"29195667686","amount":1050},{"order":"29195761510","amount":1050},{"order":"29195733798","amount":1050},{"order":"29195721766","amount":1050},{"order":"29195728550","amount":1050},{"order":"29195559462","amount":1050},{"order":"29195615078","amount":1050},{"order":"29195500582","amount":1050},{"order":"29192155750","amount":2100},{"order":"29192157670","amount":2100},{"order":"29187893094","amount":1050},{"order":"29187884390","amount":1050},{"order":"29187450918","amount":1050},{"order":"29187453030","amount":1050},{"order":"29187413158","amount":1050},{"order":"29187431462","amount":1050},{"order":"29186986278","amount":1050},{"order":"29186994662","amount":1050},{"order":"29186704166","amount":1050},{"order":"29186524646","amount":5250},{"order":"29186336294","amount":3150},{"order":"29186354726","amount":3150},{"order":"29175575462","amount":1020},{"order":"29175636582","amount":1020},{"order":"29156266534","amount":3060},{"order":"29156274086","amount":3060},{"order":"29156045670","amount":1020},{"order":"29156085414","amount":1020},{"order":"29155498086","amount":2040},{"order":"29155589734","amount":2040},{"order":"29106863398","amount":229},{"order":"29085307238","amount":169},{"order":"29084841830","amount":845},{"order":"29041101926","amount":398},{"order":"29039226086","amount":995},{"order":"29039009830","amount":1393},{"order":"29038401830","amount":796},{"order":"29018396326","amount":796},{"order":"29008596838","amount":199},{"order":"29007762982","amount":5150},{"order":"29003278694","amount":209},{"order":"28964953318","amount":1010},{"order":"28965073958","amount":1010},{"order":"28957860134","amount":1010},{"order":"28957880934","amount":1010},{"order":"28945928166","amount":1010},{"order":"28945876774","amount":1010},{"order":"28941124646","amount":1010},{"order":"28941227494","amount":1010},{"order":"28940363750","amount":1010},{"order":"28940510694","amount":1010},{"order":"28940484134","amount":1010},{"order":"28940484582","amount":1010},{"order":"28940030374","amount":1010},{"order":"28939941734","amount":1010},{"order":"28939594534","amount":1010},{"order":"28939622054","amount":1010},{"order":"28934446950","amount":1010},{"order":"28934754086","amount":980},{"order":"28922217446","amount":1010},{"order":"28917119142","amount":1010},{"order":"28917546406","amount":1010},{"order":"28916902502","amount":980},{"order":"28916850278","amount":980},{"order":"28915493094","amount":1010},{"order":"28915621542","amount":1010},{"order":"28902560550","amount":980},{"order":"28902630502","amount":980},{"order":"28901966694","amount":980},{"order":"28901861734","amount":980},{"order":"28900709542","amount":980},{"order":"28900711270","amount":980},{"order":"28609574630","amount":1030},{"order":"28510891814","amount":450},{"order":"28510953062","amount":360},{"order":"28192753958","amount":970},{"order":"28192706790","amount":970},{"order":"28191451238","amount":1940},{"order":"28185388710","amount":3000},{"order":"28016488742","amount":990},{"order":"27989546470","amount":990},{"order":"27989054310","amount":990},{"order":"27989195302","amount":960},{"order":"27498602150","amount":2970},{"order":"27498949542","amount":2880},{"order":"27499031206","amount":4950},{"order":"27499056870","amount":4800},{"order":"27497737574","amount":4950},{"order":"27494179878","amount":990},{"order":"27493949158","amount":960},{"order":"27494024038","amount":990},{"order":"27493984614","amount":960},{"order":"27494228902","amount":990},{"order":"27494335398","amount":960},{"order":"27494049126","amount":3840},{"order":"27494017958","amount":3840},{"order":"27493623782","amount":960},{"order":"27493594598","amount":960},{"order":"27493467814","amount":960},{"order":"27493556646","amount":960},{"order":"27493456870","amount":1920},{"order":"27492798118","amount":960},{"order":"27493151398","amount":960},{"order":"27492642150","amount":960},{"order":"27473140390","amount":990},{"order":"27472936230","amount":2970},{"order":"27472964774","amount":990},{"order":"27462561958","amount":2970},{"order":"27460235046","amount":990},{"order":"27460354918","amount":960},{"order":"27460337702","amount":2970},{"order":"27309417766","amount":1020},{"order":"27309158246","amount":1020},{"order":"27309054566","amount":1020},{"order":"27307771942","amount":1020},{"order":"27306899942","amount":2040},{"order":"27266581350","amount":3060},{"order":"27249636582","amount":5100},{"order":"27239209510","amount":5150},{"order":"27232240614","amount":2020},{"order":"27231980262","amount":5050},{"order":"27232397414","amount":5050},{"order":"27231626022","amount":4120},{"order":"27224537510","amount":1010},{"order":"27136238886","amount":1050},{"order":"27136276518","amount":1050},{"order":"27134868582","amount":1050},{"order":"27134126886","amount":3150},{"order":"26790683558","amount":1040},{"order":"26693575462","amount":5050},{"order":"26388819174","amount":4160},{"order":"26373999526","amount":5200},{"order":"26211479910","amount":2060},{"order":"29722082086","amount":1770},{"order":"29722808550","amount":810},{"order":"29722753254","amount":567},{"order":"29722016806","amount":189},{"order":"29722015270","amount":490},{"order":"29721364070","amount":1770},{"order":"29721258726","amount":567},{"order":"29046424358","amount":597}
];

/* ====== 配置区 V9.3 ====== */
let inventory=[];
let deleteRecords=JSON.parse(localStorage.getItem('deleteRecords_V9_2')||'[]');
const saveDeleteRecords=()=>localStorage.setItem('deleteRecords_V9_2',JSON.stringify(deleteRecords));
const saveInventory    =()=>localStorage.setItem('invoiceInventory_V9_2',JSON.stringify(inventory));
const loadHeaderHistory=()=>JSON.parse(localStorage.getItem('headerHistory_V9_2')||'[]');
const saveHeaderHistory=h=>{
  if(!h) return; const arr=loadHeaderHistory().filter(x=>x!==h);
  arr.unshift(h); if(arr.length>10) arr.pop();
  localStorage.setItem('headerHistory_V9_2',JSON.stringify(arr));
};
function log(msg){ const el=document.getElementById('debug-log'); const t=new Date().toLocaleTimeString(); el.textContent+=`[${t}] ${msg}\n`; }

function normalize(raw){
  const map=new Map();
  (raw||[]).forEach(o=>{
    const order=String(o.order); const amount=Math.round(Number(o.amount)||0);
    const k=order+'|'+amount;
    if(!map.has(k)) map.set(k,{order,amount});
  });
  return Array.from(map.values());
}
const makeKey=o=>o.order+'|'+o.amount;

/* ====== 加载逻辑 ====== */
async function loadInventory(forceReset=false){
  if(!forceReset){
    const local=JSON.parse(localStorage.getItem('invoiceInventory_V9_2')||'null');
    if(local){ inventory=normalize(local); log(`从缓存读取：${inventory.length} 条`); return; }
  }
  log(`读取内置源数据：共 ${DATA_SOURCE.length} 条记录...`);
  inventory=normalize(DATA_SOURCE); 
  saveInventory();
  if(forceReset){ 
    deleteRecords=[]; saveDeleteRecords(); 
    log(`已重置。去重后有效库存：${inventory.length} 条`); 
  }
}

/* ====== UI 渲染 ====== */
function renderHeaderHistory(){
  const div=document.getElementById('header-history'); div.innerHTML='';
  loadHeaderHistory().forEach((h,i)=>{
    const wrap=document.createElement('div'); wrap.className='hdr-item';
    const txt=document.createElement('button'); txt.className='txt'; txt.textContent=h;
    txt.onclick=()=>document.getElementById('company-header').value=h;
    const del=document.createElement('button'); del.className='del'; del.textContent='✕';
    del.onclick=()=>{ const a=loadHeaderHistory(); a.splice(i,1); localStorage.setItem('headerHistory_V9_2',JSON.stringify(a)); renderHeaderHistory(); };
    wrap.appendChild(txt); wrap.appendChild(del); div.appendChild(wrap);
  });
}
function renderDeleteRecords(){
  const list=document.getElementById('record-list'); list.innerHTML='';
  deleteRecords.slice(0,20).forEach((batch,i)=>{
    const total=batch.reduce((s,inv)=>s+inv.sum,0);
    const item=document.createElement('div'); item.className='record-item';
    let html=`批次 ${i+1}：共 ${batch.length} 张发票，合计 ${total} 元<br><div class="orders">`;
    batch.forEach(inv=>inv.orders.forEach(o=>{ html+=`订单号：${o.order}，金额：${o.amount}元<br>`; }));
    html+='</div>'; item.innerHTML=html;
    const btn=document.createElement('button'); btn.className='record-item btn-recover'; btn.textContent='恢复';
    btn.onclick=()=>{
      const rec=deleteRecords.splice(i,1)[0];
      rec.forEach(inv=>inv.orders.forEach(o=>{ if(!inventory.find(x=>makeKey(x)===makeKey(o))) inventory.push(o); }));
      inventory=normalize(inventory); saveDeleteRecords(); saveInventory(); renderDeleteRecords(); log(`已恢复批次 ${i+1}`);
    };
    item.appendChild(btn); list.appendChild(item);
  });
}
function bindAccordion(h,c){ h.addEventListener('click',()=>{ const open=c.style.display==='block'; c.style.display=open?'none':'block'; h.classList.toggle('open',!open); }); }

/* ====== V9.3 新增逻辑：搜索与修正 ====== */
function renderEditSearch(){
  const input = document.getElementById('search-order-input');
  const btn = document.getElementById('btn-search-order');
  const area = document.getElementById('edit-result-area');

  btn.onclick = () => {
    const val = input.value.trim();
    if(!val) return alert('请输入订单号');
    area.innerHTML = '';
    
    // 模糊搜索
    const found = inventory.filter(o => o.order.includes(val));
    if(found.length === 0){
      area.innerHTML = '<div style="color:red;padding:10px 0;">未找到相关订单。</div>';
      return;
    }

    found.forEach(item => {
      const div = document.createElement('div');
      div.className = 'edit-row';
      div.innerHTML = `
        <span>订单: ${item.order} <br> 原额: ${item.amount}</span>
        <input type="number" value="${item.amount}">
        <button class="btn-update">保存</button>
      `;
      
      const newValInput = div.querySelector('input');
      const saveBtn = div.querySelector('.btn-update');
      
      saveBtn.onclick = () => {
        const newAmt = Math.round(Number(newValInput.value));
        if(!newAmt || newAmt <= 0) return alert('金额必须大于0');
        
        // 更新逻辑：
        // 1. 在inventory中找到原对象（通过makeKey，因为可能存在order相同amount不同的旧脏数据）
        const oldKey = makeKey(item);
        const idx = inventory.findIndex(x => makeKey(x) === oldKey);
        
        if(idx === -1) {
          alert('数据已过期或不存在，请重新搜索');
          return;
        }

        // 2. 修改
        inventory[idx].amount = newAmt;
        
        // 3. 重新normalize去重（防止改完后和现有的重复）并保存
        inventory = normalize(inventory);
        saveInventory();
        
        alert(`订单 ${item.order} 金额已更新为 ${newAmt}`);
        log(`修正数据：订单 ${item.order} 从 ${item.amount} -> ${newAmt}`);
        
        // 刷新搜索结果显示
        btn.click(); 
      };
      
      area.appendChild(div);
    });
  };
}

/* ====== 核心算法 (保持 V9.2 逻辑) ====== */
function selectOrdersByDP(target, maxSingle, allowApprox, onlyHigher){
  const pool = (maxSingle>0)? inventory.filter(o=>o.amount<=maxSingle) : inventory.slice();
  if(pool.length===0) return null;

  const hi = allowApprox ? (target+500) : target;
  const dp = Array(hi+1).fill(null); dp[0]={cnt:0,picks:[]};
  for(let i=0;i<pool.length;i++){
    const a=pool[i].amount|0;
    for(let s=hi;s>=a;s--){
      if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
        dp[s]={cnt:dp[s-a].cnt+1,picks:dp[s-a].picks.concat(i)};
      }
    }
  }
  if(dp[target]) return {sum:target, orders: dp[target].picks.map(i=>pool[i])};

  if(!allowApprox) return null;
  for(let d=1; d<=500; d++){
    const sUp = target + d;
    const sDn = target - d;
    if(onlyHigher){
      if(sUp<=hi && dp[sUp]) return {sum:sUp, orders: dp[sUp].picks.map(i=>pool[i])};
    }else{
      if(sDn>=0 && dp[sDn]) return {sum:sDn, orders: dp[sDn].picks.map(i=>pool[i])};
      if(sUp<=hi && dp[sUp]) return {sum:sUp, orders: dp[sUp].picks.map(i=>pool[i])};
    }
  }
  return null;
}

function splitWithCapBacktrack(selectedOrders, minS, maxS, maxSame){
  if(!(minS>0) && !(maxS>0)){
    const total=selectedOrders.reduce((a,o)=>a+o.amount,0);
    return [{sum:total, orders:selectedOrders.slice()}];
  }
  const lo=(minS>0)?minS:1;
  const hi=(maxS>0)?maxS:selectedOrders.reduce((a,o)=>a+o.amount,0);

  let avail=selectedOrders.slice();
  const capMap=new Map();
  const keyOf=o=>o.order+'|'+o.amount;

  function bestSubsetInRange(avail, lo, hi){
    const maxSum=Math.min(hi, avail.reduce((a,o)=>a+o.amount,0));
    const dp=Array(maxSum+1).fill(null); dp[0]={cnt:0,picks:[]};
    for(let i=0;i<avail.length;i++){
      const a=avail[i].amount|0;
      for(let s=maxSum;s>=a;s--){
        if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
          dp[s]={cnt:dp[s-a].cnt+1,picks:dp[s-a].picks.concat(i)};
        }
      }
    }
    for(let s=maxSum; s>=Math.max(1,lo); s--){
      if(dp[s] && s>=lo && s<=hi) return {sum:s, picks:dp[s].picks};
    }
    return null;
  }

  function genCandidates(av,limit=8){
    const cands=[];
    const step=Math.max(1, Math.floor((hi-lo)/24));
    for(let s=Math.min(hi,av.reduce((a,o)=>a+o.amount,0)); s>=lo; s-=step){
      if(isFinite(maxSame) && (capMap.get(s)||0) >= maxSame) continue;
      const probe=bestSubsetInRange(av, s, s);
      if(probe){ cands.push(probe); if(cands.length>=limit) break; }
    }
    if(cands.length===0){
      const p=bestSubsetInRange(av, lo, hi);
      if(p && (!isFinite(maxSame) || (capMap.get(p.sum)||0) < maxSame)) cands.push(p);
    }
    return cands;
  }

  const memo=new Set();
  function sig(av){
    const hist=new Map(); av.forEach(o=>hist.set(o.amount,(hist.get(o.amount)||0)+1));
    const hm=Array.from(hist.entries()).sort((a,b)=>a[0]-b[0]).map(([k,v])=>k+':'+v).join(',');
    const cm=Array.from(capMap.entries()).sort((a,b)=>a[0]-b[0]).map(([k,v])=>k+':'+v).join(',');
    return hm+'|'+cm;
  }

  function dfs(av){
    if(av.length===0) return [];
    const signature=sig(av); if(memo.has(signature)) return null;

    const cands=genCandidates(av,8);
    for(const cand of cands){
      if(!cand) continue;
      const pick=cand.picks.map(i=>av[i]);
      const used=new Set(pick.map(keyOf));
      const rest=av.filter(o=>!used.has(keyOf(o)));

      capMap.set(cand.sum,(capMap.get(cand.sum)||0)+1);
      const sub=dfs(rest);
      if(sub){ return [{sum:cand.sum,orders:pick}, ...sub]; }
      capMap.set(cand.sum,capMap.get(cand.sum)-1);
      if(capMap.get(cand.sum)===0) capMap.delete(cand.sum);
    }
    memo.add(signature);
    return null;
  }

  return dfs(avail);
}

function splitFixedCount(selectedOrders, minS, maxS, k){
  const lo=(minS>0)?minS:1;
  const total=selectedOrders.reduce((a,o)=>a+o.amount,0);
  const hi=(maxS>0)?maxS:total;

  const base=selectedOrders.map((o,idx)=>({...o,__uid:'u'+idx}));

  function bestSubsetInRangeEx(avail, lo, hi){
    const maxSum=Math.min(hi, avail.reduce((a,o)=>a+o.amount,0));
    const dp=Array(maxSum+1).fill(null); dp[0]={cnt:0,picks:[]};
    for(let i=0;i<avail.length;i++){
      const a=avail[i].amount|0;
      for(let s=maxSum;s>=a;s--){
        if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
          dp[s]={cnt:dp[s-a].cnt+1,picks:dp[s-a].picks.concat(i)};
        }
      }
    }
    for(let s=maxSum; s>=Math.max(1,lo); s--){
      if(dp[s] && s>=lo && s<=hi) return {sum:s,picks:dp[s].picks};
    }
    return null;
  }

  const memo=new Map();
  function sig(remT,k,avail){
    const hist=new Map(); avail.forEach(x=>hist.set(x.amount,(hist.get(x.amount)||0)+1));
    const hm=[...hist.entries()].sort((a,b)=>a[0]-b[0]).map(([v,c])=>v+':'+c).join(',');
    return remT+'|'+k+'|'+hm;
  }

  function dfs(remT,k,avail){
    const key=sig(remT,k,avail);
    if(memo.has(key)) return memo.get(key);

    if(k===1){
      const dp=Array(remT+1).fill(null); dp[0]=[];
      for(let i=0;i<avail.length;i++){
        const a=avail[i].amount|0;
        for(let s=remT;s>=a;s--){
          if(dp[s-a]!=null && dp[s]==null){ dp[s]=dp[s-a].concat(i); }
        }
      }
      if(!dp[remT]){ memo.set(key,null); return null; }
      const pick=dp[remT].map(i=>avail[i]);
      const sum=remT;
      if(sum<lo || sum>hi){ memo.set(key,null); return null; }
      const res=[{sum,orders:pick.map(x=>({order:x.order,amount:x.amount}))}];
      memo.set(key,res); return res;
    }

    const upper=Math.min(hi, remT-(k-1)*lo);
    const lower=Math.max(lo, remT-(k-1)*hi);
    if(lower>upper){ memo.set(key,null); return null; }

    const first=bestSubsetInRangeEx(avail, lower, upper);
    if(!first){ memo.set(key,null); return null; }

    const trySubs=[];
    for(let s=first.sum; s>=lower && trySubs.length<8; s--){
      const t=bestSubsetInRangeEx(avail, s, s);
      if(t) trySubs.push(t);
    }
    for(const cand of trySubs){
      const pick=cand.picks.map(i=>avail[i]);
      const used=new Set(pick.map(x=>x.__uid));
      const rest=avail.filter(x=>!used.has(x.__uid));
      const sub=dfs(remT-cand.sum, k-1, rest);
      if(sub){ const res=[{sum:cand.sum,orders:pick.map(x=>({order:x.order,amount:x.amount}))}, ...sub]; memo.set(key,res); return res; }
    }
    memo.set(key,null); return null;
  }

  return dfs(total, k, base);
}

function computeInvoices(target, minS, maxS, maxSame, invoiceCount, allowApprox, onlyHigher){
  const pickRes = selectOrdersByDP(target, maxS||0, allowApprox, onlyHigher);
  if(!pickRes) return null;
  const selected = pickRes.orders;
  const totalSel = pickRes.sum;

  if(invoiceCount && invoiceCount>0){
    const fixed = splitFixedCount(selected, minS||0, maxS||0, invoiceCount);
    if(!fixed) return null;
    const sumFixed = fixed.reduce((a,inv)=>a+inv.sum,0);
    if(sumFixed!==totalSel) return null;
    return fixed;
  }else{
    const invs = splitWithCapBacktrack(selected, minS||0, maxS||0, isFinite(maxSame)?maxSame:Infinity);
    if(!invs) return null;
    const sumInvs = invs.reduce((a,inv)=>a+inv.sum,0);
    if(sumInvs!==totalSel) return null;
    return invs;
  }
}

/* ====== 入口绑定 ====== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadInventory();
  renderHeaderHistory();
  renderDeleteRecords();
  renderEditSearch(); // 初始化搜索模块

  const debugH=document.getElementById('debug-acc-header');
  const debugC=document.getElementById('debug-acc-content');
  const delH=document.getElementById('del-acc-header');
  const delC=document.getElementById('record-list');
  const editH=document.getElementById('edit-acc-header'); // 新增
  const editC=document.getElementById('edit-acc-content'); // 新增
  
  bindAccordion(debugH,debugC);
  bindAccordion(delH,delC);
  bindAccordion(editH,editC); // 新增绑定

  document.getElementById('reset-btn').onclick=async()=>{
    if(confirm('确定要重置并恢复初始数据吗？(删除记录将被清空，手动修改也将丢失)')){
      await loadInventory(true);
      renderDeleteRecords();
      alert('库存已重置。');
    }
  };

  let lastInv=null;

  document.getElementById('combine-btn').onclick=()=>{
    const outEl=document.getElementById('result-output');
    const logEl=document.getElementById('debug-log');
    outEl.textContent=''; logEl.textContent='';

    const tgt=+document.getElementById('target-input').value;
    if(!tgt) return alert('请输入目标金额');
    const minS=+document.getElementById('min-single').value||0;
    const maxS=+document.getElementById('max-single').value||0;
    if(minS && maxS && minS>maxS) return alert('下限不可大于上限');
    const msc=+document.getElementById('max-same-count').value||Infinity;
    const ic =+document.getElementById('invoice-count').value||0;
    const allowApprox=document.getElementById('allow-approx').checked;
    const onlyHigher=document.getElementById('only-higher').checked;
    const header=document.getElementById('company-header').value.trim();
    saveHeaderHistory(header); renderHeaderHistory();

    const baseTotal=inventory.reduce((a,o)=>a+o.amount,0);
    const poolTotal=(maxS>0)?inventory.filter(o=>o.amount<=maxS).reduce((a,o)=>a+o.amount,0):baseTotal;
    log(`开始：target=${tgt}, 范围=[${minS||'-'},${maxS||'-'}], sameCap=${isFinite(msc)?msc:'不限'}, 张数=${ic||'不限'}, 近似=${allowApprox}, 不小于=${onlyHigher}`);
    log(`库存总额=${baseTotal}；可用池总额（<=maxSingle）=${poolTotal}；订单数=${inventory.length}`);

    const invs = computeInvoices(tgt,minS,maxS,msc,ic,allowApprox,onlyHigher);
    if(!invs || !invs.length){
      outEl.textContent='无法组合出满足条件的金额';
      debugC.style.display='block'; debugH.classList.add('open');
      return;
    }

    const out=[];
    invs.forEach((inv,i)=>{
      out.push(`发票${i+1}：${inv.sum}元${inv.orders.length>1?'（相关订单合并）':''}`);
      inv.orders.forEach(o=> out.push(`订单号：${o.order}，金额：${o.amount}元`));
      out.push('');
    });
    if(header) out.push(header,'');
    out.push('不需要备注','568881753@qq.com');
    outEl.textContent = out.join('\n');

    lastInv=invs;
    document.getElementById('confirm-delete-btn').classList.remove('hidden');
  };

  document.getElementById('confirm-delete-btn').onclick=()=>{
    if(!lastInv) return;
    deleteRecords.unshift(lastInv);
    const removeSet=new Set(lastInv.flatMap(inv=>inv.orders.map(makeKey)));
    inventory=inventory.filter(o=>!removeSet.has(makeKey(o)));
    saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    delC.style.display='block'; delH.classList.add('open');
    document.getElementById('confirm-delete-btn').classList.add('hidden');
    log(`已确认删除；库存剩余 ${inventory.length} 条；删除批次数=${deleteRecords.length}`);
  };

  document.getElementById('copy-btn').onclick=()=>{
    navigator.clipboard.writeText(document.getElementById('result-output').textContent);
    alert('结果已复制');
  };
});
</script>
</body>
</html>
