<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å‘ç¥¨æ§åˆ¶å° V16.7 - Absolute Alignment</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    :root {
      --primary: #0071e3;
      --bg-gradient: linear-gradient(150deg, #f2f5f9 0%, #dbeafe 100%);
      --glass: rgba(255, 255, 255, 0.95);
      --glass-border: rgba(255, 255, 255, 0.6);
      --text-main: #1d1d1f;
      --text-sub: #6e6e73;
      --danger: #ff3b30;
      --success: #34c759;
      --blur: 40px;
    }

    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
    
    body {
      background: var(--bg-gradient); background-attachment: fixed;
      color: var(--text-main); font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      /* åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢å†…å®¹è¢«æ‚¬æµ®æ é®æŒ¡ */
      padding-bottom: 120px; 
      display: flex; flex-direction: column;
    }

    .main-wrapper { 
        width: 96%; max-width: 1650px; margin: 25px auto; 
        flex: 1; 
        position: relative; /* ä¸ºå­å…ƒç´ å®šä½åšå‡†å¤‡ */
    }
    
    .top-header { 
        margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-shrink: 0;
    }
    h1 { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; color: #1d1d1f; }
    .version-tag { font-size: 12px; font-weight: 500; color: #fff; background: var(--primary); padding: 4px 10px; border-radius: 12px;}

    /* === V16.7 æ ¸å¿ƒå¸ƒå±€ï¼šç»å¯¹å¯„ç”Ÿæ¶æ„ === */
    .layout-grid { 
      display: grid; 
      grid-template-columns: 340px 1fr 340px; 
      gap: 24px; 
      /* è®©æ¯ä¸€è¡Œéƒ½å…·å¤‡å®šä½ä¸Šä¸‹æ–‡ */
      position: relative; 
    }

    /* 1. ä¸­æ ï¼šæ™®é€šæ–‡æ¡£æµã€‚å®ƒå†³å®šäº†æ•´ä¸ª Grid çš„é«˜åº¦ */
    .col-center-wrapper {
        grid-column: 2; /* æ”¾åœ¨ä¸­é—´ */
        display: flex; flex-direction: column; gap: 20px;
    }

    /* 2. å·¦æ å®¹å™¨ï¼šå¼ºåˆ¶å ä½ï¼Œä½†å†…å®¹ç»å¯¹å®šä½ */
    .col-left-placeholder {
        grid-column: 1;
        position: relative; /* å…³é”®ï¼šä½œä¸ºç»å¯¹å®šä½å†…å®¹çš„çˆ¶çº§ */
    }
    /* å·¦æ å®é™…å†…å®¹ï¼šæ­»æ­»è´´åˆå®¹å™¨é«˜åº¦ */
    .col-left-content {
        position: absolute; 
        top: 0; bottom: 0; left: 0; right: 0;
        display: flex; flex-direction: column; gap: 20px;
    }

    /* 3. å³æ å®¹å™¨ï¼šåŒç† */
    .col-right-placeholder {
        grid-column: 3;
        position: relative;
    }
    .col-right-content {
        position: absolute; 
        top: 0; bottom: 0; left: 0; right: 0;
        display: flex; flex-direction: column; gap: 20px;
    }

    /* å“åº”å¼ï¼šå°å±æ¢å¤æ™®é€šæµ */
    @media (max-width: 1200px) { 
        .layout-grid { display: flex; flex-direction: column; }
        .col-left-placeholder, .col-right-placeholder { position: static; height: auto; }
        .col-left-content, .col-right-content { position: static; }
        .col-center-wrapper { order: -1; } /* ç»“æœä¼˜å…ˆæ˜¾ç¤º */
        #result-output { height: auto !important; min-height: 400px; }
    }

    .glass-card {
      background: var(--glass); backdrop-filter: blur(var(--blur)); -webkit-backdrop-filter: blur(var(--blur));
      border: 1px solid var(--glass-border); border-radius: 20px; padding: 24px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.03); 
      display: flex; flex-direction: column;
      transition: transform 0.2s;
    }
    
    /* === å¡ç‰‡é«˜åº¦ç­–ç•¥ === */
    .card-fixed { flex-shrink: 0; }

    /* ç»“æœåŒºï¼š580px æ­»é«˜ï¼Œå®ƒæ˜¯å…¨é¡µé¢çš„æ ‡å°º */
    .card-result-anchor {
        height: 580px; 
        flex-shrink: 0;
        display: flex; flex-direction: column;
    }

    /* è‡ªåŠ¨å¡«å……å¡ç‰‡ï¼šåœ¨ç»å¯¹å®šä½çš„åˆ—ä¸­ï¼Œå®ƒä»¬ä¼šåƒæ‰å‰©ä½™ç©ºé—´ */
    .card-fill { 
        flex: 1; 
        display: flex; flex-direction: column; 
        min-height: 0; 
        overflow: hidden; /* å¿…é¡»ï¼é˜²æ­¢æ’‘å¼€ç»å¯¹å®šä½å®¹å™¨ */
    }

    /* å†…éƒ¨æ»šåŠ¨åŒº */
    #result-output {
        font-family: "SF Mono", Menlo, Monaco, monospace; font-size: 14px; line-height: 1.7;
        background: rgba(255,255,255,0.7); padding: 25px; border-radius: 16px; 
        flex: 1; overflow-y: auto; 
        white-space: pre-wrap; border: 1px solid rgba(255,255,255,0.9); color: #333;
    }

    .inner-scroll-box {
        flex: 1; 
        overflow-y: auto; 
        padding-right: 5px;
        /* é˜²æ­¢æ»šåŠ¨åŒºåŸŸæ¶ˆå¤± */
        min-height: 100px; 
    }
    
    #result-output::-webkit-scrollbar, .inner-scroll-box::-webkit-scrollbar { width: 5px; }
    #result-output::-webkit-scrollbar-thumb, .inner-scroll-box::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }

    .card-title { font-size: 13px; font-weight: 700; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .card-title::after { content: ""; flex: 1; height: 1px; background: rgba(0,0,0,0.06); margin-left: 10px; }

    label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 8px; margin-top: 12px; }
    input, textarea {
      width: 100%; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px;
      padding: 12px; font-size: 14px; background: rgba(255,255,255,0.7); transition: all 0.2s;
    }
    input:focus, textarea:focus { background: #fff; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,113,227,0.15); }
    
    .textarea-header { resize: none; margin-bottom: 12px; height: 80px; flex-shrink: 0; }

    .flex-grid { display: flex; gap: 12px; margin-bottom: 8px; }
    .flex-grid > div { flex: 1; }

    .stat-row { display: flex; gap: 12px; margin-bottom: 0 !important; }
    .stat-box {
      flex: 1; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.5)); 
      padding: 15px; border-radius: 14px; text-align: center; border: 1px solid rgba(255,255,255,0.8);
    }
    .stat-box b { display: block; font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
    .stat-box span { font-size: 11px; color: var(--text-sub); font-weight: 600; }

    .record-item { background: rgba(255,255,255,0.6); border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.9); }
    .order-line {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 12px; margin-bottom: 5px; background: rgba(255,255,255,0.8);
      border-radius: 8px; font-size: 13px;
    }
    
    button { cursor: pointer; border: none; font-weight: 600; transition: all 0.2s; font-family: inherit; }
    button:active { transform: scale(0.97); }

    .btn-recover { background: var(--primary); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 11px; }
    .btn-batch { width: 100%; margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.04); color: var(--text-sub); border-radius: 8px; font-size: 12px; }
    .btn-batch:hover { background: rgba(0,0,0,0.07); color: #333; }

    .glass-footer {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: auto; min-width: 680px; max-width: 90%;
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
      padding: 12px 18px; border-radius: 24px; display: flex; gap: 12px; align-items: center; justify-content: space-between;
      box-shadow: 0 25px 60px rgba(0,0,0,0.15); z-index: 1000; border: 1px solid rgba(255,255,255,0.6);
    }
    .footer-left { display: flex; align-items: center; gap: 15px; padding-left: 10px; }
    .footer-right { display: flex; gap: 12px; }

    .footer-btn { 
        padding: 12px 22px; border-radius: 14px; font-size: 14px; white-space: nowrap;
        background: rgba(0,0,0,0.04); color: var(--text-main); display: flex; align-items: center; gap: 8px;
    }
    .footer-btn:hover { background: rgba(0,0,0,0.07); }
    
    .btn-compute { 
        background: #1d1d1f; color: white !important; padding: 12px 32px; font-weight: 600;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    .btn-compute:hover { background: var(--primary); transform: translateY(-1px); box-shadow: 0 10px 30px rgba(0, 113, 227, 0.35); }

    .btn-del-confirm { background: var(--danger); color: white !important; }
    .btn-del-confirm:hover { background: #d70015; }

    .status-pill { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; color: #86868b; }
    .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; }

    #toast {
        position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100px);
        background: rgba(29, 29, 31, 0.9); color: white; padding: 12px 28px; border-radius: 50px;
        backdrop-filter: blur(10px); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); 
        z-index: 3000; font-weight: 500; font-size: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    #toast.show { transform: translateX(-50%) translateY(0); }

    .history-chips { display: flex; flex-direction: column; gap: 8px; }
    .chip { 
        background: #fff; padding: 10px; border-radius: 10px; font-size: 12px; color: #555;
        border: 1px solid rgba(0,0,0,0.08); cursor: pointer; transition: all 0.2s; 
        display: flex; justify-content: space-between; align-items: flex-start;
    }
    .chip:hover { border-color: var(--primary); color: var(--primary); background: rgba(0,113,227,0.03); }

    #loading-overlay {
      position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 2000;
      display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px);
    }
    .spinner { width: 44px; height: 44px; border: 4px solid rgba(0,0,0,0.08); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s infinite linear; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div id="toast">æ“ä½œæˆåŠŸ</div>

<div id="loading-overlay">
  <div class="spinner"></div>
  <p style="margin-top:20px; font-weight:600; font-size:15px; color:#333;">æ­£åœ¨è¿›è¡Œæ™ºèƒ½ç»„åˆè®¡ç®—...</p>
  <p id="retry-count" style="font-family:monospace; color:var(--text-sub); margin-top:8px; font-size:13px;">åˆå§‹åŒ–ä¸­...</p>
</div>

<div class="main-wrapper">
  <div class="top-header">
    <h1>å‘ç¥¨æ™ºèƒ½è®¡ç®—æ§åˆ¶å°</h1>
    <span class="version-tag">V16.7 Absolute Align</span>
  </div>

  <div class="layout-grid">
    
    <div class="col-left-placeholder">
        <div class="col-left-content">
            <div class="glass-card card-fixed">
                <div class="card-title">âš™ï¸ å¼€ç¥¨éœ€æ±‚é…ç½®</div>
                <label style="margin-top:0;">ç›®æ ‡å¼€ç¥¨æ€»é¢</label>
                <input id="target-input" type="number" placeholder="è¾“å…¥é‡‘é¢..." style="font-size: 24px; font-weight: 700; color:var(--primary); padding: 14px; background:rgba(0,113,227,0.05); border:1px solid rgba(0,113,227,0.15);">
                
                <div class="flex-grid" style="margin-top:20px;">
                <div><label>èµ·å§‹è®¢å•</label><input id="filter-order-min" type="text" placeholder="å¦‚ 290"></div>
                <div><label>æˆªæ­¢è®¢å•</label><input id="filter-order-max" type="text"></div>
                </div>
                <div class="flex-grid">
                <div><label>å•ç¬”æœ€å°</label><input id="min-single" type="number"></div>
                <div><label>å•ç¬”æœ€å¤§</label><input id="max-single" type="number"></div>
                </div>
                <div class="flex-grid">
                <div><label>åŒé¢ä¸Šé™</label><input id="max-same-count" type="number" placeholder="ä¸é™"></div>
                <div><label>è¦æ±‚å¼ æ•°</label><input id="invoice-count" type="number" placeholder="ä¸é™"></div>
                </div>
                <div style="display:flex; gap:25px; margin-top:20px;">
                <label style="display:flex; align-items:center; cursor:pointer; text-transform:none; margin:0;"><input type="checkbox" id="allow-approx" style="width:16px; height:16px; margin-right:8px; accent-color:var(--primary);"> å…è®¸è¯¯å·®åŒ¹é…</label>
                <label style="display:flex; align-items:center; cursor:pointer; text-transform:none; margin:0;"><input type="checkbox" id="only-higher" style="width:16px; height:16px; margin-right:8px; accent-color:var(--primary);"> ç»“æœä¸å°äºç›®æ ‡</label>
                </div>
            </div>

            <div class="glass-card card-fill">
                <div class="card-title">ğŸ“‘ æŠ¬å¤´ç®¡ç† (è‡ªåŠ¨ä¿å­˜)</div>
                <textarea id="company-header" class="textarea-header" placeholder="åœ¨æ­¤ç²˜è´´æŠ¬å¤´åŠç¨å·ä¿¡æ¯..."></textarea>
                <div id="header-history" class="inner-scroll-box"></div>
            </div>
        </div>
    </div>

    <div class="col-center-wrapper">
      <div class="glass-card card-result-anchor">
        <div class="card-title">âœ¨ æ™ºèƒ½ç»„åˆç»“æœ</div>
        <div id="result-output">è¯·åœ¨å·¦ä¾§è®¾ç½®ç›®æ ‡é‡‘é¢ï¼Œç„¶åç‚¹å‡»åº•éƒ¨â€œæ‰§è¡Œæ™ºèƒ½è®¡ç®—â€æŒ‰é’®ã€‚</div>
      </div>

      <div class="glass-card card-fixed">
        <div class="card-title">ğŸ›  å¿«æ·è®¢å•ä¿®æ­£</div>
        <div class="flex-grid" style="margin-bottom:12px; gap:10px;">
            <input id="search-order-input" type="text" placeholder="è¾“å…¥è®¢å•å·..." style="padding:10px;">
            <button id="btn-search-order" style="width:70px; background:var(--primary); color:white; border-radius:12px; font-size:13px;">æŸ¥è¯¢</button>
        </div>
        <div id="edit-result-area"></div>
      </div>

      <div class="glass-card card-fixed">
        <div class="card-title">ğŸ“Š å®æ—¶åº“å­˜çŠ¶æ€</div>
        <div id="inventory-stats"></div>
      </div>
    </div>

    <div class="col-right-placeholder">
        <div class="col-right-content">
            <div class="glass-card card-fill">
                <div class="card-title">ğŸ—‘ å·²åˆ é™¤è®°å½• (å¯æ¢å¤)</div>
                <div id="record-list" class="inner-scroll-box"></div>
            </div>

            <div class="glass-card card-fixed">
                <div class="card-title">ğŸ“¦ æ•°æ®ç»´æŠ¤</div>
                <div class="flex-grid">
                <button id="backup-btn" class="footer-btn" style="flex:1; justify-content:center; background:rgba(0,0,0,0.03); font-size:13px;">ğŸ“¤ å¯¼å‡º</button>
                <button id="restore-btn" class="footer-btn" style="flex:1; justify-content:center; background:rgba(0,0,0,0.03); font-size:13px;">ğŸ“¥ æ¢å¤</button>
                </div>
                <button id="reset-btn" class="footer-btn" style="width:100%; margin-top:10px; padding:10px; justify-content:center; color:var(--danger); border:1px dashed rgba(255,59,48,0.2); background:none; font-size:12px;">ğŸ”„ é‡ç½®ç³»ç»Ÿ</button>
                <input type="file" id="restore-input" style="display:none" accept=".json">
            </div>
        </div>
    </div>

  </div>
</div>

<div class="glass-footer">
  <div class="footer-left">
    <div class="status-pill"><div class="dot"></div> Ready</div>
  </div>
  <div class="footer-right">
    <button id="copy-btn" class="footer-btn">ğŸ“‹ å¤åˆ¶æ–¹æ¡ˆ</button>
    <button id="confirm-delete-btn" class="footer-btn hidden btn-del-confirm">ğŸ—‘ ç¡®è®¤åˆ é™¤</button>
    <button id="combine-btn" class="footer-btn btn-compute">âœ¨ æ‰§è¡Œæ™ºèƒ½è®¡ç®—</button>
  </div>
</div>

<script>
/* ====== æ ¸å¿ƒæ•°æ®ä¸é…ç½® ====== */
const DATA_SOURCE = [{"order":"29844392230","amount":1240},{"order":"29787668582","amount":670},{"order":"29779855398","amount":670},{"order":"29758217446","amount":208},{"order":"29758125414","amount":670},{"order":"29754938534","amount":189},{"order":"29754882022","amount":740},{"order":"29723444262","amount":1180},{"order":"29722082086","amount":1945},{"order":"29722808550","amount":972},{"order":"29722926822","amount":189},{"order":"29722933926","amount":590},{"order":"29722753254","amount":656},{"order":"29722673446","amount":1770},{"order":"29722664486","amount":189},{"order":"29722661094","amount":490},{"order":"29722722854","amount":590},{"order":"29722357286","amount":490},{"order":"29722422118","amount":490},{"order":"29722343654","amount":490},{"order":"29721815398","amount":590},{"order":"29722199910","amount":1470},{"order":"29722121958","amount":590},{"order":"29722146598","amount":189},{"order":"29722016806","amount":278},{"order":"29722015270","amount":590},{"order":"29722006502","amount":590},{"order":"29722009638","amount":189},{"order":"29721258726","amount":567},{"order":"29721364070","amount":1895},{"order":"29664786726","amount":1345},{"order":"29657407974","amount":960},{"order":"29657049766","amount":960},{"order":"29657089702","amount":1000},{"order":"29657268006","amount":1000},{"order":"29613864934","amount":990},{"order":"29613779238","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29579148454","amount":990},{"order":"29578714086","amount":159},{"order":"29578467110","amount":990},{"order":"29578353894","amount":990},{"order":"29578045286","amount":1020},{"order":"29578181862","amount":1020},{"order":"29578056486","amount":2040},{"order":"29577984294","amount":2040},{"order":"29521294630","amount":1050},{"order":"29521271270","amount":1050},{"order":"29511656678","amount":1050},{"order":"29511582438","amount":1050},{"order":"29503897638","amount":1020},{"order":"29503915686","amount":1020},{"order":"29503479526","amount":1050},{"order":"29503480294","amount":1050},{"order":"29499944230","amount":1000},{"order":"29499944294","amount":1000},{"order":"29498897254","amount":1050},{"order":"29498897702","amount":1050},{"order":"29490917478","amount":1050},{"order":"29490868710","amount":1050},{"order":"29488269734","amount":1000},{"order":"29488521894","amount":1000},{"order":"29488129766","amount":1000},{"order":"29488684390","amount":1000},{"order":"29487024294","amount":1050},{"order":"29487043942","amount":1050},{"order":"29487038182","amount":1050},{"order":"29487022822","amount":1050},{"order":"29475651046","amount":1050},{"order":"29475572838","amount":1050},{"order":"29472654886","amount":1050},{"order":"29472546022","amount":1050},{"order":"29376457638","amount":1050},{"order":"29376618790","amount":1050},{"order":"29372705702","amount":1050},{"order":"29372746918","amount":1050},{"order":"29324981734","amount":1050},{"order":"29325052966","amount":1050},{"order":"29324565990","amount":1050},{"order":"29324610982","amount":1050},{"order":"29324176358","amount":1050},{"order":"29324204646","amount":1050},{"order":"29322718182","amount":2100},{"order":"29322723302","amount":2100},{"order":"29321161126","amount":2100},{"order":"29321200934","amount":2100},{"order":"29320710246","amount":3150},{"order":"29320689446","amount":5250},{"order":"29320422758","amount":1050},{"order":"29320229798","amount":2100},{"order":"29320212582","amount":2100},{"order":"29320259878","amount":5250},{"order":"29320237030","amount":1050},{"order":"29320311014","amount":5250},{"order":"29313551014","amount":2100},{"order":"29313528934","amount":5250},{"order":"29313330278","amount":5250},{"order":"29309418406","amount":5250},{"order":"29250020006","amount":1050},{"order":"29250000166","amount":4200},{"order":"29250087014","amount":5250},{"order":"29250059750","amount":1050},{"order":"29250018150","amount":3150},{"order":"29249976614","amount":4200},{"order":"29249801830","amount":5250},{"order":"29240651238","amount":5250},{"order":"29203828262","amount":3150},{"order":"29195981798","amount":1050},{"order":"29195932070","amount":1050},{"order":"29195980582","amount":1050},{"order":"29195981286","amount":1050},{"order":"29195705894","amount":2100},{"order":"29195678438","amount":2100},{"order":"29195667686","amount":1050},{"order":"29195761510","amount":1050},{"order":"29195733798","amount":1050},{"order":"29195721766","amount":1050},{"order":"29195728550","amount":1050},{"order":"29195559462","amount":1050},{"order":"29195615078","amount":1050},{"order":"29195500582","amount":1050},{"order":"29192155750","amount":2100},{"order":"29192157670","amount":2100},{"order":"29187893094","amount":1050},{"order":"29187884390","amount":1050},{"order":"29187450918","amount":1050},{"order":"29187453030","amount":1050},{"order":"29187413158","amount":1050},{"order":"29187431462","amount":1050},{"order":"29186986278","amount":1050},{"order":"29186994662","amount":1050},{"order":"29186704166","amount":1050},{"order":"29186524646","amount":5250},{"order":"29186336294","amount":3150},{"order":"29186354726","amount":3150},{"order":"29175575462","amount":1020},{"order":"29175636582","amount":1020},{"order":"29156266534","amount":3060},{"order":"29156274086","amount":3060},{"order":"29156045670","amount":1020},{"order":"29156085414","amount":1020},{"order":"29155498086","amount":2040},{"order":"29155589734","amount":2040},{"order":"29106863398","amount":229},{"order":"29085307238","amount":169},{"order":"29084841830","amount":845},{"order":"29046598438","amount":398},{"order":"29046424358","amount":597},{"order":"29041101926","amount":398},{"order":"29039226086","amount":995},{"order":"29039009830","amount":1393},{"order":"29038401830","amount":796},{"order":"29018396326","amount":796},{"order":"29008596838","amount":199},{"order":"29007762982","amount":5150},{"order":"29003278694","amount":209},{"order":"28964953318","amount":1010},{"order":"28965073958","amount":1010},{"order":"28957860134","amount":1010},{"order":"28957880934","amount":1010},{"order":"28945928166","amount":1010},{"order":"28945876774","amount":1010},{"order":"28941124646","amount":1010},{"order":"28941227494","amount":1010},{"order":"28940363750","amount":1010},{"order":"28940510694","amount":1010},{"order":"28940484134","amount":1010},{"order":"28940484582","amount":1010},{"order":"28940030374","amount":1010},{"order":"28940030374","amount":1010},{"order":"28939941734","amount":1010},{"order":"28939594534","amount":1010},{"order":"28939622054","amount":1010},{"order":"28934446950","amount":1010},{"order":"28934754086","amount":980},{"order":"28922217446","amount":1010},{"order":"28917119142","amount":1010},{"order":"28917546406","amount":1010},{"order":"28916902502","amount":980},{"order":"28916850278","amount":980},{"order":"28915493094","amount":1010},{"order":"28915621542","amount":1010},{"order":"28902560550","amount":980},{"order":"28902630502","amount":980},{"order":"28901966694","amount":980},{"order":"28901861734","amount":980},{"order":"28900709542","amount":980},{"order":"28900711270","amount":980},{"order":"28609574630","amount":1030},{"order":"28510891814","amount":450},{"order":"28510953062","amount":360},{"order":"28192753958","amount":970},{"order":"28192706790","amount":970},{"order":"28191451238","amount":1940},{"order":"28185388710","amount":3000},{"order":"28016488742","amount":990},{"order":"27989546470","amount":990},{"order":"27989054310","amount":990},{"order":"27989195302","amount":960},{"order":"27498602150","amount":2970},{"order":"27498949542","amount":2880},{"order":"27499031206","amount":4950},{"order":"27499056870","amount":4800},{"order":"27497737574","amount":4950},{"order":"27494179878","amount":990},{"order":"27493949158","amount":960},{"order":"27494024038","amount":990},{"order":"27493984614","amount":960},{"order":"27494228902","amount":990},{"order":"27494335398","amount":960},{"order":"27494049126","amount":3840},{"order":"27494017958","amount":3840},{"order":"27493623782","amount":960},{"order":"27493594598","amount":960},{"order":"27493467814","amount":960},{"order":"27493556646","amount":960},{"order":"27493456870","amount":1920},{"order":"27492798118","amount":960},{"order":"27493151398","amount":960},{"order":"27492642150","amount":960},{"order":"27472629286","amount":960},{"order":"27473140390","amount":990},{"order":"27472936230","amount":2970},{"order":"27472964774","amount":990},{"order":"27462561958","amount":2970},{"order":"27460235046","amount":990},{"order":"27460354918","amount":960},{"order":"27460337702","amount":2970},{"order":"27309417766","amount":1020},{"order":"27309158246","amount":1020},{"order":"27309054566","amount":1020},{"order":"27307771942","amount":1020},{"order":"27306899942","amount":2040},{"order":"27266581350","amount":3060},{"order":"27249636582","amount":5100},{"order":"27239209510","amount":5150},{"order":"27232575782","amount":4120},{"order":"27232240614","amount":2020},{"order":"27231980262","amount":5050},{"order":"27232397414","amount":5050},{"order":"27231769062","amount":3480},{"order":"27231626022","amount":4120},{"order":"27224537510","amount":1010},{"order":"27136238886","amount":1050},{"order":"27136276518","amount":1050},{"order":"27134868582","amount":1050},{"order":"27134126886","amount":3150},{"order":"26790683558","amount":1040},{"order":"26693575462","amount":5050},{"order":"26388819174","amount":4160},{"order":"26373999526","amount":5200},{"order":"26211479910","amount":2060}];

let inventory = [];
let deleteRecords = JSON.parse(localStorage.getItem('deleteRecords_V9_2') || '[]');

const saveDeleteRecords = () => localStorage.setItem('deleteRecords_V9_2', JSON.stringify(deleteRecords));
const saveInventory = () => {
    localStorage.setItem('invoiceInventory_V9_2', JSON.stringify(inventory));
    renderStats();
};

const loadHeaderHistory = () => JSON.parse(localStorage.getItem('headerHistory_V9_2') || '[]');
const saveHeaderHistory = h => {
  if(!h) return; 
  let arr = loadHeaderHistory().filter(x => x !== h);
  arr.unshift(h); // æ— æ•°é‡é™åˆ¶
  localStorage.setItem('headerHistory_V9_2', JSON.stringify(arr));
};

function normalize(raw) {
  const map = new Map();
  (raw || []).forEach(o => {
    const order = String(o.order); const amount = Math.round(Number(o.amount) || 0);
    const k = order + '|' + amount;
    if (!map.has(k)) map.set(k, { order, amount });
  });
  return Array.from(map.values());
}
const makeKey = o => o.order + '|' + o.amount;

function shuffleArray(array) {
  let currentIndex = array.length, randomIndex;
  while (currentIndex != 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
  }
  return array;
}

async function loadInventory(forceReset = false) {
  if (!forceReset) {
    const local = JSON.parse(localStorage.getItem('invoiceInventory_V9_2') || 'null');
    if (local && local.length > 0) { 
        inventory = normalize(local); 
        renderStats(); 
        return; 
    }
  }
  inventory = normalize(DATA_SOURCE); 
  saveInventory();
  if (forceReset) { 
    deleteRecords = []; 
    saveDeleteRecords(); 
    showToast('æ•°æ®å·²å®Œå…¨é‡ç½®');
  }
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

function renderStats() {
    const el = document.getElementById('inventory-stats');
    if (!el) return;
    if (!inventory || inventory.length === 0) { el.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">æš‚æ— åº“å­˜</div>'; return; }
    const total = inventory.reduce((a, b) => a + b.amount, 0);
    const count = inventory.length;
    const amounts = inventory.map(x => x.amount);
    const minA = Math.min(...amounts) || 0;
    const maxA = Math.max(...amounts) || 0;
    
    el.innerHTML = `
        <div class="stat-row">
            <div class="stat-box"><b>${total.toLocaleString()}</b><span>åº“å­˜æ€»é¢</span></div>
            <div class="stat-box"><b>${count}</b><span>å¯ç”¨å•æ•°</span></div>
            <div class="stat-box"><b>${minA}</b><span>æœ€å°å•å¼ </span></div>
            <div class="stat-box"><b>${maxA}</b><span>æœ€å¤§å•å¼ </span></div>
        </div>
    `;
}

function renderHeaderHistory() {
  const div = document.getElementById('header-history'); if(!div) return; div.innerHTML = '';
  loadHeaderHistory().forEach((h, i) => {
    const chip = document.createElement('div'); chip.className = 'chip';
    // å…è®¸æ˜¾ç¤ºå®Œæ•´å¤šè¡Œæ–‡æœ¬
    chip.innerHTML = `<span style="white-space:pre-wrap; line-height:1.3; flex:1;">${h}</span><span style="margin-left:10px; color:#ccc; font-size:14px;">âœ•</span>`;
    chip.onclick = () => document.getElementById('company-header').value = h;
    chip.querySelector('span:last-child').onclick = (e) => { 
        e.stopPropagation(); 
        const arr = loadHeaderHistory(); arr.splice(i, 1);
        localStorage.setItem('headerHistory_V9_2', JSON.stringify(arr)); 
        renderHeaderHistory(); 
    };
    div.appendChild(chip);
  });
}

function renderDeleteRecords() {
  const list = document.getElementById('record-list'); list.innerHTML = '';
  if (deleteRecords.length === 0) { list.innerHTML = '<div style="color:#999; text-align:center; padding:30px; font-size:13px;">( æš‚æ— åˆ é™¤è®°å½• )</div>'; }
  else {
      deleteRecords.slice(0, 20).forEach((batch, batchIdx) => {
        const total = batch.reduce((s, inv) => s + inv.sum, 0);
        const item = document.createElement('div'); item.className = 'record-item';
        let html = `<div style="display:flex; justify-content:space-between; margin-bottom:12px; padding-bottom:8px; border-bottom:1px dashed rgba(0,0,0,0.1);"><b style="font-size:14px; color:#333;">æ‰¹æ¬¡ ${batchIdx + 1}</b> <span style="font-weight:800; color:var(--primary); font-size:15px;">${total.toLocaleString()} å…ƒ</span></div>`;
        batch.forEach((inv, invIdx) => {
            inv.orders.forEach((o, orderIdx) => {
               html += `<div class="order-line"><span><span style="color:#666; margin-right:5px;">${o.order}</span> <b style="color:#333;">${o.amount} å…ƒ</b></span><button class="btn-recover" onclick="recoverSingleOrder(${batchIdx}, ${invIdx}, ${orderIdx})">æ¢å¤</button></div>`;
            });
        });
        html += `<button class="btn-batch" onclick="recoverBatch(${batchIdx})">â†º æ’¤å›æ•´æ‰¹åˆ é™¤</button>`;
        item.innerHTML = html; list.appendChild(item);
      });
  }
}

/* ====== æ ¸å¿ƒé€»è¾‘ V15.1 (Fail-Fast + Merge) ====== */
function selectOrdersByDP(target, maxSingle, allowApprox, onlyHigher, minOrderStr, maxOrderStr, usePool) {
  let pool = usePool.slice();
  if (minOrderStr) pool = pool.filter(o => o.order >= minOrderStr);
  if (maxOrderStr) pool = pool.filter(o => o.order <= maxOrderStr);
  if (maxSingle > 0) pool = pool.filter(o => o.amount <= maxSingle);
  if (pool.length === 0) return null;
  const hi = allowApprox ? (target + 500) : target;
  const dp = Array(hi + 1).fill(null); dp[0] = { cnt: 0, picks: [] };
  for (let i = 0; i < pool.length; i++) {
    const a = pool[i].amount | 0;
    for (let s = hi; s >= a; s--) {
      if (dp[s - a] && (!dp[s] || dp[s - a].cnt + 1 < dp[s].cnt)) {
        dp[s] = { cnt: dp[s - a].cnt + 1, picks: dp[s - a].picks.concat(i) };
      }
    }
  }
  if (dp[target]) return { sum: target, orders: dp[target].picks.map(i => pool[i]) };
  if (!allowApprox) return null;
  for (let d = 1; d <= 500; d++) {
    const sUp = target + d; const sDn = target - d;
    if (onlyHigher) { if (sUp <= hi && dp[sUp]) return { sum: sUp, orders: dp[sUp].picks.map(i => pool[i]) }; }
    else {
      if (sDn >= 0 && dp[sDn]) return { sum: sDn, orders: dp[sDn].picks.map(i => pool[i]) };
      if (sUp <= hi && dp[sUp]) return { sum: sUp, orders: dp[sUp].picks.map(i => pool[i]) };
    }
  }
  return null;
}

function splitWithCapBacktrack(selectedOrders, minS, maxS, maxSame) {
  if (!(minS > 0) && !(maxS > 0)) { return [{ sum: selectedOrders.reduce((a, o) => a + o.amount, 0), orders: selectedOrders.slice() }]; }
  const lo = minS || 1, hi = maxS || selectedOrders.reduce((a, o) => a + o.amount, 0);
  let avail = selectedOrders.slice(); const capMap = new Map();
  function bestSubsetInRange(av, l, h) {
    const maxSum = Math.min(h, av.reduce((a, o) => a + o.amount, 0));
    const dp = Array(maxSum + 1).fill(null); dp[0] = { cnt: 0, picks: [] };
    for (let i = 0; i < av.length; i++) {
      const a = av[i].amount | 0;
      for (let s = maxSum; s >= a; s--) { if (dp[s - a] && (!dp[s] || dp[s - a].cnt + 1 < dp[s].cnt)) { dp[s] = { cnt: dp[s - a].cnt + 1, picks: dp[s - a].picks.concat(i) }; } }
    }
    for (let s = maxSum; s >= l; s--) { if (dp[s]) return { sum: s, picks: dp[s].picks }; }
    return null;
  }
  function dfs(av) {
    if (av.length === 0) return [];
    const cands = []; const step = Math.max(1, Math.floor((hi - lo) / 24));
    for (let s = Math.min(hi, av.reduce((a, o) => a + o.amount, 0)); s >= lo; s -= step) {
      if (isFinite(maxSame) && (capMap.get(s) || 0) >= maxSame) continue;
      const probe = bestSubsetInRange(av, s, s); if (probe) { cands.push(probe); if (cands.length >= 8) break; }
    }
    if (cands.length === 0) { 
        const p = bestSubsetInRange(av, lo, hi);
        if (p && (!isFinite(maxSame) || (capMap.get(p.sum)||0) < maxSame)) cands.push(p);
    }
    for (const cand of cands) {
      const pick = cand.picks.map(i => av[i]); const used = new Set(pick.map(makeKey));
      const rest = av.filter(o => !used.has(makeKey(o)));
      capMap.set(cand.sum, (capMap.get(cand.sum) || 0) + 1);
      const sub = dfs(rest); if (sub) return [{ sum: cand.sum, orders: pick }, ...sub];
      capMap.set(cand.sum, capMap.get(cand.sum) - 1);
    }
    return null;
  }
  return dfs(avail);
}

function splitFixedCount(selectedOrders, minS, maxS, targetCount) {
  let currentBundles = selectedOrders.map(o => ({ sum: o.amount, orders: [o] }));
  if (currentBundles.length < targetCount) return null;
  let safetyCounter = 0;
  while (currentBundles.length > targetCount) {
    safetyCounter++;
    if(safetyCounter > 500) return null; 
    currentBundles.sort((a, b) => a.sum - b.sum);
    const smallest = currentBundles[0];
    let bestPartnerIdx = -1;
    for (let i = 1; i < currentBundles.length; i++) {
        const partner = currentBundles[i];
        if (maxS === 0 || (smallest.sum + partner.sum <= maxS)) {
            bestPartnerIdx = i;
            break; 
        }
    }
    if (bestPartnerIdx !== -1) {
        const partner = currentBundles[bestPartnerIdx];
        const newBundle = { sum: smallest.sum + partner.sum, orders: smallest.orders.concat(partner.orders) };
        currentBundles.splice(bestPartnerIdx, 1);
        currentBundles.shift();
        currentBundles.push(newBundle);
    } else {
        return null;
    }
  }
  if (minS > 0) { if (currentBundles.some(b => b.sum < minS)) return null; }
  return currentBundles;
}

/* ====== ç³»ç»Ÿäº¤äº’ç»‘å®š ====== */
window.recoverSingleOrder = function(batchIdx, invIdx, orderIdx) {
    const batch = deleteRecords[batchIdx]; const inv = batch[invIdx]; const order = inv.orders[orderIdx];
    if (!inventory.find(x => makeKey(x) === makeKey(order))) { inventory.push(order); }
    inventory = normalize(inventory); inv.orders.splice(orderIdx, 1);
    inv.sum = inv.orders.reduce((a, b) => a + b.amount, 0);
    if (inv.orders.length === 0) { batch.splice(invIdx, 1); }
    if (batch.length === 0) { deleteRecords.splice(batchIdx, 1); }
    saveDeleteRecords(); saveInventory(); renderDeleteRecords();
};

window.recoverBatch = function(batchIdx) {
    const rec = deleteRecords.splice(batchIdx, 1)[0];
    if (rec) {
        rec.forEach(inv => inv.orders.forEach(o => { if (!inventory.find(x => makeKey(x) === makeKey(o))) inventory.push(o); }));
        inventory = normalize(inventory); saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    }
};

document.addEventListener('DOMContentLoaded', async () => {
  await loadInventory(); 
  renderHeaderHistory(); 
  renderDeleteRecords();

  let lastInv = null;

  document.getElementById('combine-btn').onclick = async () => {
    const outEl = document.getElementById('result-output');
    const loadEl = document.getElementById('loading-overlay');
    const retryTxt = document.getElementById('retry-count');
    
    outEl.textContent = '';
    const tgt = +document.getElementById('target-input').value; if (!tgt) return alert('è¯·è¾“å…¥ç›®æ ‡é‡‘é¢');
    const minS = +document.getElementById('min-single').value || 0, maxS = +document.getElementById('max-single').value || 0;
    const msc = +document.getElementById('max-same-count').value || Infinity;
    const ic = +document.getElementById('invoice-count').value || 0;
    const header = document.getElementById('company-header').value.trim();
    
    if(header) {
        saveHeaderHistory(header);
        renderHeaderHistory();
    }
    
    loadEl.style.display = 'flex';
    
    setTimeout(async () => {
        let attempt = 0, success = null;
        
        while (attempt < 2000) {
            attempt++; 
            retryTxt.textContent = `æ™ºèƒ½è®¡ç®—ä¸­... (å°è¯•æ–¹æ¡ˆ: ${attempt} / 2000)`;
            
            let pool = inventory.slice(); 
            if (attempt > 1) shuffleArray(pool); 
            
            const pick = selectOrdersByDP(tgt, maxS, document.getElementById('allow-approx').checked, document.getElementById('only-higher').checked, document.getElementById('filter-order-min').value, document.getElementById('filter-order-max').value, pool);
            
            if (pick) {
                let invs = null;
                if (ic > 0) {
                    invs = splitFixedCount(pick.orders, minS, maxS, ic);
                } else {
                    invs = splitWithCapBacktrack(pick.orders, minS, maxS, msc);
                }

                if (invs && Math.abs(invs.reduce((a,b)=>a+b.sum,0) - pick.sum) < 0.01) { success = invs; break; }
            }
            if (attempt % 50 === 0) await new Promise(r => setTimeout(r, 0));
        }
        
        loadEl.style.display = 'none';
        
        if (!success) {
            outEl.textContent = `SYSTEM INFO: è®¡ç®—å®Œæˆï¼Œæœªæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç»„åˆã€‚\nå·²å°è¯• ${attempt} ç§éšæœºè·¯å¾„ã€‚\nå»ºè®®ï¼š\n1. æ£€æŸ¥åº“å­˜æ€»é¢æ˜¯å¦å……è¶³\n2. æ”¾å®½â€œå•ç¬”æœ€å°/æœ€å¤§â€é™åˆ¶\n3. å¦‚æœå¼ æ•°è¦æ±‚è¿‡å°‘ï¼Œå¯èƒ½æ— æ³•åˆå¹¶æˆåŠŸï¼ˆå•å¼ ä¼šè¶…ä¸Šé™ï¼‰`;
        } else {
            const out = []; 
            success.forEach((inv, i) => {
                out.push(`å‘ç¥¨${i + 1}ï¼š${inv.sum.toLocaleString()}å…ƒ${inv.orders.length > 1 ? 'ï¼ˆç›¸å…³è®¢å•åˆå¹¶ï¼‰' : ''}`); 
                inv.orders.forEach(o => out.push(`è®¢å•å·ï¼š${o.order}ï¼Œé‡‘é¢ï¼š${o.amount}å…ƒ`)); out.push('');
            });
            if (header) out.push(header, '');
            out.push('ä¸éœ€è¦å¤‡æ³¨', '568881753@qq.com');
            outEl.textContent = out.join('\n'); 
            lastInv = success;
            document.getElementById('confirm-delete-btn').classList.remove('hidden');
            showToast('è®¡ç®—æˆåŠŸ');
        }
    }, 50);
  };

  document.getElementById('confirm-delete-btn').onclick = () => {
    if(!lastInv) return;
    const removeSet = new Set(lastInv.flatMap(inv => inv.orders.map(makeKey)));
    inventory = inventory.filter(o => !removeSet.has(makeKey(o)));
    deleteRecords.unshift(lastInv); saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    document.getElementById('confirm-delete-btn').classList.add('hidden');
    document.getElementById('result-output').textContent += '\n\n[å·²å®Œæˆåˆ é™¤ï¼Œåº“å­˜å·²æ›´æ–°]';
    showToast('å·²å®Œæˆåˆ é™¤');
  };

  document.getElementById('copy-btn').onclick = () => {
      if(!document.getElementById('result-output').textContent) return;
      navigator.clipboard.writeText(document.getElementById('result-output').textContent);
      showToast('æ–¹æ¡ˆå·²å¤åˆ¶');
  };

  document.getElementById('reset-btn').onclick = async () => {
      if (confirm('ç¡®è®¤é‡ç½®åº“å­˜ï¼Ÿåˆ é™¤è®°å½•å°†è¢«æ¸…ç©ºï¼Œæ‰‹åŠ¨ä¿®æ­£å°†ä¸¢å¤±ã€‚')) { await loadInventory(true); renderDeleteRecords(); }
  };

  document.getElementById('backup-btn').onclick = () => {
    const data = { inventory: localStorage.getItem('invoiceInventory_V9_2'), deleteRecords: localStorage.getItem('deleteRecords_V9_2'), headerHistory: localStorage.getItem('headerHistory_V9_2') };
    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `InvoiceData_${new Date().toISOString().slice(0,10)}.json`; a.click();
    showToast('å¤‡ä»½å·²å¯¼å‡º');
  };

  document.getElementById('restore-btn').onclick = () => document.getElementById('restore-input').click();
  document.getElementById('restore-input').onchange = (e) => {
    const reader = new FileReader(); reader.onload = (ev) => {
      try {
          const data = JSON.parse(ev.target.result);
          if(data.inventory) localStorage.setItem('invoiceInventory_V9_2', data.inventory);
          if(data.deleteRecords) localStorage.setItem('deleteRecords_V9_2', data.deleteRecords);
          if(data.headerHistory) localStorage.setItem('headerHistory_V9_2', data.headerHistory);
          alert('æ•°æ®æ¢å¤æˆåŠŸï¼Œå³å°†åˆ·æ–°...');
          location.reload();
      } catch(e) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
    };
    if(e.target.files[0]) reader.readAsText(e.target.files[0]);
  };
  
  document.getElementById('btn-search-order').onclick = () => {
      const val = document.getElementById('search-order-input').value.trim();
      const resArea = document.getElementById('edit-result-area');
      resArea.innerHTML = ''; if(!val) return;
      const found = inventory.filter(o => o.order.includes(val));
      if(found.length === 0) { resArea.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;">æ— ç»“æœ</div>'; return; }
      found.forEach(item => {
          const d = document.createElement('div'); d.className='order-line'; d.style.background='rgba(0,0,0,0.03)';
          d.innerHTML = `<span style="font-size:12px; font-weight:600;">${item.order}</span><input type="number" value="${item.amount}" style="width:70px; padding:8px; font-size:13px;">`;
          const btn = document.createElement('button'); btn.textContent='ä¿å­˜'; btn.className='btn-recover'; btn.style.marginLeft='10px';
          btn.onclick = () => { 
              const newV = Number(d.querySelector('input').value);
              if(newV > 0) {
                  item.amount = newV; 
                  inventory = normalize(inventory); // é‡æ–°æ ‡å‡†åŒ–ä»¥æ›´æ–°Key
                  saveInventory(); 
                  showToast('å·²ä¿®æ­£'); 
                  document.getElementById('btn-search-order').click(); // åˆ·æ–°åˆ—è¡¨
              }
          };
          d.appendChild(btn); resArea.appendChild(d);
      });
  };
});
</script>
</body>
</html>
