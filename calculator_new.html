<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å‘ç¥¨ç»„åˆè®¡ç®—å™¨ (V10.1 æ•°æ®ä¿®å¤ç‰ˆ)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <style>
    :root {
      --primary: #007aff;
      --bg-color: #f2f2f7;
      --card-bg: #ffffff;
      --text-main: #1c1c1e;
      --text-sub: #8e8e93;
      --border-radius: 12px;
      --btn-radius: 10px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      --danger: #ff3b30;
      --success: #34c759;
      --warning: #ffcc00;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-main); padding-bottom: 280px; }
    .container { max-width: 520px; margin: 0 auto; padding: 20px 16px; }
    h2 { text-align: center; margin-bottom: 20px; font-size: 1.4rem; font-weight: 700; }
    .card { background: var(--card-bg); border-radius: var(--border-radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }
    label { display: block; margin-top: 16px; font-size: 0.9rem; font-weight: 600; margin-bottom: 6px; }
    .highlight-label { color: var(--primary); }
    input, textarea { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #d1d1d6; border-radius: 8px; background: #fcfcfc; }
    .flex { display: flex; gap: 10px; align-items: center; }
    .flex input { flex: 1; text-align: center; }
    .two-cols { display: flex; gap: 12px; margin-top: 10px; }
    .two-cols > div { flex: 1; }
    .checkbox-group { display: flex; gap: 15px; margin-top: 16px; background: #f9f9f9; padding: 12px; border-radius: 8px; }
    .checkbox-item { display: flex; align-items: center; font-size: 0.9rem; }
    #header-history { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
    .hdr-item { background: #f2f2f7; color: var(--primary); border-radius: 6px; display: flex; overflow: hidden; font-size: 0.85rem; }
    .hdr-item button { background: transparent; border: none; padding: 6px 10px; }
    .inventory-stats-box { background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); padding: 15px; border-radius: var(--border-radius); margin-top: 20px; border: 1px solid #b8daff; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
    .stat-item { background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px; text-align: center; }
    .stat-val { font-size: 1.1rem; font-weight: 800; color: var(--primary); display: block; }
    .stat-label { font-size: 0.75rem; color: #666; }
    .accordion { border-radius: var(--border-radius); overflow: hidden; margin-top: 12px; background: #fff; box-shadow: var(--shadow); }
    .accordion-header { padding: 14px 20px; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; background: #fff; border-bottom: 1px solid #f0f0f0; }
    .accordion-content { display: none; padding: 16px 20px; background: #fafafa; }
    #result-output { font-family: monospace; font-size: 0.9rem; white-space: pre-wrap; background: #f8f9fa; padding: 12px; border-radius: 8px; max-height: 300px; overflow-y: auto; }
    .footer { position: fixed; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 12px 16px 30px 16px; display: flex; gap: 10px; flex-wrap: wrap; z-index: 100; border-top: 1px solid rgba(0,0,0,0.05); }
    .footer button { border: none; border-radius: var(--btn-radius); font-weight: 600; }
    .btn-full { flex: 1 1 100%; padding: 14px 0; font-size: 1.1rem; }
    .btn-half { flex: 1 1 calc(50% - 5px); padding: 12px 0; font-size: 0.95rem; }
    .primary { background: var(--primary); color: #fff; }
    .secondary { background: #e5e5ea; color: #333; }
    .danger { background: var(--danger); color: #fff; }
    .success { background: var(--success); color: #fff; }
    .warning { background: var(--warning); color: #000; }
    #loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.92); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; }
    .spinner { width: 44px; height: 44px; border: 4px solid #e5e5e5; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
    .record-item { border-top: 1px dashed #eee; padding: 12px 0; }
    .single-order-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.9rem; }
    .btn-recover-one { font-size: 0.75rem; padding: 2px 8px; background: #e3f2fd; color: var(--primary); border-radius: 10px; border:none; }
  </style>
</head>
<body>
  <div id="loading-overlay"><div class="spinner"></div><div id="loading-text" style="margin-top:15px; font-weight:600;">æ­£åœ¨è®¡ç®—...</div><div id="retry-count">0 / 2000</div></div>
  <div class="container">
    <h2>ğŸ§¾ å‘ç¥¨ç»„åˆè®¡ç®—å™¨</h2>
    <div class="card">
      <label class="highlight-label">ğŸ¯ ç›®æ ‡å¼€ç¥¨é‡‘é¢</label>
      <input id="target-input" type="number" placeholder="è¯·è¾“å…¥æ€»é‡‘é¢">
      <label>ğŸ” è®¢å•å·èŒƒå›´ç­›é€‰</label>
      <div class="flex"><input id="filter-order-min" type="text" placeholder="èµ·å§‹å·"><input id="filter-order-max" type="text" placeholder="ç»“æŸå·"></div>
      <label>ğŸ’° å•å¼ å‘ç¥¨é‡‘é¢é™åˆ¶</label>
      <div class="flex"><input id="min-single" type="number" placeholder="æœ€å°"><input id="max-single" type="number" placeholder="æœ€å¤§"></div>
      <div class="two-cols">
        <div><label>ğŸ”¢ åŒé¢ä¸Šé™</label><input id="max-same-count" type="number"></div>
        <div><label>ğŸ“„ å›ºå®šå¼ æ•°</label><input id="invoice-count" type="number"></div>
      </div>
      <div class="checkbox-group">
        <label class="checkbox-item"><input type="checkbox" id="allow-approx"> å…è®¸è¯¯å·®åŒ¹é…</label>
        <label class="checkbox-item"><input type="checkbox" id="only-higher"> ä¸å¾—å°äºç›®æ ‡</label>
      </div>
      <label>ğŸ¢ å…¬å¸æŠ¬å¤´</label>
      <textarea id="company-header" rows="2"></textarea>
      <div id="header-history"></div>
      <div id="inventory-stats" class="inventory-stats-box">æ­£åœ¨åŠ è½½...</div>
    </div>
    <div class="accordion">
      <div class="accordion-header" id="backup-acc-header"><span>ğŸ“¦ æ•°æ®è¿ç§» (å¤‡ä»½/æ¢å¤)</span><div class="arrow"></div></div>
      <div class="accordion-content" id="backup-acc-content">
        <div class="two-cols"><button id="backup-btn" class="success">å¤‡ä»½æ•°æ®</button><button id="restore-btn" class="warning">æ¢å¤æ•°æ®</button></div>
        <textarea id="backup-text" readonly style="margin-top:10px; font-size:0.7rem; display:none;"></textarea>
        <input type="file" id="restore-input" style="display:none" accept=".json">
      </div>
    </div>
    <div class="accordion">
      <div class="accordion-header" id="edit-acc-header"><span>ğŸ›  åº“å­˜ä¿®æ­£ / æŸ¥è¯¢</span><div class="arrow"></div></div>
      <div class="accordion-content" id="edit-acc-content">
        <div class="flex"><input id="search-order-input" type="text"><button id="btn-search-order" class="primary" style="width:80px;">æŸ¥è¯¢</button></div>
        <div id="edit-result-area" style="margin-top:10px"></div>
      </div>
    </div>
    <div class="card"><h3>ç»„åˆç»“æœ</h3><div id="result-output"></div></div>
    <div class="accordion">
      <div class="accordion-header" id="del-acc-header"><span>ğŸ—‘ åˆ é™¤è®°å½•</span><div class="arrow"></div></div>
      <div class="accordion-content" id="record-list"></div>
    </div>
  </div>
  <div class="footer">
    <button id="combine-btn" class="primary btn-full">âœ¨ ä¸€é”®æ™ºèƒ½ç»„åˆ</button>
    <button id="copy-btn" class="secondary btn-half">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    <button id="reset-btn" class="secondary btn-half">ğŸ”„ é‡ç½®åº“å­˜</button>
    <button id="confirm-delete-btn" class="danger btn-full hidden">ğŸ—‘ ç¡®è®¤åˆ é™¤åº“å­˜</button>
  </div>

<script>
// --- æ ¸å¿ƒé€»è¾‘å®Œå…¨æ¢å¤ V9.9 ç‰ˆæœ¬ï¼ŒKey ä½¿ç”¨ V9_2 ---
const DATA_SOURCE = [{"order":"29844392230","amount":1240},{"order":"29787668582","amount":670},{"order":"29779855398","amount":670},{"order":"29758217446","amount":208},{"order":"29758125414","amount":670},{"order":"29754938534","amount":189},{"order":"29754882022","amount":740},{"order":"29723444262","amount":1180},{"order":"29722926822","amount":189},{"order":"29722933926","amount":590},{"order":"29722673446","amount":1770},{"order":"29722664486","amount":189},{"order":"29722661094","amount":490},{"order":"29722722854","amount":590},{"order":"29722357286","amount":490},{"order":"29722422118","amount":490},{"order":"29722343654","amount":490},{"order":"29721815398","amount":590},{"order":"29722199910","amount":1470},{"order":"29722121958","amount":590},{"order":"29722146598","amount":189},{"order":"29722006502","amount":590},{"order":"29722009638","amount":189},{"order":"29664786726","amount":1345},{"order":"29657407974","amount":960},{"order":"29657049766","amount":960},{"order":"29657089702","amount":1000},{"order":"29657268006","amount":1000},{"order":"29613864934","amount":990},{"order":"29613779238","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29579148454","amount":990},{"order":"29578714086","amount":159},{"order":"29578467110","amount":990},{"order":"29578353894","amount":990},{"order":"29578045286","amount":1020},{"order":"29578181862","amount":1020},{"order":"29578056486","amount":2040},{"order":"29577984294","amount":2040},{"order":"29521294630","amount":1050},{"order":"29521271270","amount":1050},{"order":"29511656678","amount":1050},{"order":"29511582438","amount":1050},{"order":"29503897638","amount":1020},{"order":"29503915686","amount":1020},{"order":"29503479526","amount":1050},{"order":"29503480294","amount":1050},{"order":"29499944230","amount":1000},{"order":"29499944294","amount":1000},{"order":"29498897254","amount":1050},{"order":"29498897702","amount":1050},{"order":"29490917478","amount":1050},{"order":"29490868710","amount":1050},{"order":"29488269734","amount":1000},{"order":"29488521894","amount":1000},{"order":"29488129766","amount":1000},{"order":"29488684390","amount":1000},{"order":"29487024294","amount":1050},{"order":"29487043942","amount":1050},{"order":"29487038182","amount":1050},{"order":"29487022822","amount":1050},{"order":"29475651046","amount":1050},{"order":"29475572838","amount":1050},{"order":"29472654886","amount":1050},{"order":"29472546022","amount":1050},{"order":"29376457638","amount":1050},{"order":"29376618790","amount":1050},{"order":"29372705702","amount":1050},{"order":"29372746918","amount":1050},{"order":"29324981734","amount":1050},{"order":"29325052966","amount":1050},{"order":"29324565990","amount":1050},{"order":"29324610982","amount":1050},{"order":"29324176358","amount":1050},{"order":"29324204646","amount":1050},{"order":"29322723302","amount":2100},{"order":"29321161126","amount":2100},{"order":"29321200934","amount":2100},{"order":"29320710246","amount":3150},{"order":"29320689446","amount":5250},{"order":"29320422758","amount":1050},{"order":"29320229798","amount":2100},{"order":"29320212582","amount":2100},{"order":"29320259878","amount":5250},{"order":"29320237030","amount":1050},{"order":"29320311014","amount":5250},{"order":"29313551014","amount":2100},{"order":"29313528934","amount":5250},{"order":"29313330278","amount":5250},{"order":"29309418406","amount":5250},{"order":"29250020006","amount":1050},{"order":"29250000166","amount":4200},{"order":"29250087014","amount":5250},{"order":"29250059750","amount":1050},{"order":"29250018150","amount":3150},{"order":"29249976614","amount":4200},{"order":"29249801830","amount":5250},{"order":"29240651238","amount":5250},{"order":"29203828262","amount":3150},{"order":"29195981798","amount":1050},{"order":"29195932070","amount":1050},{"order":"29195980582","amount":1050},{"order":"29195981286","amount":1050},{"order":"29195705894","amount":2100},{"order":"29195678438","amount":2100},{"order":"29195667686","amount":1050},{"order":"29195761510","amount":1050},{"order":"29195733798","amount":1050},{"order":"29195721766","amount":1050},{"order":"29195728550","amount":1050},{"order":"29195559462","amount":1050},{"order":"29195615078","amount":1050},{"order":"29195500582","amount":1050},{"order":"29192155750","amount":2100},{"order":"29192157670","amount":2100},{"order":"29187893094","amount":1050},{"order":"29187884390","amount":1050},{"order":"29187450918","amount":1050},{"order":"29187453030","amount":1050},{"order":"29187413158","amount":1050},{"order":"29187431462","amount":1050},{"order":"29186986278","amount":1050},{"order":"29186994662","amount":1050},{"order":"29186704166","amount":1050},{"order":"29186524646","amount":5250},{"order":"29186336294","amount":3150},{"order":"29186354726","amount":3150},{"order":"29175575462","amount":1020},{"order":"29175636582","amount":1020},{"order":"29156266534","amount":3060},{"order":"29156274086","amount":3060},{"order":"29156045670","amount":1020},{"order":"29156085414","amount":1020},{"order":"29155498086","amount":2040},{"order":"29155589734","amount":2040},{"order":"29106863398","amount":229},{"order":"29085307238","amount":169},{"order":"29084841830","amount":845},{"order":"29041101926","amount":398},{"order":"29039226086","amount":995},{"order":"29039009830","amount":1393},{"order":"29038401830","amount":796},{"order":"29018396326","amount":796},{"order":"29008596838","amount":199},{"order":"29007762982","amount":5150},{"order":"29003278694","amount":209},{"order":"28964953318","amount":1010},{"order":"28965073958","amount":1010},{"order":"28957860134","amount":1010},{"order":"28957880934","amount":1010},{"order":"28945928166","amount":1010},{"order":"28945876774","amount":1010},{"order":"28941124646","amount":1010},{"order":"28941227494","amount":1010},{"order":"28940363750","amount":1010},{"order":"28940510694","amount":1010},{"order":"28940484134","amount":1010},{"order":"28940484582","amount":1010},{"order":"28940030374","amount":1010},{"order":"28940030374","amount":1010},{"order":"28939941734","amount":1010},{"order":"28939594534","amount":1010},{"order":"28939622054","amount":1010},{"order":"28934446950","amount":1010},{"order":"28934754086","amount":980},{"order":"28922217446","amount":1010},{"order":"28917119142","amount":1010},{"order":"28917546406","amount":1010},{"order":"28916902502","amount":980},{"order":"28916850278","amount":980},{"order":"28915493094","amount":1010},{"order":"28915621542","amount":1010},{"order":"28902560550","amount":980},{"order":"28902630502","amount":980},{"order":"28901966694","amount":980},{"order":"28901861734","amount":980},{"order":"28900709542","amount":980},{"order":"28900711270","amount":980},{"order":"28609574630","amount":1030},{"order":"28510891814","amount":450},{"order":"28510953062","amount":360},{"order":"28192753958","amount":970},{"order":"28192706790","amount":970},{"order":"28191451238","amount":1940},{"order":"28185388710","amount":3000},{"order":"28016488742","amount":990},{"order":"27989546470","amount":990},{"order":"27989054310","amount":990},{"order":"27989195302","amount":960},{"order":"27498602150","amount":2970},{"order":"27498949542","amount":2880},{"order":"27499031206","amount":4950},{"order":"27499056870","amount":4800},{"order":"27497737574","amount":4950},{"order":"27494179878","amount":990},{"order":"27493949158","amount":960},{"order":"27494024038","amount":990},{"order":"27493984614","amount":960},{"order":"27494228902","amount":990},{"order":"27494335398","amount":960},{"order":"27494049126","amount":3840},{"order":"27494017958","amount":3840},{"order":"27493623782","amount":960},{"order":"27493594598","amount":960},{"order":"27493467814","amount":960},{"order":"27493556646","amount":960},{"order":"27493456870","amount":1920},{"order":"27492798118","amount":960},{"order":"27493151398","amount":960},{"order":"27492642150","amount":960},{"order":"27473140390","amount":990},{"order":"27472936230","amount":2970},{"order":"27472964774","amount":990},{"order":"27462561958","amount":2970},{"order":"27460235046","amount":990},{"order":"27460354918","amount":960},{"order":"27460337702","amount":2970},{"order":"27309417766","amount":1020},{"order":"27309158246","amount":1020},{"order":"27309054566","amount":1020},{"order":"27307771942","amount":1020},{"order":"27306899942","amount":2040},{"order":"27266581350","amount":3060},{"order":"27249636582","amount":5100},{"order":"27239209510","amount":5150},{"order":"27232240614","amount":2020},{"order":"27231980262","amount":5050},{"order":"27232397414","amount":5050},{"order":"27231626022","amount":4120},{"order":"27224537510","amount":1010},{"order":"27136238886","amount":1050},{"order":"27136276518","amount":1050},{"order":"27134868582","amount":1050},{"order":"27134126886","amount":3150},{"order":"26790683558","amount":1040},{"order":"26693575462","amount":5050},{"order":"26388819174","amount":4160},{"order":"26373999526","amount":5200},{"order":"26211479910","amount":2060},{"order":"29722082086","amount":1770},{"order":"29722808550","amount":810},{"order":"29722753254","amount":567},{"order":"29722016806","amount":189},{"order":"29722015270","amount":490},{"order":"29721364070","amount":1770},{"order":"29721258726","amount":567},{"order":"29046424358","amount":597}];

let inventory=[];
let deleteRecords=JSON.parse(localStorage.getItem('deleteRecords_V9_2')||'[]');

// ä¿å­˜é€»è¾‘ï¼šåŠ¡å¿…ä½¿ç”¨ V9_2 ç‰ˆæœ¬çš„ Key ä»¥è¯»å–è¿ç§»çš„æ•°æ®
const saveDeleteRecords=()=>localStorage.setItem('deleteRecords_V9_2',JSON.stringify(deleteRecords));
const saveInventory = () => {
    localStorage.setItem('invoiceInventory_V9_2',JSON.stringify(inventory));
    renderStats();
};

const loadHeaderHistory=()=>JSON.parse(localStorage.getItem('headerHistory_V9_2')||'[]');
const saveHeaderHistory=h=>{
  if(!h) return; const arr=loadHeaderHistory().filter(x=>x!==h);
  arr.unshift(h); if(arr.length>10) arr.pop();
  localStorage.setItem('headerHistory_V9_2',JSON.stringify(arr));
};
function log(msg){ const el=document.getElementById('debug-log'); const t=new Date().toLocaleTimeString(); if(el) el.textContent+=`[${t}] ${msg}\n`; }

function normalize(raw){
  const map=new Map();
  (raw||[]).forEach(o=>{
    const order=String(o.order); const amount=Math.round(Number(o.amount)||0);
    const k=order+'|'+amount;
    if(!map.has(k)) map.set(k,{order,amount});
  });
  return Array.from(map.values());
}
const makeKey=o=>o.order+'|'+o.amount;

function renderStats() {
    const el = document.getElementById('inventory-stats');
    if (!el) return;
    if (!inventory || inventory.length === 0) { el.innerHTML = 'åº“å­˜ä¸ºç©º'; return; }
    const count = inventory.length;
    const total = inventory.reduce((a, b) => a + b.amount, 0);
    let min = inventory.reduce((m, p) => (p.amount < m ? p.amount : m), inventory[0].amount);
    let max = inventory.reduce((m, p) => (p.amount > m ? p.amount : m), inventory[0].amount);
    const fmt = (n) => n.toLocaleString();
    el.innerHTML = `
      <div style="font-weight:600; margin-bottom:10px; opacity:0.8;">ğŸ“Š å®æ—¶åº“å­˜ç›‘æ§</div>
      <div class="stats-grid">
        <div class="stat-item"><span class="stat-val">${fmt(total)}</span><span class="stat-label">æ€»é‡‘é¢</span></div>
        <div class="stat-item"><span class="stat-val">${fmt(count)}</span><span class="stat-label">è®¢å•æ•°</span></div>
        <div style="grid-column: 1/-1; text-align:center; font-size:0.8rem; margin-top:5px;">èŒƒå›´ï¼š${fmt(min)} ~ ${fmt(max)} å…ƒ</div>
      </div>`;
}

async function loadInventory(forceReset=false){
  if(!forceReset){
    const local=JSON.parse(localStorage.getItem('invoiceInventory_V9_2')||'null');
    if(local){ 
        inventory=normalize(local); 
        renderStats();
        return; 
    }
  }
  inventory=normalize(DATA_SOURCE); 
  saveInventory();
  if(forceReset){ deleteRecords=[]; saveDeleteRecords(); }
}

function renderHeaderHistory(){
  const div=document.getElementById('header-history'); div.innerHTML='';
  loadHeaderHistory().forEach((h,i)=>{
    const wrap=document.createElement('div'); wrap.className='hdr-item';
    const txt=document.createElement('button'); txt.textContent=h;
    txt.onclick=()=>document.getElementById('company-header').value=h;
    const del=document.createElement('button'); del.textContent='âœ•';
    del.onclick=()=>{ const a=loadHeaderHistory(); a.splice(i,1); localStorage.setItem('headerHistory_V9_2',JSON.stringify(a)); renderHeaderHistory(); };
    wrap.appendChild(txt); wrap.appendChild(del); div.appendChild(wrap);
  });
}

function renderDeleteRecords(){
  const list=document.getElementById('record-list'); list.innerHTML='';
  if(deleteRecords.length === 0) { list.innerHTML = 'æš‚æ— è®°å½•'; return; }
  deleteRecords.slice(0,20).forEach((batch, batchIdx)=>{
    const total=batch.reduce((s,inv)=>s+inv.sum,0);
    const item=document.createElement('div'); item.className='record-item';
    let html = `<div class="record-title">æ‰¹æ¬¡ ${batchIdx+1} | åˆè®¡ ${total}å…ƒ</div>`;
    batch.forEach((inv, invIdx) => {
        inv.orders.forEach((o, orderIdx) => {
           html += `<div class="single-order-row"><span>${o.order} | ${o.amount}å…ƒ</span><button class="btn-recover-one" onclick="recoverSingleOrder(${batchIdx}, ${invIdx}, ${orderIdx})">æ¢å¤</button></div>`;
        });
    });
    html += `<button onclick="recoverBatch(${batchIdx})" style="width:100%; padding:8px; margin-top:5px; border:none; border-radius:5px;">æ¢å¤æ•´æ‰¹</button>`;
    item.innerHTML=html; list.appendChild(item);
  });
}

window.recoverSingleOrder = function(batchIdx, invIdx, orderIdx) {
    const batch = deleteRecords[batchIdx]; const inv = batch[invIdx]; const order = inv.orders[orderIdx];
    if(!inventory.find(x => makeKey(x) === makeKey(order))) { inventory.push(order); }
    inventory = normalize(inventory); inv.orders.splice(orderIdx, 1);
    if(inv.orders.length === 0) { batch.splice(invIdx, 1); }
    if(batch.length === 0) { deleteRecords.splice(batchIdx, 1); }
    saveDeleteRecords(); saveInventory(); renderDeleteRecords();
};

window.recoverBatch = function(batchIdx) {
    const rec = deleteRecords.splice(batchIdx, 1)[0];
    if(rec) {
        rec.forEach(inv => inv.orders.forEach(o => { if(!inventory.find(x => makeKey(x) === makeKey(o))) inventory.push(o); }));
        inventory = normalize(inventory); saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    }
};

function bindAccordion(h,c){ h.addEventListener('click',()=>{ const open=c.style.display==='block'; c.style.display=open?'none':'block'; h.classList.toggle('open',!open); }); }
function shuffleArray(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

// --- ç®—æ³•éƒ¨åˆ† (ä¸ V9.9 å®Œå…¨ä¸€è‡´) ---
function selectOrdersByDP(target, maxSingle, allowApprox, onlyHigher, minOrderStr, maxOrderStr, usePool){
  let pool = usePool.slice();
  if(minOrderStr) pool = pool.filter(o => o.order >= minOrderStr);
  if(maxOrderStr) pool = pool.filter(o => o.order <= maxOrderStr);
  if(maxSingle > 0) pool = pool.filter(o => o.amount <= maxSingle);
  if(pool.length === 0) return null;
  const hi = allowApprox ? (target+500) : target;
  const dp = Array(hi+1).fill(null); dp[0]={cnt:0,picks:[]};
  for(let i=0;i<pool.length;i++){
    const a=pool[i].amount|0;
    for(let s=hi;s>=a;s--){
      if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
        dp[s]={cnt:dp[s-a].cnt+1,picks:dp[s-a].picks.concat(i)};
      }
    }
  }
  if(dp[target]) return {sum:target, orders: dp[target].picks.map(i=>pool[i])};
  if(!allowApprox) return null;
  for(let d=1; d<=500; d++){
    const sUp = target + d; const sDn = target - d;
    if(onlyHigher){ if(sUp<=hi && dp[sUp]) return {sum:sUp, orders: dp[sUp].picks.map(i=>pool[i])}; }
    else {
      if(sDn>=0 && dp[sDn]) return {sum:sDn, orders: dp[sDn].picks.map(i=>pool[i])};
      if(sUp<=hi && dp[sUp]) return {sum:sUp, orders: dp[sUp].picks.map(i=>pool[i])};
    }
  }
  return null;
}

function splitWithCapBacktrack(selectedOrders, minS, maxS, maxSame){
  if(!(minS>0) && !(maxS>0)){ return [{sum:selectedOrders.reduce((a,o)=>a+o.amount,0), orders:selectedOrders.slice()}]; }
  const lo=minS||1, hi=maxS||selectedOrders.reduce((a,o)=>a+o.amount,0);
  let avail=selectedOrders.slice(); const capMap=new Map();
  function bestSubsetInRange(av, l, h){
    const maxSum=Math.min(h, av.reduce((a,o)=>a+o.amount,0));
    const dp=Array(maxSum+1).fill(null); dp[0]={cnt:0,picks:[]};
    for(let i=0;i<av.length;i++){
      const a=av[i].amount|0;
      for(let s=maxSum;s>=a;s--){ if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){ dp[s]={cnt:dp[s-a].cnt+1,picks:dp[s-a].picks.concat(i)}; } }
    }
    for(let s=maxSum; s>=l; s--){ if(dp[s]) return {sum:s, picks:dp[s].picks}; }
    return null;
  }
  function dfs(av){
    if(av.length===0) return [];
    const cands=[]; const step=Math.max(1, Math.floor((hi-lo)/24));
    for(let s=Math.min(hi,av.reduce((a,o)=>a+o.amount,0)); s>=lo; s-=step){
      if(isFinite(maxSame) && (capMap.get(s)||0) >= maxSame) continue;
      const probe=bestSubsetInRange(av, s, s); if(probe){ cands.push(probe); if(cands.length>=8) break; }
    }
    for(const cand of cands){
      const pick=cand.picks.map(i=>av[i]); const used=new Set(pick.map(makeKey));
      const rest=av.filter(o=>!used.has(makeKey(o)));
      capMap.set(cand.sum,(capMap.get(cand.sum)||0)+1);
      const sub=dfs(rest); if(sub) return [{sum:cand.sum,orders:pick}, ...sub];
      capMap.set(cand.sum,capMap.get(cand.sum)-1);
    }
    return null;
  }
  return dfs(avail);
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadInventory(); renderHeaderHistory(); renderDeleteRecords();
  bindAccordion(document.getElementById('backup-acc-header'),document.getElementById('backup-acc-content'));
  bindAccordion(document.getElementById('edit-acc-header'),document.getElementById('edit-acc-content'));
  bindAccordion(document.getElementById('del-acc-header'),document.getElementById('record-list'));

  document.getElementById('combine-btn').onclick=async ()=>{
    const outEl=document.getElementById('result-output');
    const loadEl=document.getElementById('loading-overlay');
    const retryTxt=document.getElementById('retry-count');
    outEl.textContent='';
    const tgt=+document.getElementById('target-input').value; if(!tgt) return alert('è¯·è¾“å…¥ç›®æ ‡');
    const minS=+document.getElementById('min-single').value||0, maxS=+document.getElementById('max-single').value||0;
    const msc=+document.getElementById('max-same-count').value||Infinity;
    const ic =+document.getElementById('invoice-count').value||0;
    const header=document.getElementById('company-header').value.trim();
    saveHeaderHistory(header); renderHeaderHistory();
    loadEl.style.display = 'flex';
    setTimeout(async () => {
        let attempt = 0, success = null;
        while(attempt < 2000){
            attempt++; retryTxt.textContent = `${attempt} / 2000`;
            let pool = inventory.slice(); if(attempt > 1) shuffleArray(pool);
            const pick = selectOrdersByDP(tgt, maxS, document.getElementById('allow-approx').checked, document.getElementById('only-higher').checked, document.getElementById('filter-order-min').value, document.getElementById('filter-order-max').value, pool);
            if(pick){
                const invs = splitWithCapBacktrack(pick.orders, minS, maxS, msc);
                if(invs){ success = invs; break; }
            }
            if(attempt % 100 === 0) await new Promise(r => setTimeout(r, 0));
        }
        loadEl.style.display = 'none';
        if(!success) outEl.textContent='è®¡ç®—å¤±è´¥';
        else {
            const out=[]; success.forEach((inv,i)=>{
                out.push(`å‘ç¥¨${i+1}ï¼š${inv.sum}å…ƒ`); inv.orders.forEach(o=> out.push(`è®¢å•ï¼š${o.order} | ${o.amount}å…ƒ`)); out.push('');
            });
            if(header) out.push(header,'');
            outEl.textContent = out.join('\n'); lastInv=success;
            document.getElementById('confirm-delete-btn').classList.remove('hidden');
        }
    }, 50);
  };

  document.getElementById('confirm-delete-btn').onclick=()=>{
    const removeSet=new Set(lastInv.flatMap(inv=>inv.orders.map(makeKey)));
    inventory=inventory.filter(o=>!removeSet.has(makeKey(o)));
    deleteRecords.unshift(lastInv); saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    document.getElementById('confirm-delete-btn').classList.add('hidden');
  };

  document.getElementById('backup-btn').onclick = () => {
    const data = { inventory: localStorage.getItem('invoiceInventory_V9_2'), deleteRecords: localStorage.getItem('deleteRecords_V9_2'), headerHistory: localStorage.getItem('headerHistory_V9_2') };
    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup.json`; a.click();
    document.getElementById('backup-text').value = JSON.stringify(data); document.getElementById('backup-text').style.display='block';
  };

  document.getElementById('restore-btn').onclick = () => document.getElementById('restore-input').click();
  document.getElementById('restore-input').onchange = (e) => {
    const reader = new FileReader(); reader.onload = (ev) => {
      const data = JSON.parse(ev.target.result);
      if (data.inventory) localStorage.setItem('invoiceInventory_V9_2', data.inventory);
      if (data.deleteRecords) localStorage.setItem('deleteRecords_V9_2', data.deleteRecords);
      if (data.headerHistory) localStorage.setItem('headerHistory_V9_2', data.headerHistory);
      location.reload();
    };
    reader.readAsText(e.target.files[0]);
  };
});
</script>
</body>
</html>