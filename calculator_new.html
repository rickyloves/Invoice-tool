<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å‘ç¥¨ç»„åˆè®¡ç®—å™¨ (V10.0 UIç„•æ–°ç‰ˆ)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script>
    window.onerror = function(msg, url, line) {
      alert('ã€ç¨‹åºæŠ¥é”™ã€‘\n' + msg + '\nè¡Œå·ï¼š' + line + '\nè¯·æˆªå›¾åé¦ˆã€‚');
    };
  </script>
  <style>
    :root {
      --primary: #007aff; /* iOS Blue */
      --primary-hover: #0062cc;
      --bg-color: #f2f2f7; /* iOS System Gray 6 */
      --card-bg: #ffffff;
      --text-main: #1c1c1e;
      --text-sub: #8e8e93;
      --border-radius: 12px;
      --btn-radius: 10px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      --danger: #ff3b30;
      --success: #34c759;
      --warning: #ffcc00;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      background: var(--bg-color);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-main);
      padding-bottom: 280px; /* ç•™å‡ºåº•éƒ¨æ“ä½œåŒº */
      line-height: 1.5;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-main);
      letter-spacing: -0.5px;
    }

    /* å¡ç‰‡é€šç”¨æ ·å¼ */
    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(0,0,0,0.02);
    }

    label {
      display: block;
      margin-top: 16px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #3a3a3c;
      margin-bottom: 6px;
    }
    label:first-child { margin-top: 0; }
    .highlight-label { color: var(--primary); }

    /* è¾“å…¥æ¡†ä¼˜åŒ– */
    input, textarea {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid #d1d1d6;
      border-radius: 8px;
      background: #fcfcfc;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    input:focus, textarea:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    textarea { resize: vertical; min-height: 80px; }

    .flex { display: flex; gap: 10px; align-items: center; }
    .flex input { flex: 1; text-align: center; }
    .flex span { color: var(--text-sub); font-weight: bold; }

    .two-cols { display: flex; gap: 12px; margin-top: 10px; }
    .two-cols > div { flex: 1; }

    /* Checkbox ä¼˜åŒ– */
    .checkbox-group {
      display: flex;
      gap: 15px;
      margin-top: 16px;
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      color: #555;
      cursor: pointer;
    }
    .checkbox-item input { width: auto; margin-right: 6px; transform: scale(1.2); }

    /* æŠ¬å¤´å†å² */
    #header-history { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
    .hdr-item {
      background: #f2f2f7;
      color: var(--primary);
      border-radius: 6px;
      display: flex;
      align-items: center;
      overflow: hidden;
      font-size: 0.85rem;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .hdr-item button.txt { background: transparent; border: none; padding: 6px 10px; color: inherit; font-weight: 500; }
    .hdr-item button.del { background: rgba(0,0,0,0.05); border: none; padding: 6px 8px; color: #999; }
    
    /* V10.0 åº“å­˜ä»ªè¡¨ç›˜ */
    .inventory-stats-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%);
      color: #004085;
      padding: 15px;
      border-radius: var(--border-radius);
      margin-top: 20px;
      border: 1px solid #b8daff;
      position: relative;
      overflow: hidden;
    }
    .inventory-stats-box::before {
      content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary);
    }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
    .stat-item { background: rgba(255,255,255,0.6); padding: 8px; border-radius: 6px; text-align: center; }
    .stat-val { font-size: 1.1rem; font-weight: 800; color: var(--primary); display: block; }
    .stat-label { font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-range { grid-column: 1 / -1; text-align: center; font-size: 0.85rem; color: #555; margin-top: 4px; background: rgba(255,255,255,0.4); padding: 4px; border-radius: 4px;}

    /* æŠ˜å é¢æ¿ */
    .accordion { border-radius: var(--border-radius); overflow: hidden; margin-top: 12px; box-shadow: var(--shadow); background: #fff; }
    .accordion-header {
      padding: 14px 20px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }
    .accordion-header:active { background: #f9f9f9; }
    .accordion-header .arrow {
      width: 8px; height: 8px;
      border-right: 2px solid #ccc; border-bottom: 2px solid #ccc;
      transform: rotate(45deg); transition: transform 0.3s;
    }
    .accordion-header.open .arrow { transform: rotate(-135deg); border-color: var(--primary); }
    .accordion-content { display: none; padding: 16px 20px; background: #fafafa; }
    
    /* ç»“æœåŒºåŸŸ */
    #result-output {
      font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      color: #333;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #eee;
      max-height: 300px;
      overflow-y: auto;
    }

    /* åº•éƒ¨å›ºå®šæ“ä½œæ  */
    .footer {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
      padding: 12px 16px 30px 16px; /* é€‚é… iPhone X åº•éƒ¨ */
      display: flex; gap: 10px; flex-wrap: wrap; z-index: 100;
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    .footer button {
      border: none;
      border-radius: var(--btn-radius);
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.1s, opacity 0.2s;
    }
    .footer button:active { transform: scale(0.98); opacity: 0.9; }
    
    .btn-full { flex: 1 1 100%; padding: 14px 0; font-size: 1.1rem; }
    .btn-half { flex: 1 1 calc(50% - 5px); padding: 12px 0; font-size: 0.95rem; }

    .primary { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3); }
    .secondary { background: #e5e5ea; color: #333; }
    .danger { background: var(--danger); color: #fff; }
    .success { background: var(--success); color: #fff; }
    .warning { background: var(--warning); color: #000; }

    .hidden { display: none !important; }
    .tip { font-size: 0.85rem; color: var(--text-sub); line-height: 1.4; }

    /* Loading */
    #loading-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(4px);
      z-index: 999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      width: 44px; height: 44px;
      border: 4px solid #e5e5e5;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }

    /* å¤‡ä»½æ–‡æœ¬æ¡† */
    #backup-area { display: none; margin-top: 10px; }
    #backup-text { font-size: 0.75rem; color: #555; background: #fff; }
    
    /* ä¿®æ­£åˆ é™¤/ä¿®æ­£åˆ—è¡¨ */
    .record-item { border-top: 1px dashed #eee; padding: 12px 0; }
    .record-item:first-child { border-top: none; }
    .record-title { font-weight: 700; color: #333; margin-bottom: 8px; font-size: 0.95rem; }
    .single-order-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 0.9rem; color: #555; }
    .btn-recover-one { font-size: 0.75rem; padding: 4px 10px; background: #e3f2fd; color: var(--primary); border-radius: 12px; border:none; }
    .btn-recover-batch { width: 100%; margin-top: 10px; padding: 8px; background: #f0f0f5; color: #555; border-radius: 8px; border:none; font-weight: 500;}
    
    .edit-row { display: flex; gap: 8px; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
    .edit-row input { width: 80px; padding: 6px; }
    .btn-update { padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; font-size: 0.85rem;}
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="spinner"></div>
    <div id="loading-text" style="font-weight:600; color:#333; font-size:1.1rem;">æ­£åœ¨æ™ºèƒ½ç»„åˆ...</div>
    <div id="retry-count" style="color:#888; margin-top:8px; font-size:0.9rem; font-variant-numeric: tabular-nums;">0 / 2000</div>
  </div>

  <div class="container">
    <h2>ğŸ§¾ å‘ç¥¨ç»„åˆè®¡ç®—å™¨</h2>

    <div class="card">
      <label class="highlight-label">ğŸ¯ ç›®æ ‡å¼€ç¥¨é‡‘é¢</label>
      <input id="target-input" type="number" placeholder="è¯·è¾“å…¥æ€»é‡‘é¢ï¼Œå¦‚ 20000" style="font-size:1.2rem; font-weight:bold; color:var(--primary);">

      <label>ğŸ” è®¢å•å·èŒƒå›´ç­›é€‰</label>
      <div class="flex">
        <input id="filter-order-min" type="text" placeholder="èµ·å§‹å·">
        <span>â€”</span>
        <input id="filter-order-max" type="text" placeholder="ç»“æŸå·">
      </div>

      <label>ğŸ’° å•å¼ å‘ç¥¨é‡‘é¢é™åˆ¶</label>
      <div class="flex">
        <input id="min-single" type="number" placeholder="æœ€å°é‡‘é¢">
        <span>â€”</span>
        <input id="max-single" type="number" placeholder="æœ€å¤§é‡‘é¢">
      </div>

      <div class="two-cols">
        <div>
          <label>ğŸ”¢ åŒé¢å¼ æ•°ä¸Šé™</label>
          <input id="max-same-count" type="number" placeholder="é»˜è®¤ä¸é™">
        </div>
        <div>
          <label>ğŸ“„ å›ºå®šå¼ æ•°</label>
          <input id="invoice-count" type="number" placeholder="é»˜è®¤ä¸é™">
        </div>
      </div>

      <div class="checkbox-group">
        <label class="checkbox-item">
          <input type="checkbox" id="allow-approx"> å…è®¸è¯¯å·®æœ€å°åŒ¹é…
        </label>
        <label class="checkbox-item">
          <input type="checkbox" id="only-higher"> ä¸å¾—å°äºç›®æ ‡
        </label>
      </div>

      <label>ğŸ¢ å…¬å¸æŠ¬å¤´</label>
      <textarea id="company-header" rows="2" placeholder="è¡Œ1ï¼šå…¬å¸åç§°&#10;è¡Œ2ï¼šç¨å·"></textarea>
      <div id="header-history"></div>

      <div id="inventory-stats" class="inventory-stats-box">
          <div style="text-align:center; color:#999;">æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...</div>
      </div>
    </div>

    <div class="accordion">
        <div class="accordion-header" id="backup-acc-header" style="color:#b58900;">
          <span>ğŸ“¦ æ•°æ®è¿ç§» (å¤‡ä»½/æ¢å¤)</span>
          <div class="arrow"></div>
        </div>
        <div class="accordion-content" id="backup-acc-content">
          <div class="tip">åœ¨æ—§è®¾å¤‡ç‚¹â€œå¤‡ä»½â€å¤åˆ¶ä¹±ç ï¼Œåœ¨æ–°è®¾å¤‡ç‚¹â€œæ¢å¤â€ç²˜è´´æˆ–å¯¼å…¥æ–‡ä»¶ã€‚</div>
          <div class="two-cols" style="margin-top:12px;">
              <button id="backup-btn" class="success" style="padding:10px; border-radius:8px; border:none; width:100%;">ğŸ“¤ å¤‡ä»½æ•°æ®</button>
              <button id="restore-btn" class="warning" style="padding:10px; border-radius:8px; border:none; width:100%;">ğŸ“¥ æ¢å¤æ•°æ®</button>
          </div>
          <div id="backup-area">
              <label>å¤‡ä»½ç ï¼ˆå¤åˆ¶/ç²˜è´´æ­¤å¤„ï¼‰ï¼š</label>
              <textarea id="backup-text" readonly onclick="this.select()"></textarea>
          </div>
          <input type="file" id="restore-input" style="display:none" accept=".json">
        </div>
    </div>

    <div class="accordion">
      <div class="accordion-header" id="edit-acc-header">
        <span>ğŸ›  åº“å­˜ä¿®æ­£ / æŸ¥è¯¢</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="edit-acc-content">
        <div class="search-box flex">
            <input id="search-order-input" type="text" placeholder="è¾“å…¥è®¢å•å·æŸ¥è¯¢">
            <button id="btn-search-order" class="primary" style="width:80px; padding:0; border-radius:8px;">æŸ¥è¯¢</button>
        </div>
        <div id="edit-result-area" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card">
      <h3 style="font-size:1rem; margin-bottom:10px;">ğŸ“¤ ç»„åˆç»“æœ</h3>
      <div id="result-output" placeholder="ç‚¹å‡»â€œä¸€é”®ç»„åˆâ€ååœ¨æ­¤æ˜¾ç¤ºç»“æœ"></div>
    </div>

    <div class="accordion">
      <div class="accordion-header" id="del-acc-header">
        <span>ğŸ—‘ åˆ é™¤/æ¢å¤è®°å½•</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="record-list" style="display:none;"></div>
    </div>

    <div class="accordion" style="margin-bottom: 20px;">
      <div class="accordion-header" id="debug-acc-header">
        <span>ğŸ è°ƒè¯•æ—¥å¿—</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="debug-acc-content" style="display:none;">
        <div id="debug-log"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button id="combine-btn" class="primary btn-full">âœ¨ ä¸€é”®æ™ºèƒ½ç»„åˆ</button>
    <button id="copy-btn" class="secondary btn-half">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    <button id="reset-btn" class="secondary btn-half">ğŸ”„ é‡ç½®åº“å­˜</button>
    <button id="confirm-delete-btn" class="danger btn-full hidden">ğŸ—‘ ç¡®è®¤åˆ é™¤åº“å­˜</button>
  </div>

<script>
// --- æ•°æ®æº (å†…ç½®) ---
const DATA_SOURCE = [
{"order":"29844392230","amount":1240},{"order":"29787668582","amount":670},{"order":"29779855398","amount":670},{"order":"29758217446","amount":208},{"order":"29758125414","amount":670},{"order":"29754938534","amount":189},{"order":"29754882022","amount":740},{"order":"29723444262","amount":1180},{"order":"29722926822","amount":189},{"order":"29722933926","amount":590},{"order":"29722673446","amount":1770},{"order":"29722664486","amount":189},{"order":"29722661094","amount":490},{"order":"29722722854","amount":590},{"order":"29722357286","amount":490},{"order":"29722422118","amount":490},{"order":"29722343654","amount":490},{"order":"29721815398","amount":590},{"order":"29722199910","amount":1470},{"order":"29722121958","amount":590},{"order":"29722146598","amount":189},{"order":"29722006502","amount":590},{"order":"29722009638","amount":189},{"order":"29664786726","amount":1345},{"order":"29657407974","amount":960},{"order":"29657049766","amount":960},{"order":"29657089702","amount":1000},{"order":"29657268006","amount":1000},{"order":"29613864934","amount":990},{"order":"29613779238","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29613146918","amount":1194},{"order":"29595224358","amount":1020},{"order":"29594630822","amount":1020},{"order":"29594980966","amount":1020},{"order":"29595121894","amount":1020},{"order":"29595097062","amount":1020},{"order":"29595222822","amount":1020},{"order":"29584577446","amount":1020},{"order":"29585686374","amount":1020},{"order":"29579912422","amount":990},{"order":"29579148454","amount":990},{"order":"29578714086","amount":159},{"order":"29578467110","amount":990},{"order":"29578353894","amount":990},{"order":"29578045286","amount":1020},{"order":"29578181862","amount":1020},{"order":"29578056486","amount":2040},{"order":"29577984294","amount":2040},{"order":"29521294630","amount":1050},{"order":"29521271270","amount":1050},{"order":"29511656678","amount":1050},{"order":"29511582438","amount":1050},{"order":"29503897638","amount":1020},{"order":"29503915686","amount":1020},{"order":"29503479526","amount":1050},{"order":"29503480294","amount":1050},{"order":"29499944230","amount":1000},{"order":"29499944294","amount":1000},{"order":"29498897254","amount":1050},{"order":"29498897702","amount":1050},{"order":"29490917478","amount":1050},{"order":"29490868710","amount":1050},{"order":"29488269734","amount":1000},{"order":"29488521894","amount":1000},{"order":"29488129766","amount":1000},{"order":"29488684390","amount":1000},{"order":"29487024294","amount":1050},{"order":"29487043942","amount":1050},{"order":"29487038182","amount":1050},{"order":"29487022822","amount":1050},{"order":"29475651046","amount":1050},{"order":"29475572838","amount":1050},{"order":"29472654886","amount":1050},{"order":"29472546022","amount":1050},{"order":"29376457638","amount":1050},{"order":"29376618790","amount":1050},{"order":"29372705702","amount":1050},{"order":"29372746918","amount":1050},{"order":"29324981734","amount":1050},{"order":"29325052966","amount":1050},{"order":"29324565990","amount":1050},{"order":"29324610982","amount":1050},{"order":"29324176358","amount":1050},{"order":"29324204646","amount":1050},{"order":"29322723302","amount":2100},{"order":"29321161126","amount":2100},{"order":"29321200934","amount":2100},{"order":"29320710246","amount":3150},{"order":"29320689446","amount":5250},{"order":"29320422758","amount":1050},{"order":"29320229798","amount":2100},{"order":"29320212582","amount":2100},{"order":"29320259878","amount":5250},{"order":"29320237030","amount":1050},{"order":"29320311014","amount":5250},{"order":"29313551014","amount":2100},{"order":"29313528934","amount":5250},{"order":"29313330278","amount":5250},{"order":"29309418406","amount":5250},{"order":"29250020006","amount":1050},{"order":"29250000166","amount":4200},{"order":"29250087014","amount":5250},{"order":"29250059750","amount":1050},{"order":"29250018150","amount":3150},{"order":"29249976614","amount":4200},{"order":"29249801830","amount":5250},{"order":"29240651238","amount":5250},{"order":"29203828262","amount":3150},{"order":"29195981798","amount":1050},{"order":"29195932070","amount":1050},{"order":"29195980582","amount":1050},{"order":"29195981286","amount":1050},{"order":"29195705894","amount":2100},{"order":"29195678438","amount":2100},{"order":"29195667686","amount":1050},{"order":"29195761510","amount":1050},{"order":"29195733798","amount":1050},{"order":"29195721766","amount":1050},{"order":"29195728550","amount":1050},{"order":"29195559462","amount":1050},{"order":"29195615078","amount":1050},{"order":"29195500582","amount":1050},{"order":"29192155750","amount":2100},{"order":"29192157670","amount":2100},{"order":"29187893094","amount":1050},{"order":"29187884390","amount":1050},{"order":"29187450918","amount":1050},{"order":"29187453030","amount":1050},{"order":"29187413158","amount":1050},{"order":"29187431462","amount":1050},{"order":"29186986278","amount":1050},{"order":"29186994662","amount":1050},{"order":"29186704166","amount":1050},{"order":"29186524646","amount":5250},{"order":"29186336294","amount":3150},{"order":"29186354726","amount":3150},{"order":"29175575462","amount":1020},{"order":"29175636582","amount":1020},{"order":"29156266534","amount":3060},{"order":"29156274086","amount":3060},{"order":"29156045670","amount":1020},{"order":"29156085414","amount":1020},{"order":"29155498086","amount":2040},{"order":"29155589734","amount":2040},{"order":"29106863398","amount":229},{"order":"29085307238","amount":169},{"order":"29084841830","amount":845},{"order":"29041101926","amount":398},{"order":"29039226086","amount":995},{"order":"29039009830","amount":1393},{"order":"29038401830","amount":796},{"order":"29018396326","amount":796},{"order":"29008596838","amount":199},{"order":"29007762982","amount":5150},{"order":"29003278694","amount":209},{"order":"28964953318","amount":1010},{"order":"28965073958","amount":1010},{"order":"28957860134","amount":1010},{"order":"28957880934","amount":1010},{"order":"28945928166","amount":1010},{"order":"28945876774","amount":1010},{"order":"28941124646","amount":1010},{"order":"28941227494","amount":1010},{"order":"28940363750","amount":1010},{"order":"28940510694","amount":1010},{"order":"28940484134","amount":1010},{"order":"28940484582","amount":1010},{"order":"28940030374","amount":1010},{"order":"28939941734","amount":1010},{"order":"28939594534","amount":1010},{"order":"28939622054","amount":1010},{"order":"28934446950","amount":1010},{"order":"28934754086","amount":980},{"order":"28922217446","amount":1010},{"order":"28917119142","amount":1010},{"order":"28917546406","amount":1010},{"order":"28916902502","amount":980},{"order":"28916850278","amount":980},{"order":"28915493094","amount":1010},{"order":"28915621542","amount":1010},{"order":"28902560550","amount":980},{"order":"28902630502","amount":980},{"order":"28901966694","amount":980},{"order":"28901861734","amount":980},{"order":"28900709542","amount":980},{"order":"28900711270","amount":980},{"order":"28609574630","amount":1030},{"order":"28510891814","amount":450},{"order":"28510953062","amount":360},{"order":"28192753958","amount":970},{"order":"28192706790","amount":970},{"order":"28191451238","amount":1940},{"order":"28185388710","amount":3000},{"order":"28016488742","amount":990},{"order":"27989546470","amount":990},{"order":"27989054310","amount":990},{"order":"27989195302","amount":960},{"order":"27498602150","amount":2970},{"order":"27498949542","amount":2880},{"order":"27499031206","amount":4950},{"order":"27499056870","amount":4800},{"order":"27497737574","amount":4950},{"order":"27494179878","amount":990},{"order":"27493949158","amount":960},{"order":"27494024038","amount":990},{"order":"27493984614","amount":960},{"order":"27494228902","amount":990},{"order":"27494335398","amount":960},{"order":"27494049126","amount":3840},{"order":"27494017958","amount":3840},{"order":"27493623782","amount":960},{"order":"27493594598","amount":960},{"order":"27493467814","amount":960},{"order":"27493556646","amount":960},{"order":"27493456870","amount":1920},{"order":"27492798118","amount":960},{"order":"27493151398","amount":960},{"order":"27492642150","amount":960},{"order":"27473140390","amount":990},{"order":"27472936230","amount":2970},{"order":"27472964774","amount":990},{"order":"27462561958","amount":2970},{"order":"27460235046","amount":990},{"order":"27460354918","amount":960},{"order":"27460337702","amount":2970},{"order":"27309417766","amount":1020},{"order":"27309158246","amount":1020},{"order":"27309054566","amount":1020},{"order":"27307771942","amount":1020},{"order":"27306899942","amount":2040},{"order":"27266581350","amount":3060},{"order":"27249636582","amount":5100},{"order":"27239209510","amount":5150},{"order":"27232240614","amount":2020},{"order":"27231980262","amount":5050},{"order":"27232397414","amount":5050},{"order":"27231626022","amount":4120},{"order":"27224537510","amount":1010},{"order":"27136238886","amount":1050},{"order":"27136276518","amount":1050},{"order":"27134868582","amount":1050},{"order":"27134126886","amount":3150},{"order":"26790683558","amount":1040},{"order":"26693575462","amount":5050},{"order":"26388819174","amount":4160},{"order":"26373999526","amount":5200},{"order":"26211479910","amount":2060},{"order":"29722082086","amount":1770},{"order":"29722808550","amount":810},{"order":"29722753254","amount":567},{"order":"29722016806","amount":189},{"order":"29722015270","amount":490},{"order":"29721364070","amount":1770},{"order":"29721258726","amount":567},{"order":"29046424358","amount":597}
];

let inventory=[];
let deleteRecords=JSON.parse(localStorage.getItem('deleteRecords_V10_0')||'[]');

const saveDeleteRecords=()=>localStorage.setItem('deleteRecords_V10_0',JSON.stringify(deleteRecords));
const saveInventory = () => {
    localStorage.setItem('invoiceInventory_V10_0',JSON.stringify(inventory));
    renderStats();
};

const loadHeaderHistory=()=>JSON.parse(localStorage.getItem('headerHistory_V10_0')||'[]');
const saveHeaderHistory=h=>{
  if(!h) return; const arr=loadHeaderHistory().filter(x=>x!==h);
  arr.unshift(h); if(arr.length>10) arr.pop();
  localStorage.setItem('headerHistory_V10_0',JSON.stringify(arr));
};
function log(msg){ const el=document.getElementById('debug-log'); const t=new Date().toLocaleTimeString(); if(el) el.textContent+=`[${t}] ${msg}\n`; }

function normalize(raw){
  const map=new Map();
  (raw||[]).forEach(o=>{
    const order=String(o.order); const amount=Math.round(Number(o.amount)||0);
    const k=order+'|'+amount;
    if(!map.has(k)) map.set(k,{order,amount});
  });
  return Array.from(map.values());
}
const makeKey=o=>o.order+'|'+o.amount;

// ä»ªè¡¨ç›˜ç»Ÿè®¡æ¸²æŸ“
function renderStats() {
    const el = document.getElementById('inventory-stats');
    if (!el) return;
    
    if (!inventory || inventory.length === 0) {
        el.innerHTML = '<div style="text-align:center; padding:10px; color:#888;">ğŸ“¦ åº“å­˜ç©ºç©ºå¦‚ä¹Ÿ</div>';
        return;
    }
    
    const count = inventory.length;
    const total = inventory.reduce((a, b) => a + b.amount, 0);
    let min = 0, max = 0;
    if (count > 0) {
        min = inventory.reduce((m, p) => (p.amount < m ? p.amount : m), inventory[0].amount);
        max = inventory.reduce((m, p) => (p.amount > m ? p.amount : m), inventory[0].amount);
    }
    const fmt = (n) => n.toLocaleString();
    
    el.innerHTML = `
      <div style="font-weight:600; margin-bottom:10px; opacity:0.8;">ğŸ“Š å®æ—¶åº“å­˜ç›‘æ§</div>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-val">${fmt(total)}</span>
          <span class="stat-label">æ€»é‡‘é¢ (å…ƒ)</span>
        </div>
        <div class="stat-item">
          <span class="stat-val">${fmt(count)}</span>
          <span class="stat-label">è®¢å•æ•° (å¼ )</span>
        </div>
        <div class="stat-range">
          å•ç¬”èŒƒå›´ï¼š<b>${fmt(min)}</b> ~ <b>${fmt(max)}</b> å…ƒ
        </div>
      </div>
    `;
}

async function loadInventory(forceReset=false){
  if(!forceReset){
    const local=JSON.parse(localStorage.getItem('invoiceInventory_V10_0')||'null');
    if(local){ 
        inventory=normalize(local); 
        log(`ä»ç¼“å­˜è¯»å–ï¼š${inventory.length} æ¡`); 
        renderStats();
        return; 
    }
  }
  log(`è¯»å–å†…ç½®æºæ•°æ®ï¼šå…± ${DATA_SOURCE.length} æ¡è®°å½•...`);
  inventory=normalize(DATA_SOURCE); 
  saveInventory();
  if(forceReset){ 
    deleteRecords=[]; saveDeleteRecords(); 
    log(`å·²é‡ç½®ã€‚å»é‡åæœ‰æ•ˆåº“å­˜ï¼š${inventory.length} æ¡`); 
  }
}

function renderHeaderHistory(){
  const div=document.getElementById('header-history'); div.innerHTML='';
  loadHeaderHistory().forEach((h,i)=>{
    const wrap=document.createElement('div'); wrap.className='hdr-item';
    const txt=document.createElement('button'); txt.className='txt'; txt.textContent=h;
    txt.onclick=()=>document.getElementById('company-header').value=h;
    const del=document.createElement('button'); del.className='del'; del.textContent='âœ•';
    del.onclick=()=>{ const a=loadHeaderHistory(); a.splice(i,1); localStorage.setItem('headerHistory_V10_0',JSON.stringify(a)); renderHeaderHistory(); };
    wrap.appendChild(txt); wrap.appendChild(del); div.appendChild(wrap);
  });
}

function renderDeleteRecords(){
  const list=document.getElementById('record-list'); list.innerHTML='';
  if(deleteRecords.length === 0) {
      list.innerHTML = '<div style="padding:10px;text-align:center;color:#999">æš‚æ— åˆ é™¤è®°å½•</div>';
      return;
  }
  deleteRecords.slice(0,20).forEach((batch, batchIdx)=>{
    const total=batch.reduce((s,inv)=>s+inv.sum,0);
    const item=document.createElement('div'); item.className='record-item';
    let html = `<div class="record-title">ğŸ“„ æ‰¹æ¬¡ ${batchIdx+1}ï¼š${batch.length}å¼  / åˆè®¡ ${total}å…ƒ</div>`;
    html += `<div class="orders">`;
    batch.forEach((inv, invIdx) => {
        inv.orders.forEach((o, orderIdx) => {
           html += `
             <div class="single-order-row">
               <span>${o.order} <span style="color:#999">|</span> <b>${o.amount}</b>å…ƒ</span>
               <button class="btn-recover-one" onclick="recoverSingleOrder(${batchIdx}, ${invIdx}, ${orderIdx})">æ¢å¤</button>
             </div>
           `;
        });
    });
    html += `</div>`;
    html += `<button class="btn-recover-batch" onclick="recoverBatch(${batchIdx})">â†º æ¢å¤æ•´æ‰¹æ•°æ®</button>`;
    item.innerHTML=html;
    list.appendChild(item);
  });
}

function renderEditSearch(){
  const input = document.getElementById('search-order-input');
  const btn = document.getElementById('btn-search-order');
  const area = document.getElementById('edit-result-area');
  btn.onclick = () => {
    const val = input.value.trim();
    if(!val) return alert('è¯·è¾“å…¥è®¢å•å·');
    area.innerHTML = '';
    const found = inventory.filter(o => o.order.includes(val));
    if(found.length === 0){
      area.innerHTML = '<div style="color:red;padding:10px 0;">æœªæ‰¾åˆ°ç›¸å…³è®¢å•ã€‚</div>';
      return;
    }
    found.forEach(item => {
      const div = document.createElement('div'); div.className = 'edit-row';
      div.innerHTML = `<span>è®¢å•: ${item.order} <br> åŸé¢: ${item.amount}</span><input type="number" value="${item.amount}"><button class="btn-update">ä¿å­˜</button>`;
      const newValInput = div.querySelector('input');
      const saveBtn = div.querySelector('.btn-update');
      saveBtn.onclick = () => {
        const newAmt = Math.round(Number(newValInput.value));
        if(!newAmt || newAmt <= 0) return alert('é‡‘é¢å¿…é¡»å¤§äº0');
        const oldKey = makeKey(item);
        const idx = inventory.findIndex(x => makeKey(x) === oldKey);
        if(idx === -1) { alert('æ•°æ®å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°æœç´¢'); return; }
        inventory[idx].amount = newAmt;
        inventory = normalize(inventory);
        saveInventory();
        alert(`è®¢å• ${item.order} é‡‘é¢å·²æ›´æ–°ä¸º ${newAmt}`);
        log(`ä¿®æ­£æ•°æ®ï¼šè®¢å• ${item.order} ä» ${item.amount} -> ${newAmt}`);
        btn.click(); 
      };
      area.appendChild(div);
    });
  };
}

/* Actions */
window.recoverSingleOrder = function(batchIdx, invIdx, orderIdx) {
    const batch = deleteRecords[batchIdx]; if(!batch) return;
    const inv = batch[invIdx]; if(!inv) return;
    const order = inv.orders[orderIdx]; if(!order) return;
    if(!inventory.find(x => makeKey(x) === makeKey(order))) { inventory.push(order); }
    inventory = normalize(inventory);
    inv.orders.splice(orderIdx, 1);
    inv.sum = inv.orders.reduce((a, b) => a + b.amount, 0);
    if(inv.orders.length === 0) { batch.splice(invIdx, 1); }
    if(batch.length === 0) { deleteRecords.splice(batchIdx, 1); }
    saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    log(`å·²å•ç‹¬æ¢å¤è®¢å•ï¼š${order.order}`);
};

window.recoverBatch = function(batchIdx) {
    const rec = deleteRecords.splice(batchIdx, 1)[0];
    if(rec) {
        rec.forEach(inv => inv.orders.forEach(o => {
            if(!inventory.find(x => makeKey(x) === makeKey(o))) inventory.push(o);
        }));
        inventory = normalize(inventory);
        saveDeleteRecords(); saveInventory(); renderDeleteRecords();
        log(`å·²æ¢å¤æ•´æ‰¹æ•°æ® (æ‰¹æ¬¡ ${batchIdx+1})`);
    }
};

function bindAccordion(h,c){ h.addEventListener('click',()=>{ const open=c.style.display==='block'; c.style.display=open?'none':'block'; h.classList.toggle('open',!open); }); }
function shuffleArray(array) {
  let currentIndex = array.length,  randomIndex;
  while (currentIndex != 0) {
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
  }
  return array;
}

/* Algorithm */
function selectOrdersByDP(target, maxSingle, allowApprox, onlyHigher, minOrderStr, maxOrderStr, usePool){
  let pool = usePool.slice();
  if(minOrderStr) pool = pool.filter(o => o.order >= minOrderStr);
  if(maxOrderStr) pool = pool.filter(o => o.order <= maxOrderStr);
  if(maxSingle > 0) pool = pool.filter(o => o.amount <= maxSingle);
  if(pool.length === 0) return null;
  const hi = allowApprox ? (target+500) : target;
  const dp = Array(hi+1).fill(null); dp[0]={cnt:0,picks:[]};
  for(let i=0;i<pool.length;i++){
    const a=pool[i].amount|0;
    for(let s=hi;s>=a;s--){
      if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
        dp[s]={cnt:dp[s-a].cnt+1,picks:dp[s-a].picks.concat(i)};
      }
    }
  }
  if(dp[target]) return {sum:target, orders: dp[target].picks.map(i=>pool[i])};
  if(!allowApprox) return null;
  for(let d=1; d<=500; d++){
    const sUp = target + d;
    const sDn = target - d;
    if(onlyHigher){
      if(sUp<=hi && dp[sUp]) return {sum:sUp, orders: dp[sUp].picks.map(i=>pool[i])};
    }else{
      if(sDn>=0 && dp[sDn]) return {sum:sDn, orders: dp[sDn].picks.map(i=>pool[i])};
      if(sUp<=hi && dp[sUp]) return {sum:sUp, orders: dp[sUp].picks.map(i=>pool[i])};
    }
  }
  return null;
}

function splitWithCapBacktrack(selectedOrders, minS, maxS, maxSame){
  if(!(minS>0) && !(maxS>0)){
    const total=selectedOrders.reduce((a,o)=>a+o.amount,0);
    return [{sum:total, orders:selectedOrders.slice()}];
  }
  const lo=(minS>0)?minS:1;
  const hi=(maxS>0)?maxS:selectedOrders.reduce((a,o)=>a+o.amount,0);
  let avail=selectedOrders.slice();
  const capMap=new Map();
  const keyOf=o=>o.order+'|'+o.amount;
  function bestSubsetInRange(avail, lo, hi){
    const maxSum=Math.min(hi, avail.reduce((a,o)=>a+o.amount,0));
    const dp=Array(maxSum+1).fill(null); dp[0]={cnt:0,picks:[]};
    for(let i=0;i<avail.length;i++){
      const a=avail[i].amount|0;
      for(let s=maxSum;s>=a;s--){
        if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
          dp[s]={cnt:dp[s-a].cnt+1,picks:dp[s-a].picks.concat(i)};
        }
      }
    }
    for(let s=maxSum; s>=Math.max(1,lo); s--){
      if(dp[s] && s>=lo && s<=hi) return {sum:s, picks:dp[s].picks};
    }
    return null;
  }
  function genCandidates(av,limit=8){
    const cands=[];
    const step=Math.max(1, Math.floor((hi-lo)/24));
    for(let s=Math.min(hi,av.reduce((a,o)=>a+o.amount,0)); s>=lo; s-=step){
      if(isFinite(maxSame) && (capMap.get(s)||0) >= maxSame) continue;
      const probe=bestSubsetInRange(av, s, s);
      if(probe){ cands.push(probe); if(cands.length>=limit) break; }
    }
    if(cands.length===0){
      const p=bestSubsetInRange(av, lo, hi);
      if(p && (!isFinite(maxSame) || (capMap.get(p.sum)||0) < maxSame)) cands.push(p);
    }
    return cands;
  }
  const memo=new Set();
  function sig(av){
    const hist=new Map(); av.forEach(o=>hist.set(o.amount,(hist.get(o.amount)||0)+1));
    const hm=Array.from(hist.entries()).sort((a,b)=>a[0]-b[0]).map(([k,v])=>k+':'+v).join(',');
    const cm=Array.from(capMap.entries()).sort((a,b)=>a[0]-b[0]).map(([k,v])=>k+':'+v).join(',');
    return hm+'|'+cm;
  }
  function dfs(av){
    if(av.length===0) return [];
    const signature=sig(av); if(memo.has(signature)) return null;
    const cands=genCandidates(av,8);
    for(const cand of cands){
      if(!cand) continue;
      const pick=cand.picks.map(i=>av[i]);
      const used=new Set(pick.map(keyOf));
      const rest=av.filter(o=>!used.has(keyOf(o)));
      capMap.set(cand.sum,(capMap.get(cand.sum)||0)+1);
      const sub=dfs(rest);
      if(sub){ return [{sum:cand.sum,orders:pick}, ...sub]; }
      capMap.set(cand.sum,capMap.get(cand.sum)-1);
      if(capMap.get(cand.sum)===0) capMap.delete(cand.sum);
    }
    memo.add(signature);
    return null;
  }
  return dfs(avail);
}

function splitFixedCount(selectedOrders, minS, maxS, k){
  const lo=(minS>0)?minS:1;
  const total=selectedOrders.reduce((a,o)=>a+o.amount,0);
  const hi=(maxS>0)?maxS:total;
  const base=selectedOrders.map((o,idx)=>({...o,__uid:'u'+idx}));
  function bestSubsetInRangeEx(avail, lo, hi){
    const maxSum=Math.min(hi, avail.reduce((a,o)=>a+o.amount,0));
    const dp=Array(maxSum+1).fill(null); dp[0]={cnt:0,picks:[]};
    for(let i=0;i<avail.length;i++){
      const a=avail[i].amount|0;
      for(let s=maxSum;s>=a;s--){
        if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
          dp[s]={cnt:dp[s-a].cnt+1,picks:dp[s-a].picks.concat(i)};
        }
      }
    }
    for(let s=maxSum; s>=Math.max(1,lo); s--){
      if(dp[s] && s>=lo && s<=hi) return {sum:s,picks:dp[s].picks};
    }
    return null;
  }
  const memo=new Map();
  function sig(remT,k,avail){
    const hist=new Map(); avail.forEach(x=>hist.set(x.amount,(hist.get(x.amount)||0)+1));
    const hm=[...hist.entries()].sort((a,b)=>a[0]-b[0]).map(([v,c])=>v+':'+c).join(',');
    return remT+'|'+k+'|'+hm;
  }
  function dfs(remT,k,avail){
    const key=sig(remT,k,avail); if(memo.has(key)) return memo.get(key);
    if(k===1){
      const dp=Array(remT+1).fill(null); dp[0]=[];
      for(let i=0;i<avail.length;i++){
        const a=avail[i].amount|0;
        for(let s=remT;s>=a;s--){
          if(dp[s-a]!=null && dp[s]==null){ dp[s]=dp[s-a].concat(i); }
        }
      }
      if(!dp[remT]){ memo.set(key,null); return null; }
      const pick=dp[remT].map(i=>avail[i]);
      const sum=remT;
      if(sum<lo || sum>hi){ memo.set(key,null); return null; }
      const res=[{sum,orders:pick.map(x=>({order:x.order,amount:x.amount}))}];
      memo.set(key,res); return res;
    }
    const upper=Math.min(hi, remT-(k-1)*lo);
    const lower=Math.max(lo, remT-(k-1)*hi);
    if(lower>upper){ memo.set(key,null); return null; }
    const first=bestSubsetInRangeEx(avail, lower, upper);
    if(!first){ memo.set(key,null); return null; }
    const trySubs=[];
    for(let s=first.sum; s>=lower && trySubs.length<8; s--){
      const t=bestSubsetInRangeEx(avail, s, s);
      if(t) trySubs.push(t);
    }
    for(const cand of trySubs){
      const pick=cand.picks.map(i=>avail[i]);
      const used=new Set(pick.map(x=>x.__uid));
      const rest=avail.filter(x=>!used.has(x.__uid));
      const sub=dfs(remT-cand.sum, k-1, rest);
      if(sub){ const res=[{sum:cand.sum,orders:pick.map(x=>({order:x.order,amount:x.amount}))}, ...sub]; memo.set(key,res); return res; }
    }
    memo.set(key,null); return null;
  }
  return dfs(total, k, base);
}
function tryCompute(target, minS, maxS, maxSame, invoiceCount, allowApprox, onlyHigher, filterMin, filterMax, pool){
  const pickRes = selectOrdersByDP(target, maxS||0, allowApprox, onlyHigher, filterMin, filterMax, pool);
  if(!pickRes) return null;
  const selected = pickRes.orders;
  const totalSel = pickRes.sum;
  if(invoiceCount && invoiceCount>0){
    const fixed = splitFixedCount(selected, minS||0, maxS||0, invoiceCount);
    if(fixed && fixed.reduce((a,inv)=>a+inv.sum,0)===totalSel) return fixed;
    return null;
  }else{
    const invs = splitWithCapBacktrack(selected, minS||0, maxS||0, isFinite(maxSame)?maxSame:Infinity);
    if(invs && invs.reduce((a,inv)=>a+inv.sum,0)===totalSel) return invs;
    return null;
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadInventory();
  renderHeaderHistory();
  renderDeleteRecords();
  renderEditSearch(); 
  
  bindAccordion(document.getElementById('debug-acc-header'),document.getElementById('debug-acc-content'));
  bindAccordion(document.getElementById('del-acc-header'),document.getElementById('record-list'));
  bindAccordion(document.getElementById('edit-acc-header'),document.getElementById('edit-acc-content'));
  bindAccordion(document.getElementById('backup-acc-header'),document.getElementById('backup-acc-content'));

  document.getElementById('reset-btn').onclick=async()=>{
    if(confirm('ç¡®å®šè¦é‡ç½®å¹¶æ¢å¤åˆå§‹æ•°æ®å—ï¼Ÿ(åˆ é™¤è®°å½•å°†è¢«æ¸…ç©ºï¼Œæ‰‹åŠ¨ä¿®æ”¹ä¹Ÿå°†ä¸¢å¤±)')){
      await loadInventory(true);
      renderDeleteRecords();
      alert('åº“å­˜å·²é‡ç½®ã€‚');
    }
  };

  let lastInv=null;
  document.getElementById('combine-btn').onclick=async ()=>{
    const outEl=document.getElementById('result-output');
    const logEl=document.getElementById('debug-log');
    const loadEl=document.getElementById('loading-overlay');
    const retryTxt=document.getElementById('retry-count');
    outEl.textContent=''; logEl.textContent='';
    const tgt=+document.getElementById('target-input').value;
    if(!tgt) return alert('è¯·è¾“å…¥ç›®æ ‡é‡‘é¢');
    const minS=+document.getElementById('min-single').value||0;
    const maxS=+document.getElementById('max-single').value||0;
    if(minS && maxS && minS>maxS) return alert('ä¸‹é™ä¸å¯å¤§äºä¸Šé™');
    const msc=+document.getElementById('max-same-count').value||Infinity;
    const ic =+document.getElementById('invoice-count').value||0;
    const allowApprox=document.getElementById('allow-approx').checked;
    const onlyHigher=document.getElementById('only-higher').checked;
    const header=document.getElementById('company-header').value.trim();
    const filterOrderMin = document.getElementById('filter-order-min').value.trim();
    const filterOrderMax = document.getElementById('filter-order-max').value.trim();
    saveHeaderHistory(header); renderHeaderHistory();
    const maxRetries = (isFinite(msc) || ic > 0) ? 2000 : 1; 
    let attempt = 0; let success = null;
    loadEl.style.display = 'flex';
    setTimeout(async () => {
        const startTime = Date.now();
        while(attempt < maxRetries){
            attempt++;
            retryTxt.textContent = `${attempt} / ${maxRetries}`;
            let currentPool = inventory.slice();
            if(attempt > 1) shuffleArray(currentPool);
            const res = tryCompute(tgt, minS, maxS, msc, ic, allowApprox, onlyHigher, filterOrderMin, filterOrderMax, currentPool);
            if(res){ success = res; break; }
            if(attempt % 50 === 0) await new Promise(r => setTimeout(r, 0));
        }
        loadEl.style.display = 'none';
        const duration = ((Date.now() - startTime)/1000).toFixed(2);
        log(`è®¡ç®—å®Œæˆï¼šè€—æ—¶ ${duration}ç§’ï¼Œå°è¯•æ¬¡æ•° ${attempt}`);
        if(!success){
            outEl.textContent=`æ— æ³•ç»„åˆå‡ºæ»¡è¶³æ¡ä»¶çš„é‡‘é¢ (å·²å°è¯• ${attempt} ç§éšæœºç»„åˆ)ã€‚`;
        } else {
            const out=[];
            success.forEach((inv,i)=>{
                out.push(`å‘ç¥¨${i+1}ï¼š${inv.sum}å…ƒ${inv.orders.length>1?'ï¼ˆç›¸å…³è®¢å•åˆå¹¶ï¼‰':''}`);
                inv.orders.forEach(o=> out.push(`è®¢å•å·ï¼š${o.order}ï¼Œé‡‘é¢ï¼š${o.amount}å…ƒ`));
                out.push('');
            });
            if(header) out.push(header,'');
            out.push('ä¸éœ€è¦å¤‡æ³¨','568881753@qq.com');
            outEl.textContent = out.join('\n');
            lastInv=success;
            document.getElementById('confirm-delete-btn').classList.remove('hidden');
        }
    }, 50);
  };
  document.getElementById('confirm-delete-btn').onclick=()=>{
    if(!lastInv) return;
    deleteRecords.unshift(lastInv);
    const removeSet=new Set(lastInv.flatMap(inv=>inv.orders.map(makeKey)));
    inventory=inventory.filter(o=>!removeSet.has(makeKey(o)));
    saveDeleteRecords(); 
    saveInventory(); 
    renderDeleteRecords();
    document.getElementById('record-list').style.display='block';
    document.getElementById('confirm-delete-btn').classList.add('hidden');
  };
  document.getElementById('copy-btn').onclick=()=>{
    navigator.clipboard.writeText(document.getElementById('result-output').textContent);
    alert('ç»“æœå·²å¤åˆ¶');
  };

  /* å¤‡ä»½é€»è¾‘ */
  document.getElementById('backup-btn').onclick = () => {
    const data = {
      inventory: localStorage.getItem('invoiceInventory_V10_0'),
      deleteRecords: localStorage.getItem('deleteRecords_V10_0'),
      headerHistory: localStorage.getItem('headerHistory_V10_0')
    };
    const jsonStr = JSON.stringify(data);
    
    try {
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `invoice_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    } catch(e) {
        console.error("ä¸‹è½½å¤±è´¥ï¼Œè½¬ä¸ºæ–‡æœ¬å±•ç¤º", e);
    }

    const txtArea = document.getElementById('backup-text');
    const areaDiv = document.getElementById('backup-area');
    txtArea.value = jsonStr;
    areaDiv.style.display = 'block';
    document.getElementById('backup-acc-content').style.display='block';
    alert('å¤‡ä»½æ•°æ®å·²ç”Ÿæˆï¼\n\nå¦‚æœæµè§ˆå™¨æ²¡æœ‰è‡ªåŠ¨ä¸‹è½½æ–‡ä»¶ï¼Œè¯·å…¨é€‰å¤åˆ¶ä¸‹æ–¹çš„æ–‡æœ¬æ¡†å†…å®¹ï¼Œå‘é€åˆ°æ–°è®¾å¤‡å³å¯ã€‚');
  };

  document.getElementById('restore-btn').onclick = () => {
    document.getElementById('restore-input').click();
  };
  document.getElementById('restore-input').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        if (data.inventory) localStorage.setItem('invoiceInventory_V10_0', data.inventory);
        if (data.deleteRecords) localStorage.setItem('deleteRecords_V10_0', data.deleteRecords);
        if (data.headerHistory) localStorage.setItem('headerHistory_V10_0', data.headerHistory);
        alert('æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å°†ç«‹å³åˆ·æ–°...');
        location.reload();
      } catch (err) {
        alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ­£ç¡®ã€‚');
      }
    };
    reader.readAsText(file);
  };
});
</script>
</body>
</html>