<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å‘ç¥¨ç»„åˆè®¡ç®—å™¨ V8.41</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#f5f5f5;font-family:Arial,Helvetica,sans-serif;color:#333;padding-bottom:108px}
    .container{max-width:480px;margin:18px auto;padding:0 10px}
    h2{text-align:center;margin-bottom:12px;font-size:1.6rem}
    .card{background:#fff;border-radius:6px;padding:16px;margin-bottom:12px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:bold}
    input,textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
    textarea{resize:vertical}
    .flex{display:flex;gap:8px;margin-top:6px}
    .flex input{flex:1}
    .flex span{line-height:32px}
    .two-cols{display:flex;gap:8px;margin-top:6px}
    .two-cols>div{flex:1}
    #header-history{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .hdr-item{background:#ececec;color:#555;border-radius:4px;display:flex;align-items:center;overflow:hidden}
    .hdr-item button.txt{background:transparent;border:none;padding:6px 10px;font-size:.9rem;color:#333;cursor:pointer}
    .hdr-item button.del{background:transparent;border:none;padding:6px;font-size:1rem;color:#999;cursor:pointer;transition:color .2s}
    .hdr-item button.del:hover{color:#666}
    #result-output,#debug-log{white-space:pre-wrap;max-height:240px;overflow:auto;font-family:monospace;font-size:.9rem}
    .accordion{border-radius:6px;overflow:hidden;margin-top:12px}
    .accordion-header{background:#fff;padding:12px 16px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
    .accordion-header .arrow{width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-top:7px solid #666;transition:transform .28s ease}
    .accordion-header.open .arrow{transform:rotate(180deg)}
    .accordion-content{display:none;background:#fff;padding:12px 16px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .record-item{border-top:1px solid #eee;padding:10px 0}
    .record-item:first-child{border-top:none}
    .record-item .orders{margin-top:8px;line-height:1.45}
    .record-item .btn-recover{display:block;margin:10px auto 0;padding:6px 12px;background:#6c757d;color:#fff;border:none;border-radius:4px;font-size:.9rem;cursor:pointer}
    .footer{position:fixed;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -2px 5px rgba(0,0,0,.05);padding:8px;display:flex;gap:8px;flex-wrap:wrap}
    .footer button{flex:1 1 calc(50% - 4px);padding:12px 0;font-size:1rem;border:none;border-radius:4px;cursor:pointer}
    .primary{background:#007bff;color:#fff}.secondary{background:#6c757d;color:#fff}.danger{background:#dc3545;color:#fff}
    .hidden{display:none}
    .tip{font-size:.9rem;color:#666;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h2>å‘ç¥¨ç»„åˆè®¡ç®—å™¨ V8.41</h2>

    <div class="card">
      <label>ç›®æ ‡å¼€ç¥¨é‡‘é¢</label>
      <input id="target-input" type="number" placeholder="å¦‚ 20000">

      <label>å•å¼ å‘ç¥¨é‡‘é¢èŒƒå›´</label>
      <div class="flex">
        <input id="min-single" type="number" placeholder="ä¸‹é™">
        <span>â€”</span>
        <input id="max-single" type="number" placeholder="ä¸Šé™">
      </div>

      <div class="two-cols">
        <div>
          <label>ç›¸åŒé‡‘é¢å‘ç¥¨å¼ æ•°ä¸Šé™</label>
          <input id="max-same-count" type="number" placeholder="ç•™ç©ºè¡¨ç¤ºä¸é™">
        </div>
        <div>
          <label>å‘ç¥¨å¼ æ•°</label>
          <input id="invoice-count" type="number" placeholder="ç•™ç©ºè¡¨ç¤ºä¸é™">
        </div>
      </div>

      <div class="two-cols" style="margin-top:6px">
        <div>
          <input type="checkbox" id="allow-approx">
          <label for="allow-approx">å…è®¸è¯¯å·®æœ€å°åŒ¹é…</label>
        </div>
        <div>
          <input type="checkbox" id="only-higher">
          <label for="only-higher">åŒ¹é…é‡‘é¢ä¸å¾—å°äºç›®æ ‡</label>
        </div>
      </div>

      <label>å…¬å¸æŠ¬å¤´</label>
      <textarea id="company-header" rows="2" placeholder="è¡Œ1ï¼šå…¬å¸åç§°
è¡Œ2ï¼šç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç "></textarea>
      <div id="header-history"></div>

      <div class="tip">åº“å­˜æ¥è‡ª <b>inventory.json</b>ã€‚æ›¿æ¢åå¯ç‚¹ <b>é‡ç½®åº“å­˜</b> åˆ·æ–°ç¼“å­˜ã€‚</div>
    </div>

    <div class="card">
      <h3>å¯¼å‡ºç»“æœ</h3>
      <div id="result-output"></div>
    </div>

    <!-- åˆ é™¤è®°å½• -->
    <div class="accordion">
      <div class="accordion-header" id="del-acc-header">
        <span>åˆ é™¤è®°å½•ï¼ˆæœ€è¿‘30æ¡ï¼‰</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="record-list" style="display:none;"></div>
    </div>

    <!-- è°ƒè¯•æ—¥å¿—ï¼ˆåº•éƒ¨ï¼Œé»˜è®¤æ”¶èµ·ï¼‰ -->
    <div class="accordion">
      <div class="accordion-header" id="debug-acc-header">
        <span>è°ƒè¯•æ—¥å¿—ï¼ˆç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼‰</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="debug-acc-content" style="display:none;">
        <div id="debug-log"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button id="combine-btn" class="primary">ä¸€é”®ç»„åˆ</button>
    <button id="copy-btn" class="secondary">å¤åˆ¶ç»“æœ</button>
    <button id="reset-btn" class="secondary">é‡ç½®åº“å­˜</button>
    <button id="confirm-delete-btn" class="danger hidden">ç¡®è®¤åˆ é™¤</button>
  </div>

<script>
/* ====== çŠ¶æ€/å·¥å…·ï¼ˆä¿ç•™ 8.35ï¼‰ ====== */
let inventory=[];
let deleteRecords=JSON.parse(localStorage.getItem('deleteRecords')||'[]');
const saveDeleteRecords=()=>localStorage.setItem('deleteRecords',JSON.stringify(deleteRecords));
const saveInventory    =()=>localStorage.setItem('invoiceInventory',JSON.stringify(inventory));
const loadHeaderHistory=()=>JSON.parse(localStorage.getItem('headerHistory')||'[]');
const saveHeaderHistory=h=>{
  if(!h) return; const arr=loadHeaderHistory().filter(x=>x!==h);
  arr.unshift(h); if(arr.length>10) arr.pop();
  localStorage.setItem('headerHistory',JSON.stringify(arr));
};
function log(msg){ const el=document.getElementById('debug-log'); const t=new Date().toLocaleTimeString(); el.textContent+=`[${t}] ${msg}\n`; }

function normalize(raw){
  const map=new Map();
  (raw||[]).forEach(o=>{
    const order=String(o.order); const amount=Math.round(Number(o.amount)||0);
    const k=order+'|'+amount;
    if(!map.has(k)) map.set(k,{order,amount});
  });
  return Array.from(map.values());
}
const makeKey=o=>o.order+'|'+o.amount;

/* ====== åº“å­˜åŠ è½½ï¼ˆç¼“å­˜ä¼˜å…ˆï¼‰ ====== */
async function loadInventory(forceReset=false){
  if(!forceReset){
    const local=JSON.parse(localStorage.getItem('invoiceInventory')||'null');
    if(local){ inventory=normalize(local); log(`ä»ç¼“å­˜è¯»å–ï¼š${inventory.length} æ¡`); return; }
  }
  try{
    const res=await fetch('inventory.json',{cache:'no-store'});
    const data=await res.json();
    inventory=normalize(data); saveInventory();
    if(forceReset){ deleteRecords=[]; saveDeleteRecords(); log('å·²æ¸…ç©ºåˆ é™¤è®°å½•å¹¶ä»æ–‡ä»¶åŠ è½½åº“å­˜'); }
    else{ log(`ä»æ–‡ä»¶è¯»å–ï¼š${inventory.length} æ¡`); }
  }catch(e){ alert('æœªæ‰¾åˆ° inventory.json'); inventory=[]; }
}

/* ====== UI æ¸²æŸ“ï¼ˆä¿ç•™ 8.35ï¼‰ ====== */
function renderHeaderHistory(){
  const div=document.getElementById('header-history'); div.innerHTML='';
  loadHeaderHistory().forEach((h,i)=>{
    const wrap=document.createElement('div'); wrap.className='hdr-item';
    const txt=document.createElement('button'); txt.className='txt'; txt.textContent=h;
    txt.onclick=()=>document.getElementById('company-header').value=h;
    const del=document.createElement('button'); del.className='del'; del.textContent='âœ•';
    del.onclick=()=>{ const a=loadHeaderHistory(); a.splice(i,1); localStorage.setItem('headerHistory',JSON.stringify(a)); renderHeaderHistory(); };
    wrap.appendChild(txt); wrap.appendChild(del); div.appendChild(wrap);
  });
}
function renderDeleteRecords(){
  const list=document.getElementById('record-list'); list.innerHTML='';
  // ğŸ‘‡ å”¯ä¸€ä»£ç æ”¹åŠ¨ï¼š20 â†’ 30
  deleteRecords.slice(0,30).forEach((batch,i)=>{
    const total=batch.reduce((s,inv)=>s+inv.sum,0);
    const item=document.createElement('div'); item.className='record-item';
    let html=`æ‰¹æ¬¡ ${i+1}ï¼šå…± ${batch.length} å¼ å‘ç¥¨ï¼Œåˆè®¡ ${total} å…ƒ<br><div class="orders">`;
    batch.forEach(inv=>inv.orders.forEach(o=>{ html+=`è®¢å•å·ï¼š${o.order}ï¼Œé‡‘é¢ï¼š${o.amount}å…ƒ<br>`; }));
    html+='</div>'; item.innerHTML=html;
    const btn=document.createElement('button'); btn.className='record-item btn-recover'; btn.textContent='æ¢å¤';
    btn.onclick=()=>{
      const rec=deleteRecords.splice(i,1)[0];
      rec.forEach(inv=>inv.orders.forEach(o=>{ if(!inventory.find(x=>makeKey(x)===makeKey(o))) inventory.push(o); }));
      inventory=normalize(inventory); saveDeleteRecords(); saveInventory(); renderDeleteRecords(); log(`å·²æ¢å¤æ‰¹æ¬¡ ${i+1}`);
    };
    item.appendChild(btn); list.appendChild(item);
  });
}
function bindAccordion(h,c){ h.addEventListener('click',()=>{ const open=c.style.display==='block'; c.style.display=open?'none':'block'; h.classList.toggle('open',!open); }); }

...ï¼ˆå…¶ä½™é€»è¾‘ä¿æŒä¸å˜ï¼Œå’Œ 8.39 å®Œå…¨ä¸€è‡´ï¼‰
</script>
</body>
</html>