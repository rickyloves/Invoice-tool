<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>发票组合计算器 V7.1</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* 重置与基础 */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background:#f5f5f5; color:#333; }
    .container { max-width: 480px; margin: auto; padding: 10px; }
    h2 { font-size: 1.5rem; margin-bottom: 12px; text-align: center; }
    label { display: block; margin-top: 12px; font-weight: bold; }
    input, textarea { width: 100%; padding: 8px; margin-top:6px; border:1px solid #ccc; border-radius:4px; }
    textarea { resize: vertical; }
    .range-row, .two-cols { display: flex; gap: 8px; margin-top:6px; }
    .range-row input { flex:1; }
    .range-row span { line-height: 32px; }
    .two-cols > div { flex:1; }
    /* 卡片式分组 */
    .card { background:#fff; border-radius:6px; padding:12px; margin-bottom:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    /* 按钮 */
    .btn { padding:10px; border:none; border-radius:4px; font-size:1rem; cursor:pointer; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-secondary { background:#6c757d; color:#fff; }
    .btn-hidden { display:none; }
    /* 结果区 */
    #result-output { height:200px; background:#fff; padding:12px; border-radius:6px; overflow:auto; white-space:pre-wrap; }
    /* 删除记录折叠 */
    .accordion { background:#fff; border-radius:6px; margin-bottom:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    .accordion-header { padding:12px; cursor:pointer; font-weight:bold; position: relative; }
    .accordion-header::after {
      content: '▾';
      position: absolute; right:12px; top:50%; transform: translateY(-50%);
      transition: transform .2s;
    }
    .accordion-header.open::after { transform: translateY(-50%) rotate(180deg); }
    .accordion-content { display:none; padding:0 12px 12px; }
    .record-item { border-top:1px solid #eee; padding:8px 0; }
    .record-item:first-child { border-top:none; }
    .record-item p { margin:4px 0; }
    .record-item .btn-restore {
      background:#888; color:#fff; margin-top:6px;
      padding:6px 12px; border-radius:4px;
    }
    /* 底部固定区域 */
    .footer { position: fixed; bottom: 0; left: 0; right: 0; background:#fff; padding:8px; box-shadow:0 -2px 5px rgba(0,0,0,0.05); display: flex; gap: 8px; }
    .footer .btn { flex:1; margin-top:0; }
  </style>
</head>
<body>

  <div class="container">
    <h2>发票组合计算器 V7.1</h2>

    <div class="card">
      <label>目标开票金额</label>
      <input id="target-input" type="number" placeholder="如 20000">

      <label>单张发票金额范围</label>
      <div class="range-row">
        <input id="min-single" type="number" placeholder="下限">
        <span>—</span>
        <input id="max-single" type="number" placeholder="上限">
      </div>

      <div class="two-cols">
        <div>
          <label>相同金额发票张数上限</label>
          <input id="max-same-count" type="number" placeholder="留空表示不限">
        </div>
        <div>
          <label>发票张数</label>
          <input id="invoice-count" type="number" placeholder="留空表示不限">
        </div>
      </div>

      <label>公司抬头</label>
      <textarea id="company-header" rows="2" placeholder="行1：公司名称\n行2：统一社会信用代码"></textarea>
      <div id="header-history"></div>
    </div>

    <div class="card">
      <h3>导出结果</h3>
      <div id="result-output"></div>
    </div>

    <div class="accordion" id="delete-accordion">
      <div class="accordion-header">删除记录（最近10条）</div>
      <div class="accordion-content" id="record-list"></div>
    </div>
  </div>

  <div class="footer">
    <button id="combine-btn" class="btn btn-primary">一键组合</button>
    <button id="copy-btn" class="btn btn-secondary">复制结果</button>
    <button id="confirm-delete-btn" class="btn btn-secondary btn-hidden">确认删除</button>
  </div>

<script>
// ===== 默认库存，替换为实际数据 =====
const defaultInventory = [
  {order:'23910608992',amount:1600},
  {order:'17938227424',amount:800},
  // …你的全部数据…
];

// ===== 持久化加载 =====
let inventory = JSON.parse(localStorage.getItem('invoiceInventory')) || defaultInventory.slice();
let deleteRecords = JSON.parse(localStorage.getItem('deleteRecords')) || [];

// ===== 存储函数 =====
const saveInventory = ()=> localStorage.setItem('invoiceInventory', JSON.stringify(inventory));
const saveDeleteRecords = ()=> localStorage.setItem('deleteRecords', JSON.stringify(deleteRecords));
const loadHeaderHistory = ()=> JSON.parse(localStorage.getItem('headerHistory')||'[]');
const saveHeaderHistory = h=>{
  if(!h) return;
  let hist = loadHeaderHistory().filter(x=>x!==h);
  hist.unshift(h);
  if(hist.length>10) hist.pop();
  localStorage.setItem('headerHistory', JSON.stringify(hist));
};

// ===== 渲染抬头历史 =====
function renderHeaderHistory(){
  const div = document.getElementById('header-history');
  div.innerHTML = '';
  loadHeaderHistory().forEach(h=>{
    const btn = document.createElement('button');
    btn.textContent = h;
    btn.className = 'btn btn-secondary';
    btn.style.margin = '4px 6px 0 0';
    btn.onclick = ()=>document.getElementById('company-header').value = h;
    div.appendChild(btn);
  });
}

// ===== 渲染删除记录（仅最近10条） =====
function renderDeleteRecords(){
  const list = document.getElementById('record-list');
  list.innerHTML = '';
  deleteRecords.slice(0, 10).forEach((batch,i)=>{
    const item = document.createElement('div');
    item.className = 'record-item';

    // 计算本批次总金额
    const total = batch.reduce((sum, inv)=> sum + inv.sum, 0);

    // 标题
    const pTitle = document.createElement('p');
    pTitle.innerHTML = `批次 ${i+1}，共 ${batch.length} 张发票，合计 ${total} 元`;
    item.appendChild(pTitle);

    // 列出所有订单
    batch.forEach(inv=>{
      inv.orders.forEach(o=>{
        const p = document.createElement('p');
        p.innerHTML = `订单号：${o.order}，金额：${o.amount} 元`;
        item.appendChild(p);
      });
    });

    // 恢复按钮
    const btn = document.createElement('button');
    btn.textContent = '恢复';
    btn.className = 'btn-restore';
    btn.onclick = ()=>{
      const rec = deleteRecords.splice(i,1)[0];
      rec.forEach(inv=>inv.orders.forEach(o=>inventory.push(o)));
      saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    };
    item.appendChild(btn);
    list.appendChild(item);
  });
}

// ===== 格式化金额 =====
function formatAmt(x){ return parseFloat(x).toString() + '元'; }

// ===== 渲染结果 =====
function renderResult(list, header){
  const out = [];
  list.forEach((inv,i)=>{
    out.push(`发票${i+1}：${inv.sum}元${inv.orders.length>1?'（相关订单合并）':''}`);
    inv.orders.forEach(o=> out.push(`订单号：${o.order}，金额：${o.amount}元`));
    out.push('');
  });
  if(header) out.push(header,'');
  out.push('不需要备注','568881753@qq.com');
  document.getElementById('result-output').textContent = out.join('\n');
}

// ===== DP 子集最少订单 =====
function subsetMinOrders(target, arr){
  const dp = Array(target+1).fill(null);
  dp[0] = { cnt:0, picks:[] };
  for(let i=0; i<arr.length; i++){
    const a = arr[i].amount;
    for(let s=target; s>=a; s--){
      if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
        dp[s] = { cnt: dp[s-a].cnt+1, picks: dp[s-a].picks.concat(i) };
      }
    }
  }
  return dp[target];
}

// ===== fewInvoices：全局最少订单 & 固定张数逻辑 =====
function fewInvoices(target, minS, maxS, maxSame, invoiceCount){
  const usable = inventory
    .filter(o=>o.amount>=minS && o.amount<=maxS)
    .filter(o=> isFinite(maxSame)
      ? inventory.filter(x=>x.amount===o.amount).length <= maxSame
      : true
    );
  if(!usable.length) return null;

  const memo = new Map();
  function dfs(remT, k, avail){
    const key = `${remT}|${k}|${avail.length}`;
    if(memo.has(key)) return memo.get(key);
    if(k===1){
      const rec = subsetMinOrders(remT, avail);
      if(!rec) return null;
      const pick = rec.picks.map(i=>avail[i]);
      return [ { orders: pick, sum: remT } ];
    }
    for(let i=0; i<avail.length; i++){
      const rec = subsetMinOrders(avail[i].amount, avail.slice(i));
      if(!rec) continue;
      const pick = rec.picks.map(j=>avail[i+j]);
      const sumPick = pick.reduce((a,o)=>a+o.amount,0);
      if(sumPick<minS||sumPick>maxS) continue;
      const rest = avail.filter(o=>!pick.includes(o));
      const sub = dfs(remT-sumPick, k-1, rest);
      if(sub){
        const res = [ { orders: pick, sum: sumPick }, ...sub ];
        memo.set(key, res);
        return res;
      }
    }
    memo.set(key, null);
    return null;
  }

  if(!invoiceCount){
    const rec = subsetMinOrders(target, usable);
    if(!rec) return null;
    const pick = rec.picks.map(i=>usable[i]);
    return [ { orders: pick, sum: target } ];
  }
  return dfs(target, invoiceCount, usable);
}

// ===== 事件绑定 & 手风琴 =====
document.addEventListener('DOMContentLoaded',()=>{
  // 手风琴切换
  const acc = document.getElementById('delete-accordion');
  acc.querySelector('.accordion-header').onclick = ()=>{
    const hdr = acc.querySelector('.accordion-header');
    const content = acc.querySelector('.accordion-content');
    const isOpen = content.style.display === 'block';
    content.style.display = isOpen ? 'none' : 'block';
    hdr.classList.toggle('open', !isOpen);
  };

  // 初始渲染
  renderHeaderHistory();
  renderDeleteRecords();

  // 组合按钮
  let lastInv = null;
  document.getElementById('combine-btn').onclick = ()=>{
    const tgt = +document.getElementById('target-input').value;
    if(!tgt) return alert('请输入目标金额');
    const minS = +document.getElementById('min-single').value || 0;
    const maxS = +document.getElementById('max-single').value || tgt;
    if(minS>maxS) return alert('下限不可大于上限');
    const msc = +document.getElementById('max-same-count').value || Infinity;
    const ic  = +document.getElementById('invoice-count').value || 0;
    const header = document.getElementById('company-header').value.trim();
    saveHeaderHistory(header);
    renderHeaderHistory();

    const invs = fewInvoices(tgt, minS, maxS, msc, ic);
    if(!invs) return alert('无法组合出满足条件的金额');
    lastInv = invs;
    renderResult(invs, header);
    document.getElementById('confirm-delete-btn').classList.remove('btn-hidden');
  };

  // 确认删除
  document.getElementById('confirm-delete-btn').onclick = ()=>{
    if(!lastInv) return;
    deleteRecords.unshift(lastInv);
    saveDeleteRecords();
    deleteRecords = deleteRecords.slice(0, 1000); // 保留后端记录，不限制显示
    lastInv.forEach(inv=>inv.orders.forEach(o=>{
      const idx = inventory.findIndex(x=>x.order===o.order&&x.amount===o.amount);
      if(idx>-1) inventory.splice(idx,1);
    }));
    saveInventory();
    renderDeleteRecords();
    document.getElementById('confirm-delete-btn').classList.add('btn-hidden');
  };

  // 复制结果
  document.getElementById('copy-btn').onclick = ()=>{
    navigator.clipboard.writeText(document.getElementById('result-output').textContent);
    alert('已复制到粘贴板');
  };
});
</script>
</body>
</html>
