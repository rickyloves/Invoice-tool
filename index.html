<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>发票组合计算器 V6.39</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin:10px; }
    h2 { margin-top:0; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, textarea, select, button { width:100%; padding:6px; margin-top:4px; box-sizing:border-box; }
    .record-item { border:1px solid #ccc; padding:8px; margin-top:6px; }
    #result-output { height:200px; white-space:pre-wrap; }
    #header-history button { margin:2px 4px 2px 0; padding:4px 8px; font-size:90%; }
  </style>
</head>
<body>

  <h2>发票组合计算器 V6.39</h2>

  <label>目标开票金额（元）：</label>
  <input id="target-input" placeholder="如 20000">

  <label>单张发票金额上限：</label>
  <input id="max-single" type="number">

  <label>相同金额发票张数上限：</label>
  <input id="max-same-count" type="number">

  <label>组合逻辑：</label>
  <select id="logic-select">
    <option value="few">订单数尽量少</option>
    <option value="diverse">发票金额尽量分散</option>
  </select>

  <label>公司抬头：</label>
  <textarea id="company-header" rows="2" placeholder="行1：公司名称
行2：统一社会信用代码"></textarea>
  <div id="header-history"></div>

  <button id="combine-btn">一键组合</button>
  <button id="copy-btn">复制结果</button>
  <button id="confirm-delete-btn" style="display:none;">确认删除</button>

  <h3>导出结果</h3>
  <textarea id="result-output" readonly></textarea>

  <h3>删除记录（最近20条）</h3>
  <div id="record-list"></div>

<script>
// ====== 默认库存，请替换为你的完整 Excel 数据 ======
const defaultInventory = [
  {order:'23910608992',amount:1600.00},
  {order:'17938227424',amount:800.00},
  // …填入所有订单数据…
];

// ====== 持久化加载 ======
let inventory = JSON.parse(localStorage.getItem('invoiceInventory')) || defaultInventory.slice();
let deleteRecords = JSON.parse(localStorage.getItem('deleteRecords')) || [];

// ====== 存储 ======
function saveInventory(){ localStorage.setItem('invoiceInventory', JSON.stringify(inventory)); }
function saveDeleteRecords(){ localStorage.setItem('deleteRecords', JSON.stringify(deleteRecords)); }

// ====== 抬头历史 ======
function loadHeaderHistory(){ return JSON.parse(localStorage.getItem('headerHistory')||'[]'); }
function saveHeaderHistory(h){ if(!h) return; let hist = loadHeaderHistory().filter(x=>x!==h); hist.unshift(h); if(hist.length>20) hist.pop(); localStorage.setItem('headerHistory', JSON.stringify(hist)); }
function renderHeaderHistory(){
  const div = document.getElementById('header-history'); div.innerHTML='';
  loadHeaderHistory().forEach(h=>{
    const b=document.createElement('button'); b.textContent=h;
    b.onclick=()=>document.getElementById('company-header').value=h;
    div.appendChild(b);
  });
}

// ====== 渲染删除记录 ======
function renderDeleteRecords(){
  const c=document.getElementById('record-list'); c.innerHTML='';
  deleteRecords.forEach((batch,i)=>{
    const dv=document.createElement('div'); dv.className='record-item';
    let html=`批次 ${i+1}，共 ${batch.length} 张发票<br>`;
    batch.forEach((inv,j)=>{
      html+=`发票${j+1}：${inv.sum.toFixed(2)}${inv.orders.length>1?'（相关订单合并）':''}<br>`;
      inv.orders.forEach(o=>html+=`&nbsp;&nbsp;订单号：${o.order}，金额：${o.amount.toFixed(2)}<br>`);
    });
    dv.innerHTML=html;
    const btn=document.createElement('button'); btn.textContent='恢复';
    btn.onclick=()=>{
      const rec=deleteRecords.splice(i,1)[0];
      rec.forEach(inv=>inv.orders.forEach(o=>inventory.push(o)));
      saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    };
    dv.appendChild(btn);
    c.appendChild(dv);
  });
}

// ====== 渲染结果 ======
function renderResult(list, header){
  const lines=[];
  list.forEach((inv,i)=>{
    lines.push(`发票${i+1}：${inv.sum.toFixed(2)}${inv.orders.length>1?'（相关订单合并）':''}`);
    inv.orders.forEach(o=>lines.push(`订单号：${o.order}，金额：${o.amount.toFixed(2)}`));
    lines.push('');
  });
  if(header){ lines.push(header,''); }
  lines.push('不需要备注','568881753@qq.com');
  document.getElementById('result-output').value = lines.join('\n');
}

// ====== 枚举 k 张的组合 ======
function combineK(orders,target,k,maxSingle,maxSame){
  const res=[],path=[],cnt={};
  function dfs(start,sum){
    if(sum>target||path.length>k) return;
    if(path.length===k){
      if(sum===target) res.push(path.slice());
      return;
    }
    for(let i=start;i<orders.length;i++){
      const o=orders[i];
      if(o.amount>maxSingle) continue;
      cnt[o.amount]=(cnt[o.amount]||0)+1;
      if(cnt[o.amount]>maxSame){ cnt[o.amount]--; continue; }
      path.push(i);
      dfs(i+1,sum+o.amount);
      path.pop();
      cnt[o.amount]--;
    }
  }
  dfs(0,0);
  return res.map(idxs=>idxs.map(i=>orders[i]));
}

// ====== few 模式 ======
function fewInvoices(target,maxSingle,maxSame){
  const dp=Array(target+1).fill(null); dp[0]={count:0,orders:[]};
  const usable=inventory.filter(o=>o.amount<=maxSingle)
    .filter((o,i,arr)=>arr.filter(x=>x.amount===o.amount).length<=maxSame);
  usable.forEach((o,idx)=>{
    for(let s=target;s>=o.amount;s--){
      if(dp[s-o.amount]&&(dp[s]===null||dp[s-o.amount].count+1<dp[s].count)){
        dp[s]={count:dp[s-o.amount].count+1,orders:dp[s-o.amount].orders.concat(idx)};
      }
    }
  });
  if(!dp[target]) return null;
  return dp[target].orders.map(idx=>({orders:[usable[idx]],sum:usable[idx].amount}));
}

// ====== diverse 模式改进 ======
function diverseInvoices(target,maxSingle,maxSame){
  // 1. 用 few 确定 k
  const few = fewInvoices(target,maxSingle,maxSame);
  if(!few) return null;
  const k = few.length;
  // 2. 筛选可用
  let usable = inventory.filter(o=>o.amount<=maxSingle);
  if(maxSame!==Infinity){
    const freq={};
    usable = usable.filter(o=>{ freq[o.amount]=(freq[o.amount]||0)+1; return freq[o.amount]<=maxSame; });
  }
  // 3. 枚举 k 组合，选最大化最小差值
  const combos = combineK(usable,target,k,maxSingle,maxSame);
  if(!combos.length) return null;
  let bestCombo=null, bestDiff=-1;
  combos.forEach(arr=>{
    const vals=arr.map(o=>o.amount).sort((a,b)=>a-b);
    let md=Infinity; for(let i=1;i<vals.length;i++) md=Math.min(md,vals[i]-vals[i-1]);
    if(md>bestDiff){ bestDiff=md; bestCombo=arr; }
  });
  return bestCombo.map(o=>({orders:[o],sum:o.amount}));
}

// ====== 总入口 ======
function previewInvoices(target,maxSingle,maxSame,logic){
  return logic==='few'
    ? fewInvoices(target,maxSingle,maxSame)
    : diverseInvoices(target,maxSingle,maxSame);
}

// ====== 事件绑定 ======
let lastInv=null;
document.addEventListener('DOMContentLoaded',()=>{
  renderHeaderHistory(); renderDeleteRecords();

  document.getElementById('combine-btn').onclick=()=>{
    const tgt=parseFloat(document.getElementById('target-input').value);
    if(!tgt) return alert('请输入目标金额');
    const ms=parseFloat(document.getElementById('max-single').value)||tgt;
    const msc=parseInt(document.getElementById('max-same-count').value)||Infinity;
    const logic=document.getElementById('logic-select').value;
    const header=document.getElementById('company-header').value.trim();
    saveHeaderHistory(header); renderHeaderHistory();

    const invs=previewInvoices(tgt,ms,msc,logic);
    if(!invs) return alert('无法组合出满足条件的金额');
    lastInv=invs; renderResult(invs,header);
    document.getElementById('confirm-delete-btn').style.display='inline-block';
  };

  document.getElementById('confirm-delete-btn').onclick=()=>{
    if(!lastInv) return;
    deleteRecords.unshift(lastInv);
    if(deleteRecords.length>20) deleteRecords.pop();
    lastInv.forEach(inv=>inv.orders.forEach(o=>{
      const i=inventory.findIndex(x=>x.order===o.order&&x.amount===o.amount);
      if(i>-1) inventory.splice(i,1);
    }));
    saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    document.getElementById('confirm-delete-btn').style.display='none';
  };

  document.getElementById('copy-btn').onclick=()=>{
    navigator.clipboard.writeText(document.getElementById('result-output').value);
  };
});
</script>

</body>
</html>
