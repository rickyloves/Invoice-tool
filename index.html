<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>发票组合计算器 V8.3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#f5f5f5;font-family:Arial,sans-serif;color:#333;padding-bottom:80px}
    .container{max-width:480px;margin:20px auto;padding:0 10px}
    h2{text-align:center;margin-bottom:12px;font-size:1.6rem}
    .card{background:#fff;border-radius:6px;padding:16px;margin-bottom:12px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:bold}
    input,textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
    textarea{resize:vertical}
    .flex{display:flex;gap:8px;margin-top:6px}
    .flex input{flex:1}
    .flex span{line-height:32px}
    .two-cols{display:flex;gap:8px;margin-top:6px}
    .two-cols>div{flex:1}
    #header-history{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .chip{display:inline-flex;align-items:center;border-radius:16px;padding:6px 10px;background:#ececec;color:#555}
    .chip .x{margin-left:8px;cursor:pointer;color:#999}
    .chip .x:hover{color:#666}
    #result-output{white-space:pre-wrap;max-height:220px;overflow:auto;font-family:monospace}
    .accordion{border-radius:6px;overflow:hidden}
    .accordion-header{background:#fff;padding:12px 16px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
    .arrow{width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-top:6px solid #666;transition:transform .25s}
    .accordion-header.open .arrow{transform:rotate(180deg)}
    .accordion-content{display:none;background:#fff;padding:12px 16px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .record-item{border-top:1px solid #eee;padding:10px 0}
    .record-item:first-child{border-top:none}
    .record-item .orders{margin-top:6px;line-height:1.4}
    .record-item .btn{display:inline-block;margin-top:8px;padding:6px 12px;border:none;border-radius:4px;background:#6c757d;color:#fff;cursor:pointer}
    .footer{position:fixed;left:0;right:0;bottom:0;background:#fff;padding:8px;box-shadow:0 -2px 5px rgba(0,0,0,.05);display:flex;gap:8px}
    .footer button{flex:1;padding:12px 0;font-size:1rem;border:none;border-radius:4px;cursor:pointer}
    .primary{background:#007bff;color:#fff}
    .secondary{background:#6c757d;color:#fff}
    .danger{background:#dc3545;color:#fff}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <h2>发票组合计算器 V8.3</h2>

    <div class="card">
      <label>目标开票金额</label>
      <input id="target-input" type="number" placeholder="如 20000">

      <label>单张发票金额范围</label>
      <div class="flex">
        <input id="min-single" type="number" placeholder="下限">
        <span>—</span>
        <input id="max-single" type="number" placeholder="上限">
      </div>

      <div class="two-cols">
        <div>
          <label>相同金额发票张数上限</label>
          <input id="max-same-count" type="number" placeholder="留空表示不限">
        </div>
        <div>
          <label>发票张数</label>
          <input id="invoice-count" type="number" placeholder="留空表示不限">
        </div>
      </div>

      <label>公司抬头</label>
      <textarea id="company-header" rows="2" placeholder="行1：公司名称
行2：统一社会信用代码"></textarea>
      <div id="header-history"></div>
    </div>

    <div class="card">
      <h3>导出结果</h3>
      <div id="result-output"></div>
    </div>

    <div class="accordion">
      <div class="accordion-header">
        <span>删除记录（最近 10 条）</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="record-list"></div>
    </div>
  </div>

  <div class="footer">
    <button id="combine-btn" class="primary">一键组合</button>
    <button id="copy-btn" class="secondary">复制结果</button>
    <button id="confirm-delete-btn" class="danger hidden">确认删除</button>
  </div>

<script>
/** ===== 数据持久化 ===== */
const defaultInventory = [
  {order:'23910608992',amount:1600},
  {order:'17938227424',amount:800},
  // …替换为你的完整库存…
];
let inventory = JSON.parse(localStorage.getItem('invoiceInventory')) || defaultInventory.slice();
let deleteRecords = JSON.parse(localStorage.getItem('deleteRecords')) || [];
const saveInventory = () => localStorage.setItem('invoiceInventory', JSON.stringify(inventory));
const saveDeleteRecords = () => localStorage.setItem('deleteRecords', JSON.stringify(deleteRecords));
const loadHeaderHistory = () => JSON.parse(localStorage.getItem('headerHistory')||'[]');
const saveHeaderHistory = (h) => {
  if(!h) return;
  let arr = loadHeaderHistory().filter(x=>x!==h);
  arr.unshift(h); if(arr.length>10) arr.pop();
  localStorage.setItem('headerHistory', JSON.stringify(arr));
};

/** ===== UI 渲染 ===== */
function renderHeaderHistory(){
  const box = document.getElementById('header-history');
  box.innerHTML = '';
  loadHeaderHistory().forEach((h,i)=>{
    const chip = document.createElement('div'); chip.className='chip';
    const txt = document.createElement('span'); txt.textContent=h;
    txt.style.cursor='pointer'; txt.onclick=()=>document.getElementById('company-header').value=h;
    const x = document.createElement('span'); x.textContent='✕'; x.className='x';
    x.onclick=()=>{ let arr=loadHeaderHistory(); arr.splice(i,1);
      localStorage.setItem('headerHistory', JSON.stringify(arr)); renderHeaderHistory(); };
    chip.appendChild(txt); chip.appendChild(x); box.appendChild(chip);
  });
}

function renderDeleteRecords(){
  const list = document.getElementById('record-list');
  list.innerHTML = '';
  const recent = deleteRecords.slice(0,10); // 仅显示最近 10 条
  recent.forEach((batch,i)=>{
    const item = document.createElement('div'); item.className='record-item';
    const invCnt = batch.length;
    const total = batch.reduce((s,inv)=>s+inv.sum,0);
    let html = `批次 ${i+1}：共 ${invCnt} 张发票，合计 ${total} 元<br><div class="orders">`;
    batch.forEach(inv=>{
      inv.orders.forEach(o=>{
        html += `订单号：${o.order}，金额：${o.amount}元<br>`;
      });
    });
    html += '</div>';
    item.innerHTML = html;
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='恢复';
    btn.onclick = ()=>{
      const rec = deleteRecords.splice(i,1)[0];
      rec.forEach(inv=>inv.orders.forEach(o=>inventory.push(o)));
      saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    };
    item.appendChild(btn); list.appendChild(item);
  });
}

/** ===== DP 工具：计算到 cap 的最少订单 dp，并可回溯 ===== */
function buildDP_MinOrders(arr, cap){
  const dp = Array(cap+1).fill(null);
  dp[0] = {cnt:0, prev:-1, idx:-1};
  for(let i=0;i<arr.length;i++){
    const a = arr[i].amount|0;
    for(let s=cap; s>=a; s--){
      if(dp[s-a] && (!dp[s] || dp[s-a].cnt+1 < dp[s].cnt)){
        dp[s] = {cnt: dp[s-a].cnt+1, prev: s-a, idx:i};
      }
    }
  }
  return dp;
}
function backtrackPicks(dp, s, avail){
  const picks = []; let cur = s;
  while(cur>0){
    const node = dp[cur]; if(!node) return null;
    picks.push(node.idx); cur = node.prev;
  }
  return picks.map(i=>avail[i]);
}

/** ===== 选择 [low,high] 区间内“最少订单”的一张发票组合 ===== */
function bestOneInvoice(avail, low, high){
  if(high<=0) return null;
  const dp = buildDP_MinOrders(avail, high);
  // 取区间内“订单数最少，其次金额更大”的方案
  let bestS = -1, bestCnt = Infinity;
  for(let s=Math.max(0,low); s<=high; s++){
    const node = dp[s]; if(!node) continue;
    if(node.cnt < bestCnt || (node.cnt===bestCnt && s>bestS)){
      bestCnt = node.cnt; bestS = s;
    }
  }
  if(bestS<low) return null;
  const picks = backtrackPicks(dp, bestS, avail);
  return {sum: bestS, picks};
}

/** ===== 主求解：few + 先决条件（范围、相同金额上限、张数） ===== */
function solveFew(target, minS, maxS, maxSame, invoiceCount){
  // 注意：不再按“范围”去过滤订单！范围只约束“每张发票合并金额”
  const usable = inventory.slice(); // 全量订单

  // 未设置范围 & 未设置张数 => 单张总额：用最少订单直接凑 target
  if(!(minS>0) && !(maxS>0) && !invoiceCount){
    const dp = buildDP_MinOrders(usable, target);
    if(!dp[target]) return null;
    return [{sum:target, orders: backtrackPicks(dp, target, usable)}];
  }

  const sameLimit = isFinite(maxSame) && maxSame>0 ? maxSame : Infinity;
  const countMap = new Map(); // 发票金额 -> 已使用张数

  function dfs(remT, k, avail){
    // k==0
    if(k===0) return remT===0 ? [] : null;

    // 可行性剪枝
    const minNeed = (minS>0?minS:0)*k;
    const maxAllow = (maxS>0?maxS:remT)*k;
    if(remT < minNeed || remT > maxAllow) return null;

    // 最后一张：必须恰好等于 remT 且满足范围/相同金额
    if(k===1){
      const s = remT;
      if((minS>0 && s<minS) || (maxS>0 && s>maxS)) return null;
      if(countMap.get(s)||0 >= sameLimit) return null;
      const dp = buildDP_MinOrders(avail, s);
      if(!dp[s]) return null;
      const pick = backtrackPicks(dp, s, avail);
      return [{sum:s, orders:pick}];
    }

    // 本张的可行区间：确保剩余 k-1 张仍有可行空间
    const hi = Math.min(maxS>0?maxS:remT, remT - (k-1)*(minS>0?minS:0));
    const lo = Math.max(minS>0?minS:0, remT - (k-1)*(maxS>0?maxS:remT));
    if(hi<lo) return null;

    // 先求出一张“订单数最少”的候选，再根据订单数从少到多尝试多个 s
    const dp = buildDP_MinOrders(avail, hi);
    // 收集区间内所有可达 s
    const candidates = [];
    for(let s=lo; s<=hi; s++){
      const node = dp[s]; if(!node) continue;
      if((countMap.get(s)||0) < sameLimit){
        candidates.push({s, cnt:node.cnt});
      }
    }
    if(!candidates.length) return null;
    // 优先“订单数更少”，其次“金额更大”（让剩余更容易）
    candidates.sort((a,b)=> a.cnt-b.cnt || b.s-a.s);

    for(const cand of candidates){
      const pick = backtrackPicks(dp, cand.s, avail);
      if(!pick) continue;
      // 从可用订单中移除
      const rest = avail.slice();
      pick.forEach(o=>{
        const idx = rest.findIndex(x=>x.order===o.order && x.amount===o.amount);
        if(idx>-1) rest.splice(idx,1);
      });
      // 相同金额计数
      countMap.set(cand.s, (countMap.get(cand.s)||0)+1);
      const sub = dfs(remT - cand.s, k-1, rest);
      if(sub){
        return [{sum:cand.s, orders:pick}, ...sub];
      }
      // 回溯
      countMap.set(cand.s, countMap.get(cand.s)-1);
    }
    return null;
  }

  // 确定要尝试的张数 k
  const tryK = [];
  if(invoiceCount && invoiceCount>0){
    tryK.push(invoiceCount|0);
  }else{
    if(!(minS>0) || !(maxS>0)){
      // 只有一侧或没有范围：从 1 张开始往上试到一个合理上界
      for(let k=1;k<=20;k++) tryK.push(k);
    }else{
      const kMin = Math.ceil(target / maxS);
      const kMax = Math.floor(target / minS);
      for(let k=kMin;k<=Math.max(kMin,kMax);k++) tryK.push(k);
    }
  }

  for(const k of tryK){
    const res = dfs(target, k, usable);
    if(res) return res;
  }
  return null;
}

/** ===== 事件绑定 ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  renderHeaderHistory();
  renderDeleteRecords();

  const accHeader = document.querySelector('.accordion-header');
  const accCont = document.querySelector('.accordion-content');
  accHeader.onclick = ()=>{
    const open = accCont.style.display==='block';
    accCont.style.display = open?'none':'block';
    accHeader.classList.toggle('open', !open);
  };

  let lastInv = null;

  document.getElementById('combine-btn').onclick = ()=>{
    const tgt = +document.getElementById('target-input').value;
    if(!tgt) return alert('请输入目标金额');

    const minS = +document.getElementById('min-single').value || 0;
    const maxS = +document.getElementById('max-single').value || 0;
    if(minS>0 && maxS>0 && minS>maxS) return alert('下限不可大于上限');

    const msc = +document.getElementById('max-same-count').value || Infinity;
    const ic  = +document.getElementById('invoice-count').value || 0;

    const header = document.getElementById('company-header').value.trim();
    saveHeaderHistory(header); renderHeaderHistory();

    const invs = solveFew(tgt, minS, maxS, msc, ic);
    if(!invs) return alert('无法组合出满足条件的金额');

    lastInv = invs;
    const lines = [];
    invs.forEach((inv,i)=>{
      lines.push(`发票${i+1}：${inv.sum}元${inv.orders.length>1?'（相关订单合并）':''}`);
      inv.orders.forEach(o=>lines.push(`订单号：${o.order}，金额：${o.amount}元`));
      lines.push('');
    });
    if(header) lines.push(header,'');
    lines.push('不需要备注','568881753@qq.com');
    document.getElementById('result-output').textContent = lines.join('\n');
    document.getElementById('confirm-delete-btn').classList.remove('hidden');
  };

  document.getElementById('confirm-delete-btn').onclick = ()=>{
    if(!lastInv) return;
    deleteRecords.unshift(lastInv);
    // 只显示最近 10 条，但数据不裁剪
    saveDeleteRecords();
    lastInv.forEach(inv=>inv.orders.forEach(o=>{
      const idx = inventory.findIndex(x=>x.order===o.order && x.amount===o.amount);
      if(idx>-1) inventory.splice(idx,1);
    }));
    saveInventory(); renderDeleteRecords();
    document.getElementById('confirm-delete-btn').classList.add('hidden');
  };

  document.getElementById('copy-btn').onclick = ()=>{
    navigator.clipboard.writeText(document.getElementById('result-output').textContent);
    alert('结果已复制');
  };
});
</script>
</body>
</html>
