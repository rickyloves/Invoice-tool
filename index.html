<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>发票组合计算器 V4.1</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    h2 { margin-top: 20px; }
    label { display:block; margin:8px 0 4px; }
    input, textarea, select, button { width:100%; padding:6px; margin-bottom:10px; box-sizing:border-box; }
    button { cursor:pointer; background:#f0f0f0; border:1px solid #ccc; }
    .record-item { border:1px solid #ddd; padding:6px; margin:6px 0; }
    #result-output { white-space: pre-wrap; height:200px; }
  </style>
</head>
<body>

  <h2>发票组合计算器 V4.1</h2>

  <h2>设置参数</h2>
  <label for="target-input">目标开票金额（元）：</label>
  <input id="target-input" placeholder="如 20000">

  <label for="max-single">单张发票金额上限（留空不限）：</label>
  <input id="max-single" type="number">

  <label for="max-same-count">相同金额发票张数上限（留空不限）：</label>
  <input id="max-same-count" type="number">

  <label for="logic-select">组合逻辑：</label>
  <select id="logic-select">
    <option value="large">优先使用大金额订单</option>
    <option value="disperse">优先组合金额分散</option>
  </select>

  <label for="company-header">公司抬头：</label>
  <textarea id="company-header" rows="2" placeholder="行1：公司名称
行2：统一社会信用代码"></textarea>

  <button id="combine-btn">一键组合</button>
  <button id="copy-btn">复制结果</button>
  <button id="confirm-delete-btn" style="display:none;">确认删除</button>

  <h2>导出结果</h2>
  <textarea id="result-output" readonly></textarea>

  <h2>删除记录（最近20条）</h2>
  <div id="record-list"></div>

  <script>
  // —— 预加载的库存数据（请保持这段为你的 Excel 数据生成的数组） ——
  let inventory = [
    {order: '32378666746', amount: 930.00},
    {order: '32290784698', amount: 930.00},
    {order: '32205652026', amount: 930.00},
    // … 其它订单 …
  ];
  // ——————————————————————————————————————————————

  let deleteRecords = [], lastInvoices = [];

  function subsetMaxSum(orders, limitCents, maxSame) {
    const dp = new Int32Array(limitCents+1).fill(-1),
          prev = new Int32Array(limitCents+1).fill(-1);
    dp[0] = -2;
    let candidates = [];
    if (isFinite(maxSame)) {
      const map = {};
      for (const o of orders) {
        const k = Math.round(o.amount * 100);
        map[k] = (map[k] || 0) + 1;
        if (map[k] <= maxSame) candidates.push(o);
      }
    } else candidates = orders.slice();

    for (let i=0; i<candidates.length; i++) {
      const cents = Math.round(candidates[i].amount * 100);
      for (let s=limitCents; s>=cents; s--) {
        if (dp[s] === -1 && dp[s-cents] !== -1) {
          dp[s] = i; prev[s] = s - cents;
        }
      }
    }
    for (let s=limitCents; s>=1; s--) {
      if (dp[s] !== -1) {
        const subset = []; let cur = s;
        while (cur > 0) {
          const idx = dp[cur];
          subset.push(candidates[idx]);
          cur = prev[cur];
        }
        return subset;
      }
    }
    return null;
  }

  function previewInvoices(target, maxSingle, maxSame, useLarge) {
    let rem = target, temp = inventory.slice(), invoices = [];
    temp.sort((a,b)=> useLarge? b.amount - a.amount : a.amount - b.amount);
    while (rem > 0) {
      const limit = Math.min(rem, maxSingle);
      let pick = temp.find(o=> o.amount <= limit);
      let subset, sum;
      if (pick) { subset = [pick]; sum = pick.amount; }
      else { subset = subsetMaxSum(temp, Math.round(limit*100), maxSame); if (!subset) break; sum = subset.reduce((a,o)=>a+o.amount,0); }
      invoices.push(subset);
      subset.forEach(o=>{
        const i = temp.findIndex(x=>x.order === o.order && x.amount===o.amount);
        if (i > -1) temp.splice(i,1);
      });
      rem = +(rem - sum).toFixed(2);
    }
    return { invoices, remaining: rem };
  }

  function renderResult(preview, header) {
    let txt = '';
    preview.invoices.forEach((subset, i)=>{
      const sum = subset.reduce((a,o)=>a+o.amount,0).toFixed(2);
      txt += `发票${i+1}：${sum}${subset.length>1?'（相关订单合并）':''}
`;
      subset.forEach(o=> txt += `订单号：${o.order}，金额：${o.amount.toFixed(2)}}
`);
      txt += '
';
    });
    if (preview.remaining > 0)
      txt += `剩余未组合金额：${preview.remaining.toFixed(2)}

`;
    if (header) txt += `${header}

`;
    txt += '不需要备注
568881753@qq.com';
    document.getElementById('result-output').value = txt;
  }

  function updateDeleteRecords() {
    const container = document.getElementById('record-list');
    container.innerHTML = '';
    deleteRecords.forEach((rec, idx)=>{
      let html = `批次${idx+1}：共${rec.invoices.length}张发票<br>`;
      rec.invoices.forEach((sub,j)=>{
        const sum = sub.reduce((a,o)=>a+o.amount,0).toFixed(2);
        html += `发票${j+1}：${sum}${sub.length>1?'（相关订单合并）':''}<br>`;
        sub.forEach(o=> html += `· ${o.order} ¥${o.amount.toFixed(2)}<br>`);
      });
      const div = document.createElement('div');
      div.className = 'record-item';
      div.innerHTML = html;
      container.appendChild(div);
    });
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('combine-btn').onclick = ()=>{
      const tgt = parseFloat(document.getElementById('target-input').value),
            maxSingleRaw = document.getElementById('max-single').value,
            maxSingle = maxSingleRaw? parseFloat(maxSingleRaw) : tgt,
            maxSameRaw = document.getElementById('max-same-count').value,
            maxSame = maxSameRaw? parseInt(maxSameRaw) : Infinity,
            useLarge = document.getElementById('logic-select').value === 'large',
            header = document.getElementById('company-header').value.trim();
      if (isNaN(tgt)||tgt<=0){alert('请输入有效目标金额');return;}
      const prev = previewInvoices(tgt, maxSingle, maxSame, useLarge);
      lastInvoices = prev.invoices;
      renderResult(prev, header);
      document.getElementById('confirm-delete-btn').style.display = prev.invoices.length ? 'block' : 'none';
    };

    document.getElementById('confirm-delete-btn').onclick = ()=>{
      if (!lastInvoices.length) return;
      deleteRecords.unshift({ invoices: lastInvoices });
      if (deleteRecords.length>20) deleteRecords.pop();
      lastInvoices.forEach(sub=> sub.forEach(o =>{
        const idx = inventory.findIndex(x=>x.order===o.order && x.amount===o.amount);
        if(idx>-1) inventory.splice(idx,1);
      }));
      updateDeleteRecords();
      document.getElementById('confirm-delete-btn').style.display='none';
    };

    document.getElementById('copy-btn').onclick = ()=>{
      navigator.clipboard.writeText(document.getElementById('result-output').value)
        .then(()=>alert('已复制结果'));
    };

    updateDeleteRecords();
  });
  </script>

</body>
</html>
