<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>发票组合计算器 V3.4</title>
<style>
body { font-family: Arial, sans-serif; margin: 10px; padding: 0; }
h2 { margin-top: 20px; }
input, textarea, button, select { width: 100%; margin: 5px 0; padding: 8px; box-sizing: border-box; }
label { display: block; margin-top: 10px; }
button { cursor: pointer; background-color: #f0f0f0; border: 1px solid #ccc; }
.record-item { border: 1px solid #ddd; padding: 5px; margin: 5px 0; }
</style>
</head>
<body>

<h2>发票组合计算器 V3.4</h2>

<h2>设置参数</h2>
<label>目标开票金额（元）：</label>
<input type="text" id="target-input" placeholder="如 20000">
<label>单张发票金额上限：</label>
<input type="number" id="max-single" placeholder="不限">
<label>相同金额发票张数上限：</label>
<input type="number" id="max-same-count" placeholder="不限">
<label>组合逻辑：</label>
<select id="logic-select">
  <option value="large">优先使用大金额订单</option>
  <option value="disperse">优先组合金额分散</option>
</select>
<label>公司抬头：</label>
<textarea id="company-header" rows="2" placeholder="行1：公司名称&#10;行2：统一社会信用代码"></textarea>

<button id="combine-btn">一键组合</button>

<!-- 删除记录 -->
<h2>删除记录（最近20条）</h2>
<div id="record-list"></div>

<!-- 导出结果 -->
<h2>导出结果</h2>
<textarea id="result-output" rows="10" readonly style="white-space: pre-wrap;"></textarea>

<!-- 内置 SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
// 初始库存（从 Excel 预加载）
let inventory = [
  // 请确保这里被替换成你的订单数据
  {order: '32378666746', amount: 930.00},
  {order: '32290784698', amount: 930.00},
  {order: '32205652026', amount: 930.00},
  // ... (省略其他订单)
];
let deleteRecords = [];

// 回溯算法
function findCombination(target, orders, maxSame, maxSingle, useLarge) {
  const sorted = orders.slice().sort((a,b)=> useLarge? b.amount - a.amount : a.amount - b.amount);
  let best = null;
  function backtrack(start, current, sum) {
    if (sum === target) {
      if (!best || current.length < best.length) best = current.slice();
      return;
    }
    if (sum > target) return;
    if (best && current.length >= best.length) return;
    for (let i = start; i < sorted.length; i++) {
      const o = sorted[i];
      if (!isNaN(maxSingle) && o.amount > maxSingle) continue;
      const sameCnt = current.filter(x=>x.amount === o.amount).length;
      if (!isNaN(maxSame) && sameCnt >= maxSame) continue;
      current.push(o);
      backtrack(i + 1, current, sum + o.amount);
      current.pop();
    }
  }
  backtrack(0, [], 0);
  return best;
}

// 更新删除记录列表
function updateRecordList() {
  const container = document.getElementById('record-list');
  container.innerHTML = '';
  deleteRecords.forEach((rec, idx) => {
    const div = document.createElement('div');
    div.className = 'record-item';
    div.innerHTML = `发票${idx+1}：${rec.target}，包含${rec.orders.length}笔订单 <button data-idx="${idx}">恢复</button>`;
    container.appendChild(div);
  });
  container.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', function() {
      const i = parseInt(this.getAttribute('data-idx'));
      const rec = deleteRecords[i];
      inventory = inventory.concat(rec.orders);
      deleteRecords.splice(i, 1);
      updateRecordList();
    });
  });
}

// 一键组合
document.getElementById('combine-btn').addEventListener('click', function() {
  const tgtVal = document.getElementById('target-input').value.trim();
  const tgt = parseFloat(tgtVal);
  if (isNaN(tgt)) {
    alert('请输入有效的目标金额');
    return;
  }
  const maxSingle = parseFloat(document.getElementById('max-single').value.trim());
  const maxSameRaw = document.getElementById('max-same-count').value.trim();
  const maxSame = maxSameRaw ? parseInt(maxSameRaw) : NaN;
  const logic = document.getElementById('logic-select').value;
  const useLarge = logic === 'large';
  const header = document.getElementById('company-header').value.trim();
  let resultText = '';

  const combo = findCombination(tgt, inventory, maxSame, maxSingle, useLarge);
  if (combo) {
    // 发票条目
    resultText += `发票1：${tgt}\n`;
    if (combo.length > 1) {
      resultText += '（相关订单合并）\n';
    }
    combo.forEach(o => {
      resultText += `订单号：${o.order}，金额：${o.amount.toFixed(2)}\n`;
    });
    resultText += '\n';
    // 移除已用订单，记录删除
    inventory = inventory.filter(o => !combo.includes(o));
    deleteRecords.unshift({target: tgt, orders: combo});
    if (deleteRecords.length > 20) deleteRecords.pop();
  } else {
    resultText += `发票1：${tgt} —— 无法组合出满足条件的金额\n\n`;
  }

  // 添加抬头和尾部
  if (header) {
    resultText += `${header}\n\n`;
  }
  resultText += '不需要备注\n请发至邮箱：example@example.com';
  document.getElementById('result-output').value = resultText;

  updateRecordList();
});

// 页面加载时初始化展示
document.addEventListener('DOMContentLoaded', function() {
  updateRecordList();
});
</script>

</body>
</html>
