<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>发票组合计算器 V8.31</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#f5f5f5;font-family:Arial,Helvetica,sans-serif;color:#333;padding-bottom:100px}
    .container{max-width:480px;margin:18px auto;padding:0 10px}
    h2{text-align:center;margin-bottom:12px;font-size:1.6rem}
    .card{background:#fff;border-radius:6px;padding:16px;margin-bottom:12px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    label{display:block;margin-top:12px;font-weight:bold}
    input,textarea{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
    textarea{resize:vertical}
    .flex{display:flex;gap:8px;margin-top:6px}
    .flex input{flex:1}
    .flex span{line-height:32px}
    .two-cols{display:flex;gap:8px;margin-top:6px}
    .two-cols>div{flex:1}
    #header-history{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .hdr-item{background:#ececec;color:#555;border-radius:4px;display:flex;align-items:center;overflow:hidden}
    .hdr-item button.txt{background:transparent;border:none;padding:6px 10px;font-size:.9rem;color:#333;cursor:pointer}
    .hdr-item button.del{background:transparent;border:none;padding:6px;font-size:1rem;color:#999;cursor:pointer;transition:color .2s}
    .hdr-item button.del:hover{color:#666}
    #result-output{white-space:pre-wrap;max-height:220px;overflow:auto;font-family:monospace}
    .accordion{border-radius:6px;overflow:hidden;margin-top:12px}
    .accordion-header{background:#fff;padding:12px 16px;cursor:pointer;font-weight:bold;box-shadow:0 2px 5px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
    .accordion-header .arrow{width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-top:7px solid #666;transition:transform .28s ease}
    .accordion-header.open .arrow{transform:rotate(180deg)}
    .accordion-content{display:none;background:#fff;padding:12px 16px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .record-item{border-top:1px solid #eee;padding:10px 0}
    .record-item:first-child{border-top:none}
    .record-item .orders{margin-top:8px;line-height:1.45}
    .record-item .btn-recover{display:block;margin:10px auto 0;padding:6px 12px;background:#6c757d;color:#fff;border:none;border-radius:4px;font-size:.9rem;cursor:pointer}
    .footer{position:fixed;left:0;right:0;bottom:0;background:#fff;box-shadow:0 -2px 5px rgba(0,0,0,.05);padding:8px;display:flex;gap:8px}
    .footer button{flex:1;padding:12px 0;font-size:1rem;border:none;border-radius:4px;cursor:pointer}
    .primary{background:#007bff;color:#fff}.secondary{background:#6c757d;color:#fff}.danger{background:#dc3545;color:#fff}
    .hidden{display:none}
    .tip{font-size:.9rem;color:#666;margin-top:6px}
    #debug-log{font-size:.85rem;color:#444;white-space:pre-wrap;max-height:200px;overflow:auto;font-family:monospace;background:#fafafa;border:1px solid #ddd;padding:10px;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h2>发票组合计算器 V8.31</h2>

    <div class="card">
      <label>目标开票金额</label>
      <input id="target-input" type="number" placeholder="如 20000">

      <label>单张发票金额范围</label>
      <div class="flex">
        <input id="min-single" type="number" placeholder="下限">
        <span>—</span>
        <input id="max-single" type="number" placeholder="上限">
      </div>

      <div class="two-cols">
        <div>
          <label>相同金额发票张数上限</label>
          <input id="max-same-count" type="number" placeholder="留空表示不限">
        </div>
        <div>
          <label>发票张数</label>
          <input id="invoice-count" type="number" placeholder="留空表示不限">
        </div>
      </div>

      <label>公司抬头</label>
      <textarea id="company-header" rows="2" placeholder="行1：公司名称
行2：统一社会信用代码"></textarea>
      <div id="header-history"></div>

      <div class="tip">库存数据来自 <b>inventory.json</b>。替换文件即可更新库存。</div>

      <label><input type="checkbox" id="allow-approx"> 允许误差最小匹配</label>
      <label><input type="checkbox" id="no-less"> 匹配金额不得小于目标</label>
    </div>

    <div class="card">
      <h3>导出结果</h3>
      <div id="result-output"></div>
    </div>

    <div class="accordion">
      <div class="accordion-header">
        <span>删除记录（最近10条）</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content" id="record-list"></div>
    </div>

    <div class="accordion">
      <div class="accordion-header">
        <span>调试日志</span>
        <div class="arrow"></div>
      </div>
      <div class="accordion-content">
        <div id="debug-log"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <button id="combine-btn" class="primary">一键组合</button>
    <button id="copy-btn" class="secondary">复制结果</button>
    <button id="reset-btn" class="secondary">重置库存</button>
    <button id="confirm-delete-btn" class="danger hidden">确认删除</button>
  </div>

<script>
let inventory = [];
let deleteRecords = JSON.parse(localStorage.getItem('deleteRecords')||'[]');
let headerHistory = JSON.parse(localStorage.getItem('headerHistory')||'[]');
const saveDeleteRecords=()=>localStorage.setItem('deleteRecords',JSON.stringify(deleteRecords));
const saveInventory=()=>localStorage.setItem('invoiceInventory',JSON.stringify(inventory));

function log(msg){document.getElementById('debug-log').textContent+=msg+"\\n";}

// 历史抬头
function renderHeaderHistory(){
  const div=document.getElementById('header-history'); div.innerHTML='';
  headerHistory.forEach((h,i)=>{
    const wrap=document.createElement('div'); wrap.className='hdr-item';
    const txt=document.createElement('button'); txt.className='txt'; txt.textContent=h;
    txt.onclick=()=>document.getElementById('company-header').value=h;
    const del=document.createElement('button'); del.className='del'; del.textContent='✕';
    del.onclick=()=>{headerHistory.splice(i,1);localStorage.setItem('headerHistory',JSON.stringify(headerHistory));renderHeaderHistory();};
    wrap.appendChild(txt); wrap.appendChild(del); div.appendChild(wrap);
  });
}

// 删除记录
function renderDeleteRecords(){
  const list=document.getElementById('record-list'); list.innerHTML='';
  deleteRecords.slice(0,10).forEach((batch,i)=>{
    const total=batch.reduce((s,inv)=>s+inv.sum,0);
    const item=document.createElement('div'); item.className='record-item';
    let html=`批次 ${i+1}：共 ${batch.length} 张发票，合计 ${total} 元<br><div class="orders">`;
    batch.forEach(inv=>inv.orders.forEach(o=>html+=`订单号：${o.order}，金额：${o.amount}元<br>`));
    html+='</div>'; item.innerHTML=html;
    const btn=document.createElement('button'); btn.className='btn-recover'; btn.textContent='恢复';
    btn.onclick=()=>{
      const rec=deleteRecords.splice(i,1)[0];
      rec.forEach(inv=>inv.orders.forEach(o=>inventory.push(o)));
      saveDeleteRecords();saveInventory();renderDeleteRecords();
    };
    item.appendChild(btn); list.appendChild(item);
  });
}

// 运算逻辑（保持 8.28 的正确性）
function computeInvoices(target,minS,maxS,allowApprox,noLess){
  const arr=inventory.slice();
  const total=arr.reduce((s,o)=>s+o.amount,0);
  log(`开始计算:目标=${target},库存总额=${total}`);

  // 精确DP
  let dp=Array(target+1).fill(null); dp[0]=[];
  for(let o of arr){
    for(let s=target;s>=o.amount;s--){
      if(dp[s-o.amount]!=null && dp[s]==null){dp[s]=dp[s-o.amount].concat(o);}
    }
  }
  if(dp[target]) return splitInvoices(dp[target],minS,maxS);

  if(!allowApprox){log("精确匹配失败，未启用近似");return null;}

  // 近似搜索
  let best=null,bestErr=Infinity;
  for(let s=target-500;s<=target+500;s++){
    if(s<0) continue;
    let tmp=Array(s+1).fill(null); tmp[0]=[];
    for(let o of arr){
      for(let j=s;j>=o.amount;j--){
        if(tmp[j-o.amount]!=null && tmp[j]==null){tmp[j]=tmp[j-o.amount].concat(o);}
      }
    }
    if(tmp[s]){
      const err=Math.abs(s-target);
      if((!noLess||s>=target)&&err<bestErr){bestErr=err;best=tmp[s];}
    }
  }
  if(best){log("近似匹配成功，总额="+best.reduce((x,y)=>x+y.amount,0));return splitInvoices(best,minS,maxS);}
  log("近似匹配失败");return null;
}

// 拆发票
function splitInvoices(orders,minS,maxS){
  if(!minS&&!maxS) return [{sum:orders.reduce((s,o)=>s+o.amount,0),orders}];
  let res=[],cur=[],sum=0;
  for(let o of orders){
    if(sum+o.amount<=maxS||!maxS){cur.push(o);sum+=o.amount;}
    else{if(sum>0)res.push({sum,orders:cur});cur=[o];sum=o.amount;}
    if((!minS||sum>=minS)&&(!maxS||sum<=maxS)){res.push({sum,orders:cur});cur=[];sum=0;}
  }
  if(cur.length&&sum>0)res.push({sum,orders:cur});
  return res.filter(inv=>inv.sum>0);
}

document.addEventListener('DOMContentLoaded',async()=>{
  try{
    const res=await fetch('inventory.json',{cache:'no-store'});
    inventory=await res.json();
  }catch(e){alert("未找到 inventory.json");}

  renderDeleteRecords();renderHeaderHistory();

  document.querySelectorAll('.accordion-header').forEach(h=>{
    h.onclick=()=>{const c=h.nextElementSibling;const open=c.style.display==='block';c.style.display=open?'none':'block';h.classList.toggle('open',!open);};
  });

  let lastInv=null;

  document.getElementById('combine-btn').onclick=()=>{
    document.getElementById('debug-log').textContent='';
    const tgt=+document.getElementById('target-input').value;
    const minS=+document.getElementById('min-single').value||0;
    const maxS=+document.getElementById('max-single').value||0;
    const allowApprox=document.getElementById('allow-approx').checked;
    const noLess=document.getElementById('no-less').checked;
    const header=document.getElementById('company-header').value.trim();
    if(header){headerHistory=headerHistory.filter(x=>x!==header);headerHistory.unshift(header);if(headerHistory.length>10)headerHistory.pop();localStorage.setItem('headerHistory',JSON.stringify(headerHistory));renderHeaderHistory();}

    const invs=computeInvoices(tgt,minS,maxS,allowApprox,noLess);
    if(!invs){alert("无法组合出满足条件的金额");return;}
    lastInv=invs;

    const out=[];
    invs.forEach((inv,i)=>{
      out.push(`发票${i+1}：${inv.sum}元${inv.orders.length>1?'（相关订单合并）':''}`);
      inv.orders.forEach(o=>out.push(`订单号：${o.order}，金额：${o.amount}元`));
      out.push('');
    });
    if(header) out.push(header,'');
    out.push('不需要备注','568881753@qq.com');
    document.getElementById('result-output').textContent=out.join("\n");
    document.getElementById('confirm-delete-btn').classList.remove('hidden');
  };

  document.getElementById('confirm-delete-btn').onclick=()=>{
    if(!lastInv) return;
    deleteRecords.unshift(lastInv);
    const removeSet=new Set(lastInv.flatMap(inv=>inv.orders.map(o=>o.order+'|'+o.amount)));
    inventory=inventory.filter(o=>!removeSet.has(o.order+'|'+o.amount));
    saveDeleteRecords();saveInventory();renderDeleteRecords();
    document.getElementById('confirm-delete-btn').classList.add('hidden');
  };

  document.getElementById('copy-btn').onclick=()=>{
    navigator.clipboard.writeText(document.getElementById('result-output').textContent);
    alert("结果已复制");
  };

  document.getElementById('reset-btn').onclick=async()=>{
    localStorage.removeItem('invoiceInventory');
    localStorage.removeItem('deleteRecords');
    localStorage.removeItem('headerHistory');
    deleteRecords=[];headerHistory=[];
    try{const res=await fetch('inventory.json',{cache:'no-store'});inventory=await res.json();}catch(e){inventory=[];}
    saveInventory();renderDeleteRecords();renderHeaderHistory();
    alert("库存和历史记录已重置");
  };
});
</script>
</body>
</html>