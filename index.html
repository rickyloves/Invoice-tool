<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>发票组合计算器 V6.34</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; }
    h2 { margin-bottom: 10px; }
    label { display:block; margin-top:10px; }
    input, select, textarea, button { width:100%; padding:6px; margin-top:4px; box-sizing:border-box; }
    .record-item { border:1px solid #ccc; padding:8px; margin-top:6px; }
    #result-output { height:200px; white-space: pre-wrap; }
    #header-history button { margin:2px; padding:4px; }
  </style>
</head>
<body>
  <h2>发票组合计算器 V6.34</h2>
  <label>目标金额：</label><input id="target" placeholder="20000">
  <label>单张上限：</label><input id="maxSingle" type="number">
  <label>相同金额上限：</label><input id="maxSame" type="number">
  <label>逻辑：</label><select id="logic"><option value="few">订单数尽量少</option><option value="diverse">金额分散</option></select>
  <label>公司抬头：</label><textarea id="header" rows="2"></textarea><div id="header-history"></div>
  <button id="combine">一键组合</button>
  <button id="copy">复制结果</button>
  <button id="confirmDelete" style="display:none;">确认删除</button>
  <h3>结果</h3><textarea id="result-output" readonly></textarea>
  <h3>删除记录</h3><div id="records"></div>
<script>
// 示例默认库存，请替换为实际数据
const defaultInv = [
  {order:'23910608992',amount:1600.00},
  {order:'17938227424',amount:800.00},
  // ... 更多订单 ...
];
let inventory = JSON.parse(localStorage.getItem('invoiceInventory')) || defaultInv.slice();
let delRec = JSON.parse(localStorage.getItem('deleteRecords')) || [];
function saveAll(){
  localStorage.setItem('invoiceInventory', JSON.stringify(inventory));
  localStorage.setItem('deleteRecords', JSON.stringify(delRec));
}
function renderHeaderHistory(){
  const hist = JSON.parse(localStorage.getItem('headerHistory')||'[]'), div=document.getElementById('header-history');
  div.innerHTML='';
  hist.forEach(h=>{ const b=document.createElement('button'); b.textContent=h; b.onclick=()=>document.getElementById('header').value=h; div.appendChild(b); });
}
function saveHeaderHistory(v){
  if(!v) return;
  let h = JSON.parse(localStorage.getItem('headerHistory')||'[]').filter(x=>x!==v);
  h.unshift(v); if(h.length>20) h.pop();
  localStorage.setItem('headerHistory', JSON.stringify(h));
}
function renderRec(){
  const c=document.getElementById('records'); c.innerHTML='';
  delRec.forEach((batch,i)=>{
    const dv=document.createElement('div'); dv.className='record-item';
    dv.innerHTML = '批次 '+(i+1)+'，共'+batch.length+'张发票<br>';
    batch.forEach((inv,j)=>{
      dv.innerHTML += '发票'+(j+1)+'：'+inv.sum.toFixed(2)+'<br>';
      inv.orders.forEach(o=>dv.innerHTML += '&nbsp;&nbsp;订单号：'+o.order+'，金额：'+o.amount.toFixed(2)+'<br>');
    });
    const btn=document.createElement('button'); btn.textContent='恢复';
    btn.onclick=()=>{
      const rec = delRec.splice(i,1)[0];
      rec.forEach(inv=>inv.orders.forEach(o=>inventory.push(o)));
      saveAll(); renderRec();
    };
    dv.appendChild(btn);
    c.appendChild(dv);
  });
}
function renderResult(list,hdr){
  let out=''; list.forEach((inv,i)=>{
    out += '发票'+(i+1)+'：'+inv.sum.toFixed(2)+(inv.orders.length>1?'（相关订单合并）':'')+'\n';
    inv.orders.forEach(o=>out += '订单号：'+o.order+'，金额：'+o.amount.toFixed(2)+'\n');
    out += '\n';
  });
  if(hdr) out += hdr+'\n\n';
  out += '不需要备注\n568881753@qq.com';
  document.getElementById('result-output').value = out;
}
function previewInvoices(tgt, maxS, maxSame, logic){
  // 请插入 V6.18 算法实现
  return null;
}
let lastInv=null;
document.addEventListener('DOMContentLoaded',()=>{
  renderHeaderHistory(); renderRec();
  document.getElementById('combine').onclick=()=>{
    const tgt=+document.getElementById('target').value;
    const maxS=+document.getElementById('maxSingle').value||tgt;
    const maxSame=+document.getElementById('maxSame').value||Infinity;
    const logic=document.getElementById('logic').value;
    const hdr=document.getElementById('header').value.trim();
    saveHeaderHistory(hdr); renderHeaderHistory();
    const invs = previewInvoices(tgt, maxS, maxSame, logic);
    if(!invs){ document.getElementById('result-output').value='无法组合'; return; }
    lastInv=invs; renderResult(invs, hdr);
    document.getElementById('confirmDelete').style.display='inline';
  };
  document.getElementById('confirmDelete').onclick=()=>{
    if(!lastInv) return;
    delRec.unshift(lastInv);
    lastInv.forEach(inv=>inv.orders.forEach(o=>{ const idx=inventory.findIndex(x=>x.order===o.order&&x.amount===o.amount); if(idx>-1) inventory.splice(idx,1); }));
    saveAll(); renderRec();
    document.getElementById('confirmDelete').style.display='none';
  };
  document.getElementById('copy').onclick=()=>navigator.clipboard.writeText(document.getElementById('result-output').value);
});
</script>
</body>
</html>
