<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>发票组合工具</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 40px auto; }
    h1 { text-align: center; }
    label { display: block; margin: 10px 0; }
    input, button { padding: 6px; font-size: 14px; }
    button { margin-right: 10px; }
    #output { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; margin-top: 20px; min-height: 200px; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>发票组合工具</h1>
  <p>已加载 450 条订单数据。</p>

  <label>
    目标总金额（元，必填）：
    <input type="number" id="targetAmount" step="0.01" />
  </label>

  <label>
    单张发票金额上限（元，可不填表示不限制）：
    <input type="number" id="invoiceLimit" step="0.01" placeholder="留空不限制" />
  </label>

  <label>
    相同金额发票张数上限（张，可不填表示不限制；填 0 表示不允许重复金额）：
    <input type="number" id="duplicateLimit" placeholder="留空不限制" />
  </label>

  <div>
    <button id="computeBtn">计算</button>
    <button id="exportBtn">导出</button>
  </div>

  <div id="output"></div>

  <script>
    // 嵌入的订单数据
    const orders = [    { id: '33897710458', amount: 610.00 },
    { id: '33898104698', amount: 610.00 },
    { id: '33898544954', amount: 610.00 },
    { id: '33898028090', amount: 610.00 },
    { id: '28694993082', amount: 667.00 },
    { id: '34193026810', amount: 700.00 },
    { id: '34157709114', amount: 700.00 },
    { id: '34156958074', amount: 700.00 },
    { id: '34018792442', amount: 700.00 },
    { id: '33898416890', amount: 700.00 },
    { id: '33898405562', amount: 700.00 },
    { id: '33887734138', amount: 700.00 },
    { id: '33888148602', amount: 700.00 },
    { id: '33887947002', amount: 700.00 },
    { id: '33800146554', amount: 700.00 },
    { id: '33617747514', amount: 700.00 },
    { id: '34549641210', amount: 700.00 },
    { id: '34466650362', amount: 700.00 },
    { id: '34466819706', amount: 700.00 },
    { id: '34465939322', amount: 700.00 },
    { id: '32949490810', amount: 710.00 },
    { id: '32871257786', amount: 710.00 },
    { id: '34092812282', amount: 710.00 },
    { id: '34092980346', amount: 710.00 },
    { id: '33158701626', amount: 710.00 },
    { id: '34553343034', amount: 710.00 },
    { id: '34551674298', amount: 710.00 },
    { id: '34456627898', amount: 710.00 },
    { id: '34456627770', amount: 710.00 },
    { id: '34446218746', amount: 710.00 },
    { id: '34446099642', amount: 710.00 },
    { id: '34446150074', amount: 710.00 },
    { id: '34446303930', amount: 710.00 },
    { id: '31965579130', amount: 720.00 },
    { id: '32764336634', amount: 720.00 },
    { id: '34092562490', amount: 805.00 },
    { id: '34216672570', amount: 810.00 },
    { id: '34216561274', amount: 810.00 },
    { id: '34216595706', amount: 810.00 },
    { id: '34204662458', amount: 810.00 },
    { id: '34204761914', amount: 810.00 },
    { id: '34204378746', amount: 810.00 },
    { id: '34204411130', amount: 810.00 },
    { id: '34194249082', amount: 810.00 },
    { id: '34180365562', amount: 810.00 },
    { id: '34092783674', amount: 810.00 },
    { id: '34092663418', amount: 810.00 },
    { id: '34092652026', amount: 810.00 },
    { id: '34092747194', amount: 810.00 },
    { id: '34092591738', amount: 810.00 },
    { id: '33998478266', amount: 810.00 },
    { id: '33897981882', amount: 810.00 },
    { id: '33898173754', amount: 810.00 },
    { id: '33898154490', amount: 810.00 },
    { id: '33898151098', amount: 810.00 },
    { id: '33897793338', amount: 810.00 },
    { id: '33887743930', amount: 810.00 },
    { id: '33801095610', amount: 810.00 },
    { id: '33757188474', amount: 810.00 },
    { id: '33403617466', amount: 810.00 },
    { id: '34550348346', amount: 810.00 },
    { id: '34550346682', amount: 810.00 },
    { id: '34466214266', amount: 810.00 },
    { id: '34455852858', amount: 810.00 },
    { id: '34456053626', amount: 810.00 },
    { id: '34445422202', amount: 810.00 },
    { id: '34445104058', amount: 810.00 },
    { id: '34445435706', amount: 810.00 },
    { id: '34445263162', amount: 810.00 },
    { id: '34438049786', amount: 810.00 },
    { id: '34429456122', amount: 810.00 },
    { id: '34429439994', amount: 810.00 },
    { id: '34429469434', amount: 810.00 },
    { id: '34429048506', amount: 810.00 },
    { id: '34249712250', amount: 810.00 },
    { id: '34249676922', amount: 810.00 },
    { id: '33109383994', amount: 820.00 },
    { id: '33032941818', amount: 820.00 },
    { id: '32937523770', amount: 820.00 },
    { id: '32896545978', amount: 820.00 },
    { id: '32898005178', amount: 820.00 },
    { id: '32897838394', amount: 820.00 },
    { id: '32883159610', amount: 820.00 },
    { id: '32883643770', amount: 820.00 },
    { id: '32870545594', amount: 820.00 },
    { id: '32870112954', amount: 820.00 },
    { id: '32870722298', amount: 820.00 },
    { id: '32817328698', amount: 820.00 },
    { id: '34216420474', amount: 820.00 },
    { id: '34092813306', amount: 820.00 },
    { id: '33223635962', amount: 820.00 },
    { id: '34554090042', amount: 820.00 },
    { id: '34553379322', amount: 820.00 },
    { id: '34553338682', amount: 820.00 },
    { id: '34552706362', amount: 820.00 },
    { id: '34446243834', amount: 820.00 },
    { id: '32650945978', amount: 830.00 },
    { id: '32650522682', amount: 830.00 },
    { id: '32537980986', amount: 830.00 },
    { id: '32518487418', amount: 830.00 },
    { id: '32378262074', amount: 830.00 },
    { id: '32378769338', amount: 830.00 },
    { id: '32376437370', amount: 830.00 },
    { id: '32363253690', amount: 830.00 },
    { id: '32363168762', amount: 830.00 },
    { id: '32363584826', amount: 830.00 },
    { id: '32130747514', amount: 830.00 },
    { id: '32107889722', amount: 830.00 },
    { id: '32108179386', amount: 830.00 },
    { id: '32107834042', amount: 830.00 },
    { id: '31999524986', amount: 830.00 },
    { id: '31498857786', amount: 830.00 },
    { id: '32772392954', amount: 830.00 },
    { id: '32691819962', amount: 830.00 },
    { id: '32691990842', amount: 830.00 },
    { id: '32692416250', amount: 830.00 },
    { id: '34204338810', amount: 910.00 },
    { id: '34181422074', amount: 910.00 },
    { id: '34092780090', amount: 910.00 },
    { id: '34092183482', amount: 910.00 },
    { id: '34019294010', amount: 910.00 },
    { id: '33898232314', amount: 910.00 },
    { id: '33772745722', amount: 910.00 },
    { id: '33750042874', amount: 910.00 },
    { id: '33635918074', amount: 910.00 },
    { id: '34455618362', amount: 910.00 },
    { id: '34265656954', amount: 910.00 },
    { id: '32937235706', amount: 920.00 },
    { id: '32938214906', amount: 920.00 },
    { id: '32870312058', amount: 920.00 },
    { id: '32870732986', amount: 920.00 },
    { id: '32650987834', amount: 930.00 },
    { id: '32537810490', amount: 930.00 },
    { id: '32453645626', amount: 930.00 },
    { id: '32451435066', amount: 930.00 },
    { id: '32378666746', amount: 930.00 },
    { id: '32290784698', amount: 930.00 },
    { id: '32205652026', amount: 930.00 },
    { id: '32205031290', amount: 930.00 },
    { id: '32196888570', amount: 930.00 },
    { id: '32114337082', amount: 930.00 },
    { id: '32114319546', amount: 930.00 },
    { id: '32108214970', amount: 930.00 },
    { id: '31998719866', amount: 930.00 },
    { id: '31911576570', amount: 930.00 },
    { id: '32772294394', amount: 930.00 },
    { id: '32764340602', amount: 930.00 },
    { id: '32763827322', amount: 930.00 },
    { id: '32762902138', amount: 930.00 },
    { id: '32698635514', amount: 930.00 },
    { id: '32102900282', amount: 1140.00 },
    { id: '32102640442', amount: 1140.00 },
    { id: '31578495354', amount: 1142.00 },
    { id: '31487547706', amount: 1142.00 },
    { id: '32537775546', amount: 1143.00 },
    { id: '32520286458', amount: 1143.00 },
    { id: '28698767354', amount: 1190.00 },
    { id: '28462899322', amount: 1192.00 },
    { id: '28719742010', amount: 1208.00 },
    { id: '28719669498', amount: 1208.00 },
    { id: '28719936378', amount: 1208.00 },
    { id: '32948910906', amount: 1215.00 },
    { id: '32857231610', amount: 1220.00 },
    { id: '32641660282', amount: 1230.00 },
    { id: '32640858554', amount: 1230.00 },
    { id: '32641344378', amount: 1230.00 },
    { id: '34180559418', amount: 1230.00 },
    { id: '34180056954', amount: 1230.00 },
    { id: '33764369978', amount: 1230.00 },
    { id: '33083459834', amount: 1240.00 },
    { id: '33381637818', amount: 1240.00 },
    { id: '33158688762', amount: 1240.00 },
    { id: '28474816762', amount: 1250.00 },
    { id: '34239401850', amount: 1320.00 },
    { id: '34223778618', amount: 1320.00 },
    { id: '34204742266', amount: 1320.00 },
    { id: '34204605754', amount: 1320.00 },
    { id: '34205011706', amount: 1320.00 },
    { id: '34178641530', amount: 1320.00 },
    { id: '34157775610', amount: 1320.00 },
    { id: '34089943994', amount: 1320.00 },
    { id: '34089929850', amount: 1320.00 },
    { id: '34043616314', amount: 1320.00 },
    { id: '33619208826', amount: 1320.00 },
    { id: '34249557370', amount: 1320.00 },
    { id: '34249308666', amount: 1320.00 },
    { id: '34249927418', amount: 1320.00 },
    { id: '28694724858', amount: 1330.00 },
    { id: '28699071994', amount: 1340.00 },
    { id: '28946746938', amount: 1398.00 },
    { id: '34239502906', amount: 1410.00 },
    { id: '34180185594', amount: 1410.00 },
    { id: '34180304698', amount: 1410.00 },
    { id: '34180404858', amount: 1410.00 },
    { id: '34180620858', amount: 1410.00 },
    { id: '34157736762', amount: 1410.00 },
    { id: '33888238010', amount: 1410.00 },
    { id: '33511904314', amount: 1410.00 },
    { id: '34266473466', amount: 1410.00 },
    { id: '34265724666', amount: 1410.00 },
    { id: '34266004858', amount: 1410.00 },
    { id: '33083978106', amount: 1420.00 },
    { id: '32954651002', amount: 1420.00 },
    { id: '32871232122', amount: 1420.00 },
    { id: '33635588730', amount: 1420.00 },
    { id: '34204387898', amount: 1430.00 },
    { id: '34157625594', amount: 1430.00 },
    { id: '33619989882', amount: 1430.00 },
    { id: '33512054970', amount: 1430.00 },
    { id: '32684248762', amount: 1440.00 },
    { id: '28977462970', amount: 1498.00 },
    { id: '28977803514', amount: 1498.00 },
    { id: '34204823098', amount: 1520.00 },
    { id: '34204066682', amount: 1520.00 },
    { id: '34204547002', amount: 1520.00 },
    { id: '34204238202', amount: 1520.00 },
    { id: '34180473850', amount: 1520.00 },
    { id: '34157736890', amount: 1520.00 },
    { id: '34089923258', amount: 1520.00 },
    { id: '33887783738', amount: 1520.00 },
    { id: '33801161402', amount: 1520.00 },
    { id: '33756953658', amount: 1520.00 },
    { id: '33562598010', amount: 1520.00 },
    { id: '33392664570', amount: 1520.00 },
    { id: '34435724154', amount: 1520.00 },
    { id: '34429334330', amount: 1520.00 },
    { id: '34428623162', amount: 1520.00 },
    { id: '34429455802', amount: 1520.00 },
    { id: '34429414650', amount: 1520.00 },
    { id: '34429044474', amount: 1520.00 },
    { id: '34265761658', amount: 1520.00 },
    { id: '34249560442', amount: 1520.00 },
    { id: '34249183226', amount: 1520.00 },
    { id: '34249859578', amount: 1520.00 },
    { id: '33212942650', amount: 1530.00 },
    { id: '32384055866', amount: 1580.00 },
    { id: '32384094906', amount: 1580.00 },
    { id: '32384615098', amount: 1580.00 },
    { id: '31578805498', amount: 1580.00 },
    { id: '31517214330', amount: 1580.00 },
    { id: '31487078778', amount: 1580.00 },
    { id: '29033549818', amount: 1590.00 },
    { id: '32864219578', amount: 1614.00 },
    { id: '34239838778', amount: 1630.00 },
    { id: '34180639738', amount: 1630.00 },
    { id: '34180564218', amount: 1630.00 },
    { id: '34180316858', amount: 1630.00 },
    { id: '34180452602', amount: 1630.00 },
    { id: '34083696058', amount: 1630.00 },
    { id: '33801576378', amount: 1630.00 },
    { id: '33757887034', amount: 1630.00 },
    { id: '33617859834', amount: 1630.00 },
    { id: '33533275450', amount: 1630.00 },
    { id: '33511811962', amount: 1630.00 },
    { id: '33404582586', amount: 1630.00 },
    { id: '33158280698', amount: 1630.00 },
    { id: '34435772538', amount: 1630.00 },
    { id: '34264770874', amount: 1630.00 },
    { id: '34268003834', amount: 1630.00 },
    { id: '34267550906', amount: 1630.00 },
    { id: '34267200250', amount: 1630.00 },
    { id: '28719666682', amount: 1638.00 },
    { id: '32938046714', amount: 1640.00 },
    { id: '32937605370', amount: 1640.00 },
    { id: '32883440442', amount: 1640.00 },
    { id: '32883414714', amount: 1640.00 },
    { id: '32883245882', amount: 1640.00 },
    { id: '32864563450', amount: 1640.00 },
    { id: '32864638330', amount: 1640.00 },
    { id: '33381740154', amount: 1640.00 },
    { id: '33263239738', amount: 1640.00 },
    { id: '32650487930', amount: 1660.00 },
    { id: '32537706874', amount: 1660.00 },
    { id: '32285889978', amount: 1660.00 },
    { id: '32269683514', amount: 1660.00 },
    { id: '28723403066', amount: 1730.00 },
    { id: '34239536314', amount: 1730.00 },
    { id: '34204259002', amount: 1730.00 },
    { id: '33749952954', amount: 1730.00 },
    { id: '34456153402', amount: 1730.00 },
    { id: '34456510266', amount: 1730.00 },
    { id: '34429000570', amount: 1730.00 },
    { id: '34413735226', amount: 1730.00 },
    { id: '34267530874', amount: 1730.00 },
    { id: '29237529466', amount: 1740.00 },
    { id: '29237086522', amount: 1740.00 },
    { id: '29236811322', amount: 1740.00 },
    { id: '29047716858', amount: 1740.00 },
    { id: '29047745082', amount: 1740.00 },
    { id: '29047704442', amount: 1740.00 },
    { id: '29002836986', amount: 1770.00 },
    { id: '29002839162', amount: 1770.00 },
    { id: '28963036794', amount: 1770.00 },
    { id: '28963288442', amount: 1770.00 },
    { id: '28963292154', amount: 1770.00 },
    { id: '28962985402', amount: 1770.00 },
    { id: '28698933690', amount: 1791.00 },
    { id: '33557740218', amount: 2120.00 },
    { id: '33532585210', amount: 2120.00 },
    { id: '33310667898', amount: 2120.00 },
    { id: '34462547514', amount: 2120.00 },
    { id: '33021848954', amount: 2130.00 },
    { id: '33999443578', amount: 2130.00 },
    { id: '33223299194', amount: 2130.00 },
    { id: '32478123642', amount: 2160.00 },
    { id: '32478211514', amount: 2160.00 },
    { id: '29003019322', amount: 2240.00 },
    { id: '28963000186', amount: 2247.00 },
    { id: '27369639994', amount: 2421.00 },
    { id: '33080675706', amount: 2428.00 },
    { id: '31503347386', amount: 2439.00 },
    { id: '34239895738', amount: 2450.00 },
    { id: '33310885818', amount: 2450.00 },
    { id: '32454421370', amount: 2458.00 },
    { id: '32271718842', amount: 2458.00 },
    { id: '32675877946', amount: 2460.00 },
    { id: '32658831738', amount: 2460.00 },
    { id: '32538248186', amount: 2460.00 },
    { id: '33093242426', amount: 2460.00 },
    { id: '33032967162', amount: 2460.00 },
    { id: '32870420026', amount: 2460.00 },
    { id: '32856636282', amount: 2460.00 },
    { id: '32856866682', amount: 2460.00 },
    { id: '34225177402', amount: 2460.00 },
    { id: '34216563898', amount: 2460.00 },
    { id: '34070864506', amount: 2460.00 },
    { id: '32953733050', amount: 2466.00 },
    { id: '33801577146', amount: 2470.00 },
    { id: '33292690426', amount: 2480.00 },
    { id: '33108320314', amount: 2480.00 },
    { id: '32640728122', amount: 2490.00 },
    { id: '32641718010', amount: 2490.00 },
    { id: '32538129594', amount: 2490.00 },
    { id: '32537996090', amount: 2490.00 },
    { id: '32517376826', amount: 2490.00 },
    { id: '32485904378', amount: 2490.00 },
    { id: '32372336762', amount: 2490.00 },
    { id: '32363230714', amount: 2490.00 },
    { id: '32363656698', amount: 2490.00 },
    { id: '32692015546', amount: 2490.00 },
    { id: '28683301434', amount: 2540.00 },
    { id: '28683452730', amount: 2540.00 },
    { id: '28288419258', amount: 2540.00 },
    { id: '34575574906', amount: 2732.00 },
    { id: '32949003066', amount: 2745.00 },
    { id: '34327016634', amount: 2750.00 },
    { id: '32948814906', amount: 2760.00 },
    { id: '34225428346', amount: 2760.00 },
    { id: '34045787514', amount: 2760.00 },
    { id: '32385311866', amount: 2790.00 },
    { id: '32384843066', amount: 2790.00 },
    { id: '32372276922', amount: 2790.00 },
    { id: '32197043770', amount: 2790.00 },
    { id: '32196743162', amount: 2790.00 },
    { id: '32764076602', amount: 2790.00 },
    { id: '29056604730', amount: 2820.00 },
    { id: '34216003834', amount: 2820.00 },
    { id: '32870088058', amount: 2840.00 },
    { id: '34047075898', amount: 2840.00 },
    { id: '33223314298', amount: 2840.00 },
    { id: '28808866810', amount: 2860.00 },
    { id: '28808934906', amount: 2860.00 },
    { id: '33763535738', amount: 2870.00 },
    { id: '29003203962', amount: 2880.00 },
    { id: '28996574842', amount: 2880.00 },
    { id: '33381906490', amount: 2880.00 },
    { id: '33158035066', amount: 2880.00 },
    { id: '28699266682', amount: 2975.00 },
    { id: '28699079098', amount: 2975.00 },
    { id: '28699144762', amount: 2975.00 },
    { id: '28698870266', amount: 2975.00 },
    { id: '28698829562', amount: 2975.00 },
    { id: '28693672570', amount: 2975.00 },
    { id: '28693560762', amount: 2975.00 },
    { id: '28693776250', amount: 2975.00 },
    { id: '28693646714', amount: 2975.00 },
    { id: '28680930234', amount: 2975.00 },
    { id: '28681141562', amount: 2975.00 },
    { id: '28681222842', amount: 2975.00 },
    { id: '28681006586', amount: 2975.00 },
    { id: '28952603642', amount: 2975.00 },
    { id: '33310589882', amount: 3042.00 },
    { id: '33763488570', amount: 3050.00 },
    { id: '33757806522', amount: 3050.00 },
    { id: '33533110138', amount: 3050.00 },
    { id: '33093613562', amount: 3069.00 },
    { id: '28476481402', amount: 3125.00 },
    { id: '28476401978', amount: 3140.00 },
    { id: '32543367610', amount: 3160.00 },
    { id: '28638951482', amount: 3175.00 },
    { id: '28638266298', amount: 3175.00 },
    { id: '28733392314', amount: 3220.00 },
    { id: '28709872890', amount: 3228.00 },
    { id: '34326979514', amount: 3250.00 },
    { id: '33032931834', amount: 3280.00 },
    { id: '32870690298', amount: 3280.00 },
    { id: '33636462650', amount: 3280.00 },
    { id: '33292260346', amount: 3280.00 },
    { id: '33223587258', amount: 3280.00 },
    { id: '32478406586', amount: 3320.00 },
    { id: '32205436090', amount: 3320.00 },
    { id: '32204999226', amount: 3320.00 },
    { id: '32764047802', amount: 3320.00 },
    { id: '32698272058', amount: 3320.00 },
    { id: '28694514106', amount: 3325.00 },
    { id: '29039968186', amount: 3445.00 },
    { id: '33223525754', amount: 3480.00 },
    { id: '34083532154', amount: 3540.00 },
    { id: '33083709370', amount: 3550.00 },
    { id: '33083447226', amount: 3550.00 },
    { id: '33021531834', amount: 3550.00 },
    { id: '32954476154', amount: 3550.00 },
    { id: '34084219706', amount: 3550.00 },
    { id: '28462468794', amount: 3660.00 },
    { id: '33747839354', amount: 3670.00 },
    { id: '28953757434', amount: 3675.00 },
    { id: '28953761018', amount: 3675.00 },
    { id: '32949384058', amount: 3680.00 },
    { id: '33293771194', amount: 3680.00 },
    { id: '32108418938', amount: 3687.00 },
    { id: '32108157370', amount: 3687.00 },
    { id: '28464739898', amount: 3720.00 },
    { id: '32692422906', amount: 3720.00 },
    { id: '34043594298', amount: 3720.00 },
    { id: '33263176058', amount: 3720.00 },
    { id: '29018248954', amount: 3760.00 },
    { id: '28709549306', amount: 3768.00 },
    { id: '28733029882', amount: 3796.00 },
    { id: '33158156922', amount: 3990.00 },
    { id: '28727868154', amount: 4100.00 },
    { id: '33083663610', amount: 4100.00 },
    { id: '33083858554', amount: 4100.00 },
    { id: '32954493946', amount: 4100.00 },
    { id: '32948887482', amount: 4100.00 },
    { id: '32937864442', amount: 4100.00 },
    { id: '34045770554', amount: 4100.00 },
    { id: '34017776442', amount: 4100.00 },
    { id: '33214870778', amount: 4100.00 },
    { id: '33158877306', amount: 4100.00 },
    { id: '32122635194', amount: 4150.00 },
    { id: '28712050554', amount: 4215.00 },
    { id: '33800962170', amount: 4250.00 },
    { id: '33391980154', amount: 4250.00 },
    { id: '34043740026', amount: 4260.00 },
    { id: '28988607610', amount: 4320.00 },
    { id: '33263652602', amount: 4920.00 },
    { id: '32948387130', amount: 8280.00 },
    { id: '32948854906', amount: 8280.00 },
    { id: '32948362426', amount: 8280.00 },
    { id: '32938414266', amount: 8280.00 }];

    function toCents(n) { return Math.round(n * 100); }
    function toYuan(c) { return (c / 100).toFixed(2); }

    // 找到最优子集 —— 优先最少订单数，其次最大金额
    function findBestSubset(availOrders, limitCents, usedCountMap, dupLimit) {
      const N = availOrders.length;
      const centsArr = availOrders.map(o => toCents(o.amount));
      // dpCount[s] = 最少订单数使得正好凑出 s；初始化为 +Inf
      const dpCount = Array(limitCents + 1).fill(Infinity);
      const dpPrevIdx = Array(limitCents + 1).fill(-1);
      const dpFromSum = Array(limitCents + 1).fill(-1);
      dpCount[0] = 0;
      for (let i = 0; i < N; i++) {
        const a = centsArr[i];
        for (let s = limitCents; s >= a; s--) {
          if (dpCount[s - a] + 1 < dpCount[s]) {
            dpCount[s] = dpCount[s - a] + 1;
            dpPrevIdx[s] = i;
            dpFromSum[s] = s - a;
          }
        }
      }
      // 找到最少订单数
      let minCount = Infinity;
      for (let s = 1; s <= limitCents; s++) {
        if (dpCount[s] < minCount && (usedCountMap[s] || 0) < dupLimit) {
          minCount = dpCount[s];
        }
      }
      if (minCount === Infinity) return null;
      // 在最少订单数中，选金额最大的
      let bestSum = -1;
      for (let s = 1; s <= limitCents; s++) {
        if (dpCount[s] === minCount && (usedCountMap[s] || 0) < dupLimit) {
          if (s > bestSum) bestSum = s;
        }
      }
      if (bestSum <= 0) return null;
      // 重建路径
      const seq = [];
      let cur = bestSum;
      while (cur > 0) {
        const idx = dpPrevIdx[cur];
        seq.push(idx);
        cur = dpFromSum[cur];
      }
      return { sum: bestSum, orders: seq.map(i => availOrders[i]) };
    }

    function computeInvoices() {
      const tgt = parseFloat(document.getElementById('targetAmount').value);
      if (isNaN(tgt) || tgt <= 0) {
        alert('请填写合法的目标总金额');
        return null;
      }
      let invLimit = parseFloat(document.getElementById('invoiceLimit').value);
      if (isNaN(invLimit) || invLimit <= 0) invLimit = Infinity;
      let dupLimit = parseInt(document.getElementById('duplicateLimit').value);
      if (isNaN(dupLimit) || dupLimit < 0) dupLimit = Infinity;
      const targetC = toCents(tgt);
      const limitC = invLimit === Infinity ? targetC : toCents(invLimit);

      let rem = targetC;
      let pool = orders.slice();
      const usedCount = {};
      const groups = [];

      while (rem > 0) {
        const curLimit = Math.min(limitC, rem);
        const subset = findBestSubset(pool, curLimit, usedCount, dupLimit);
        if (!subset) {
          return { error: '无法组合出满足条件的金额，请检查参数设置或库存数据。' };
        }
        groups.push(subset);
        usedCount[subset.sum] = (usedCount[subset.sum] || 0) + 1;
        rem -= subset.sum;
        // 移除已用订单
        const usedIds = new Set(subset.orders.map(o => o.id));
        pool = pool.filter(o => !usedIds.has(o.id));
      }

      groups.sort((a, b) => b.sum - a.sum);
      return { groups };
    }

    document.getElementById('computeBtn').addEventListener('click', () => {
      const res = computeInvoices();
      const out = document.getElementById('output');
      if (res.error) {
        out.innerHTML = `<span class="error">${res.error}</span>`;
        return;
      }
      let txt = '';
      res.groups.forEach((g, i) => {
        const y = toYuan(g.sum);
        const more = g.orders.length > 1 ? '（相关订单合并）' : '';
        txt += `发票${i + 1}：${y}${more}\n`;
        g.orders.forEach(o => {
          txt += `订单号：${o.id}，金额：${o.amount.toFixed(2)}\n`;
        });
        txt += '\n';
      });
      txt += `上海恒新瑞达商贸有限公司
91310120MAEAX2PM6D

不需要备注
568881753@qq.com`;
      out.textContent = txt;
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      const out = document.getElementById('output');
      if (!out.textContent.trim()) return;
      const range = document.createRange();
      range.selectNodeContents(out);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    });
  </script>
</body>
</html>