<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>发票组合计算器 V6.49</title>
  <style>
    body { font-family: sans-serif; margin:20px; }
    input, select, button { font-size: 14px; padding:5px; margin:5px 0; width:100%; box-sizing:border-box; }
    .range { display:flex; }
    .range input { flex:1; margin-right:5px; }
    .range input:last-child { margin-right:0; }
    .results, .logs { margin-top:20px; border:1px solid #ccc; padding:10px; }
    .invoice { margin-bottom:10px; }
    .btn { width:auto; margin:5px 5px 5px 0; }
  </style>
</head>
<body>
  <h1>发票组合计算器 V6.49</h1>

  <label>目标开票金额：</label>
  <input type="number" id="target" placeholder="如 20000">

  <label>单张发票金额范围：</label>
  <div class="range">
    <input type="number" id="minAmt" placeholder="下限">
    <input type="number" id="maxAmt" placeholder="上限">
  </div>

  <label>相同金额发票张数上限：</label>
  <input type="number" id="sameLimit" placeholder="留空表示不限">

  <label>公司抬头：</label>
  <textarea id="header" rows="2" placeholder="行1：公司名称\n行2：统一社会信用代码"></textarea>
  <div id="history"></div>

  <button id="combine">一键组合</button>
  <button id="copy">复制结果</button>
  <button id="confirmDel">确认删除</button>

  <div class="results" id="output"></div>
  <div class="logs" id="logs"></div>

<script>
(function(){
  const orders = window._INVOICE_DB || []; // 假设库存已注入 _INVOICE_DB
  let available = [...orders];
  let lastBatch = [];

  // 历史抬头
  const historyKey = 'invoice_header_history';
  function loadHistory(){
    const arr = JSON.parse(localStorage.getItem(historyKey)||'[]');
    const div = document.getElementById('history');
    div.innerHTML = '';
    arr.forEach(h=>{
      const btn = document.createElement('button');
      btn.className='btn';
      btn.textContent = h.replace('\n',' ');
      btn.onclick=()=>document.getElementById('header').value=h;
      div.appendChild(btn);
    });
  }
  function saveHeader(){
    const h = document.getElementById('header').value.trim();
    if(!h) return;
    let arr = JSON.parse(localStorage.getItem(historyKey)||'[]');
    arr = [h, ...arr.filter(x=>x!==h)].slice(0,20);
    localStorage.setItem(historyKey, JSON.stringify(arr));
    loadHistory();
  }
  loadHistory();

  document.getElementById('combine').onclick = ()=>{
    const T = +document.getElementById('target').value;
    const minA = document.getElementById('minAmt').value===''?0:+document.getElementById('minAmt').value;
    const maxA = document.getElementById('maxAmt').value===''?Infinity:+document.getElementById('maxAmt').value;
    const sameLim = document.getElementById('sameLimit').value===''?Infinity:+document.getElementById('sameLimit').value;

    if(!T){ alert('请输入目标金额'); return; }
    saveHeader();

    // 只用 max 过滤单笔订单：下限不作为订单过滤，只在最终发票金额上校验
    const pool = available.filter(o=>o.amount<=maxA);

    // 全局最少订单：找出能组出目标金额的最少订单组合
    let best = null;
    function dfs(start, sum, path){
      if(sum === T){
        if(!best || path.length<best.length) best = path.slice();
        return;
      }
      if(sum > T) return;
      if(best && path.length>=best.length) return;
      for(let i=start;i<pool.length;i++){
        const o = pool[i];
        path.push(o);
        dfs(i+1, sum+o.amount, path);
        path.pop();
      }
    }
    dfs(0,0,[]);

    const out = document.getElementById('output');
    const log = document.getElementById('logs');
    out.innerHTML=''; log.innerHTML='';

    if(!best){
      alert('无法组合出满足条件的金额');
      return;
    }
    // 检查 sameLimit
    const cnt = {};
    for(const o of best){
      cnt[o.amount] = (cnt[o.amount]||0)+1;
      if(cnt[o.amount]>sameLim){
        alert('由于“相同金额张数上限”限制，无法组合');
        return;
      }
    }
    // 检查 final invoice range
    const invAmt = best.reduce((s,o)=>s+o.amount,0);
    if(invAmt<minA || invAmt>maxA){
      alert('组合后的发票金额不在范围内');
      return;
    }

    // 输出
    const div = document.createElement('div');
    div.className='invoice';
    const h1 = document.createElement('div');
    h1.innerHTML=`<strong>发票1：${invAmt}元</strong>（相关订单合并）`;
    div.appendChild(h1);
    for(const o of best){
      const d = document.createElement('div');
      d.textContent=`订单号：${o.id}，金额：${o.amount}元`;
      div.appendChild(d);
    }
    // 抬头
    const header = document.getElementById('header').value;
    const hdiv = document.createElement('div');
    hdiv.style.marginTop='10px';
    hdiv.textContent = header;
    div.appendChild(hdiv);

    out.appendChild(div);

    // 记录删除
    lastBatch = best.slice();
    log.innerHTML= `批次共 ${best.length} 笔订单，点击“确认删除”后从库存移除。`;
  };

  document.getElementById('confirmDel').onclick = ()=>{
    if(!lastBatch.length){ alert('无可删除记录'); return; }
    // 从 available 中剔除
    const ids = new Set(lastBatch.map(o=>o.id));
    available = available.filter(o=>!ids.has(o.id));
    lastBatch = [];
    document.getElementById('logs').innerHTML='已删除上次组合订单，刷新前库存已更新。';
  };

  document.getElementById('copy').onclick = ()=>{
    const text = document.getElementById('output').innerText;
    navigator.clipboard.writeText(text).then(_=>{
      alert('已复制到剪贴板');
    });
  };
})();
</script>
</body>
</html>
