<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>发票组合计算器 V6.54</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin:10px; }
    h2 { margin-top:0; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, textarea, button { padding:6px; margin-top:4px; box-sizing:border-box; }
    .range-row { display:flex; align-items:center; margin-top:4px; }
    .range-row input { flex:1; }
    .range-row span { padding:0 8px; font-weight:bold; }
    .inline-row { display:flex; gap:20px; align-items:flex-start; }
    .inline-row > div { flex:1; }
    .record-item { border:1px solid #ccc; padding:8px; margin-top:6px; }
    #result-output { width:100%; height:200px; white-space:pre-wrap; }
    #header-history button { margin:2px 4px 2px 0; padding:4px 8px; font-size:90%; }
  </style>
</head>
<body>

  <h2>发票组合计算器 V6.54</h2>

  <label>目标开票金额：</label>
  <input id="target-input" style="width:100%;" placeholder="如 20000">

  <label>单张发票金额范围：</label>
  <div class="range-row">
    <input id="min-single" type="number" placeholder="下限">
    <span>—</span>
    <input id="max-single" type="number" placeholder="上限">
  </div>

  <div class="inline-row">
    <div>
      <label>相同金额发票张数上限：</label>
      <input id="max-same-count" style="width:100%;" type="number" placeholder="留空表示不限">
    </div>
    <div>
      <label>发票张数：</label>
      <input id="invoice-count" style="width:100%;" type="number" placeholder="留空表示不限">
    </div>
  </div>

  <label>公司抬头：</label>
  <textarea id="company-header" style="width:100%;" rows="2" placeholder="行1：公司名称
行2：统一社会信用代码"></textarea>
  <div id="header-history"></div>

  <button id="combine-btn" style="width:100%; margin-top:10px;">一键组合</button>
  <button id="copy-btn" style="width:100%; margin-top:6px;">复制结果</button>
  <button id="confirm-delete-btn" style="width:100%; margin-top:6px; display:none;">确认删除</button>

  <h3>导出结果</h3>
  <textarea id="result-output" readonly></textarea>

  <h3>删除记录（最近20条）</h3>
  <div id="record-list"></div>

<script>
// ====== 默认库存，请替换为你的完整数据 ======
const defaultInventory = [
  {order:'330838563610',amount:4100},
  {order:'33083858554',amount:4100},
  {order:'33323525754',amount:3480},
  {order:'32204999226',amount:3320},
  {order:'32205436090',amount:3320},
  // …你的完整数据…
];

// ====== 持久化加载 ======
let inventory = JSON.parse(localStorage.getItem('invoiceInventory')) || defaultInventory.slice();
let deleteRecords = JSON.parse(localStorage.getItem('deleteRecords')) || [];

// ====== 存储 ======
function saveInventory(){ localStorage.setItem('invoiceInventory', JSON.stringify(inventory)); }
function saveDeleteRecords(){ localStorage.setItem('deleteRecords', JSON.stringify(deleteRecords)); }

// ====== 抬头历史 ======
function loadHeaderHistory(){ return JSON.parse(localStorage.getItem('headerHistory')||'[]'); }
function saveHeaderHistory(h){ if(!h) return; let hist=loadHeaderHistory().filter(x=>x!==h); hist.unshift(h); if(hist.length>20) hist.pop(); localStorage.setItem('headerHistory', JSON.stringify(hist)); }
function renderHeaderHistory(){
  const div=document.getElementById('header-history'); div.innerHTML='';
  loadHeaderHistory().forEach(h=>{
    const b=document.createElement('button');
    b.textContent=h;
    b.onclick=()=>document.getElementById('company-header').value=h;
    div.appendChild(b);
  });
}

// ====== 渲染删除记录 ======
function renderDeleteRecords(){
  const c=document.getElementById('record-list'); c.innerHTML='';
  deleteRecords.forEach((batch,i)=>{
    const dv=document.createElement('div'); dv.className='record-item';
    let html=`批次 ${i+1}，共 ${batch.length} 张发票<br>`;
    batch.forEach((inv,j)=>{
      html+=`发票${j+1}：${formatAmt(inv.sum)}${inv.orders.length>1?'（相关订单合并）':''}<br>`;
      inv.orders.forEach(o=>html+=`&nbsp;&nbsp;订单号：${o.order}，金额：${formatAmt(o.amount)}<br>`);
    });
    dv.innerHTML=html;
    const btn=document.createElement('button');
    btn.textContent='恢复';
    btn.onclick=()=>{
      const rec=deleteRecords.splice(i,1)[0];
      rec.forEach(inv=>inv.orders.forEach(o=>inventory.push(o)));
      saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    };
    dv.appendChild(btn);
    c.appendChild(dv);
  });
}

// ====== 格式化金额 ======
function formatAmt(x){
  let s = Number(x).toString();
  if(s.indexOf('.')>0) s = parseFloat(x.toFixed(2)).toString();
  return s + '元';
}

// ====== 渲染结果 ======
function renderResult(list, header){
  const lines=[];
  list.forEach((inv,i)=>{
    lines.push(`发票${i+1}：${formatAmt(inv.sum)}${inv.orders.length>1?'（相关订单合并）':''}`);
    inv.orders.forEach(o=>lines.push(`订单号：${o.order}，金额：${formatAmt(o.amount)}`));
    lines.push('');
  });
  if(header){ lines.push(header,''); }
  lines.push('不需要备注','568881753@qq.com');
  document.getElementById('result-output').value=lines.join('\n');
}

// ====== 子集求和缓存 ======
const subsetCache = new Map();
function subsetMinOrders(target, orders) {
  const key = target + '|' + orders.map(o=>o.amount).sort((a,b)=>a-b).join(',');
  if (subsetCache.has(key)) return subsetCache.get(key);

  const dp = Array(target+1).fill(null);
  dp[0] = { count:0, picks:[] };
  orders.forEach((o,idx)=>{
    for(let s=target; s>=o.amount; s--){
      const prev=dp[s-o.amount];
      if(prev && (!dp[s] || prev.count+1<dp[s].count)){
        dp[s] = { count:prev.count+1, picks: prev.picks.concat(idx) };
      }
    }
  });

  const res = dp[target] || null;
  subsetCache.set(key,res);
  return res;
}

// ====== 核心组合逻辑 ======
function fewInvoices(target, minS, maxS, maxSame, invoiceCount) {
  // 筛选可用订单
  const usable = inventory
    .filter(o=>o.amount>=minS && o.amount<=maxS)
    .filter(o=>isFinite(maxSame)? inventory.filter(x=>x.amount===o.amount).length<=maxSame : true);
  if(!usable.length) return null;

  // 如果只要 1 张发票，走子集求和
  if(invoiceCount===1){
    const rec = subsetMinOrders(target, usable);
    if(!rec) return null;
    const pick = rec.picks.map(i=>usable[i]);
    return [{ orders: pick, sum: target }];
  }

  // 否则从 1 张开始往上找，遇到可行即返回
  const maxInv = invoiceCount || usable.length;
  for(let invCnt=1; invCnt<=maxInv; invCnt++){
    // dp[s][k]: 凑到 s 用 k 张发票时的最少订单数
    const dp = Array(target+1).fill(0).map(()=>Array(invCnt+1).fill(null));
    dp[0][0] = { count:0, picks:[] };

    for(let idx=0; idx<usable.length; idx++){
      const amt=usable[idx].amount;
      for(let s=target; s>=amt; s--){
        for(let k=invCnt; k>=1; k--){
          const prev=dp[s-amt][k-1];
          if(prev){
            const c=prev.count+1;
            const exist=dp[s][k];
            if(!exist || c<exist.count){
              dp[s][k] = { count:c, picks: prev.picks.concat(idx) };
            }
          }
        }
      }
    }

    const rec = dp[target][invCnt];
    if(rec){
      // rec.picks 中每个 idx 对应一个【整张单一订单】发票
      // 若想后续扩展“每张发票可合并多笔”，可仿照上面 invoiceCount===1 的模式
      const invoices = rec.picks.map(i=>({
        orders: [ usable[i] ],
        sum: usable[i].amount
      }));
      return invoices;
    }
  }
  return null;
}

// ====== 事件绑定 ======
let lastInv=null;
document.addEventListener('DOMContentLoaded',()=>{
  renderHeaderHistory();
  renderDeleteRecords();

  document.getElementById('combine-btn').onclick=()=>{
    const tgt=parseFloat(document.getElementById('target-input').value);
    if(!tgt) return alert('请输入目标金额');
    const minS=parseFloat(document.getElementById('min-single').value)||0;
    const maxS=parseFloat(document.getElementById('max-single').value)||tgt;
    if(minS>maxS) return alert('下限不可大于上限');
    const msc=parseInt(document.getElementById('max-same-count').value)||Infinity;
    const invCntStr=document.getElementById('invoice-count').value.trim();
    const invCnt=invCntStr?parseInt(invCntStr):null;
    const header=document.getElementById('company-header').value.trim();

    saveHeaderHistory(header); renderHeaderHistory();

    const invs=fewInvoices(tgt,minS,maxS,msc,invCnt);
    if(!invs) return alert('无法组合出满足条件的金额');
    lastInv=invs; renderResult(invs,header);
    document.getElementById('confirm-delete-btn').style.display='inline-block';
  };

  document.getElementById('confirm-delete-btn').onclick=()=>{
    if(!lastInv) return;
    deleteRecords.unshift(lastInv);
    if(deleteRecords.length>20) deleteRecords.pop();
    lastInv.forEach(inv=>inv.orders.forEach(o=>{
      const i=inventory.findIndex(x=>x.order===o.order&&x.amount===o.amount);
      if(i>-1) inventory.splice(i,1);
    }));
    saveDeleteRecords(); saveInventory(); renderDeleteRecords();
    document.getElementById('confirm-delete-btn').style.display='none';
  };

  document.getElementById('copy-btn').onclick=()=>{
    navigator.clipboard.writeText(document.getElementById('result-output').value);
  };
});
</script>
</body>
</html>
